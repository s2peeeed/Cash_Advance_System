;/*FB_PKG_DELIM*/

__d("EBParseUploadSerializationPayload",["EBLogger","MAWEBFrontendQPLLogger","WAErrorMessage","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["EB upload "," serializer error: "," in ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["parseUploadSerializationResponse: ",""]);i=function(){return a};return a}var j=d("EBLogger").EBLogger.tags(["parseUploadSerializationResponse"]);function a(a){try{a=JSON.parse(a);return d("WAResultOrError").makeResult(a)}catch(b){a=d("WAErrorMessage").maybeGetMessageFromError(b);j.MUSTFIX(i(),a);return d("WAResultOrError").makeError("parse_exception")}}function b(a,b,c,e){var f=[],g=[];a.forEach(function(a){var d=a.error_code+": "+a.error_message;j.MUSTFIX(h(),b,d,c);f.push(a.error_code);g.push(a.error_message)});if(e!=null){d("MAWEBFrontendQPLLogger").addPointEBUploadTracking(e,b+"_upload_task_serialization_failure",{int_array:(a={},a[b+"_serialization_error_codes"]=f,a),string_array:(e={},e[b+"_serialization_errors"]=g,e)})}}g.parseUploadSerializationResponse=a;g.logUploadSerializationErrors=b}),98);
__d("EBUploadMessagesFromWorkerMutation_facebookRelayOperation",[],(function(a,b,c,d,e,f){e.exports="9723960407697513"}),null);
__d("EBUploadMessagesFromWorkerMutation.graphql",["EBUploadMessagesFromWorkerMutation_facebookRelayOperation"],(function(a,b,c,d,e,f){"use strict";a=function(){var a=[{defaultValue:null,kind:"LocalArgument",name:"input"}],c=[{alias:null,args:[{kind:"Variable",name:"data",variableName:"input"}],concreteType:"XFBTUploadMessageGQLResponse",kind:"LinkedField",name:"xfb_upload_encrypted_msg_to_backup",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"device_epoch_status",storageKey:null},{alias:null,args:null,concreteType:"XFBTUploadMessageHandlerResponse",kind:"LinkedField",name:"backup_write_result_response",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"is_success",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"delete_mailbox",storageKey:null},{alias:null,args:null,concreteType:"XFBTProtobufParams",kind:"LinkedField",name:"protobuf_params",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"delete_on_success",storageKey:null}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"exception_string",storageKey:null}],storageKey:null}];return{fragment:{argumentDefinitions:a,kind:"Fragment",metadata:null,name:"EBUploadMessagesFromWorkerMutation",selections:c,type:"Mutation",abstractKey:null},kind:"Request",operation:{argumentDefinitions:a,kind:"Operation",name:"EBUploadMessagesFromWorkerMutation",selections:c},params:{id:b("EBUploadMessagesFromWorkerMutation_facebookRelayOperation"),metadata:{},name:"EBUploadMessagesFromWorkerMutation",operationKind:"mutation",text:null}}}();e.exports=a}),null);
__d("LSWriteSupplementalMessage",["LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(b){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][writeSupplementalMessage] Beginning execution."),d[1]=c.i64.of_float(Date.now()),c.filter(c.db.table(302).fetch(),function(b){return b.threadId===a[1]&&b.toplevelOfflineThreadingId===a[2]&&b.supplementalKey===a[3]}).next().then(function(a,b){var c=a.done;a=a.value;return c?d[2]=void 0:(b=a.item,d[2]=b.messageTimestampMs)})},function(b){return c.i64.neq(d[2],void 0)?c.sequence([function(b){return c.i64.gt(d[2],a[5])?c.resolve(d[11]=!1):c.sequence([function(b){return c.forEach(c.filter(c.db.table(302).fetch(),function(b){return b.threadId===a[1]&&b.toplevelOfflineThreadingId===a[2]&&b.supplementalKey===a[3]}),function(a){return a["delete"]()})},function(b){return c.db.table(302).add({pk:void 0,messagePayload:a[0],threadId:a[1],toplevelOfflineThreadingId:a[2],supplementalKey:a[3],offlineThreadingId:a[4],messageTimestampMs:a[5]})},function(a){return d[11]=!0}])},function(a){return d[4]=d[11]}]):c.sequence([function(b){return c.forEach(c.filter(c.db.table(302).fetch(),function(b){return b.threadId===a[1]&&b.toplevelOfflineThreadingId===a[2]&&b.supplementalKey===a[3]}),function(a){return a["delete"]()})},function(b){return c.db.table(302).add({pk:void 0,messagePayload:a[0],threadId:a[1],toplevelOfflineThreadingId:a[2],supplementalKey:a[3],offlineThreadingId:a[4],messageTimestampMs:a[5]})},function(a){return d[4]=!0}])},function(a){return d[5]=c.i64.of_float(Date.now()),d[6]=c.i64.random(),d[8]="Finishing execution. Execution time: ",d[9]=c.i64.to_string(c.i64.sub(d[5],d[0])),d[10]=" ms",d[7]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][writeSupplementalMessage] ",d[7],d[8],d[7],d[9],d[7],d[10]].join("")),c.i64.eq(c.i64.mod_(d[6],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[11]=",",d[12]=c.createArray(),void 0!==void 0?d[13]=(d[12].push(void 0),d[12]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"writeSupplementalMessage",[d[8],d[11],d[9],d[11],d[10]].join(""),d[12],c.i64.cast([0,4]))):c.resolve()},function(a){return e[0]=d[4]}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSMPSWriteSupplementalMessageStoredProcedure";a.__tables__=["local_message_persistence_store_supplemental"];e.exports=a}),null);
__d("LSWriteSupplementalMessageStoredProcedure",["LSSynchronousPromise","LSWriteSupplementalMessage","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSWriteSupplementalMessage"),e.messagePayload,e.threadId,e.toplevelOfflineThreadingId,e.supplementalKey,e.offlineThreadingId,e.messageTimestampMs);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("LSWriteTopLevelMessage",["LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(b){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][writeTopLevelMessage] Beginning execution."),d[1]=c.i64.of_float(Date.now()),c.filter(c.db.table(301).fetch(),function(b){return b.threadId===a[1]&&b.offlineThreadingId===a[2]}).next().then(function(a,b){var c=a.done;a=a.value;return c?d[2]=void 0:(b=a.item,d[2]=b.messageTimestampMs)})},function(b){return c.i64.neq(d[2],void 0)?c.sequence([function(b){return c.i64.gt(d[2],a[3])?c.resolve(d[11]=!1):c.sequence([function(b){return c.filter(c.db.table(303).fetch(),function(b){return b.threadId===a[1]&&b.offlineThreadingId===a[2]}).next().then(function(a,b){b=a.done;a=a.value;return b?d[12]=!1:(a.item,d[12]=!0)})},function(b){return d[12]?c.sequence([function(b){return c.forEach(c.filter(c.db.table(303).fetch(),function(b){return b.threadId===a[1]&&b.offlineThreadingId===a[2]}),function(b){var c=b.update;b.item;return c({deletedMessagePayload:a[0],isLocalOnlyMessage:a[4],messageTimestampMs:a[3]})})},function(b){return c.forEach(c.filter(c.db.table(301).fetch(),function(b){return b.threadId===a[1]&&b.offlineThreadingId===a[2]&&c.i64.eq(b.messageTimestampMs,c.i64.cast([-1,4294967295]))}),function(b){var c=b.update;b.item;return c({messageTimestampMs:a[3]})})},function(a){return d[14]=!1}]):c.sequence([function(b){return c.forEach(c.filter(c.db.table(301).fetch(),function(b){return b.threadId===a[1]&&b.offlineThreadingId===a[2]}),function(a){return a["delete"]()})},function(b){return c.db.table(301).add({pk:void 0,messagePayload:a[0],threadId:a[1],offlineThreadingId:a[2],messageTimestampMs:a[3],isLocalOnlyMessage:a[4],extraData:a[5]})},function(a){return d[14]=!0}])},function(a){return d[11]=d[14]}])},function(a){return d[4]=d[11]}]):c.sequence([function(b){return c.filter(c.db.table(303).fetch(),function(b){return b.threadId===a[1]&&b.offlineThreadingId===a[2]}).next().then(function(a,b){b=a.done;a=a.value;return b?d[11]=!1:(a.item,d[11]=!0)})},function(b){return d[11]?c.sequence([function(b){return c.forEach(c.filter(c.db.table(303).fetch(),function(b){return b.threadId===a[1]&&b.offlineThreadingId===a[2]}),function(b){var c=b.update;b.item;return c({deletedMessagePayload:a[0],isLocalOnlyMessage:a[4],messageTimestampMs:a[3]})})},function(b){return c.forEach(c.filter(c.db.table(301).fetch(),function(b){return b.threadId===a[1]&&b.offlineThreadingId===a[2]&&c.i64.eq(b.messageTimestampMs,c.i64.cast([-1,4294967295]))}),function(b){var c=b.update;b.item;return c({messageTimestampMs:a[3]})})},function(a){return d[13]=!1}]):c.sequence([function(b){return c.forEach(c.filter(c.db.table(301).fetch(),function(b){return b.threadId===a[1]&&b.offlineThreadingId===a[2]}),function(a){return a["delete"]()})},function(b){return c.db.table(301).add({pk:void 0,messagePayload:a[0],threadId:a[1],offlineThreadingId:a[2],messageTimestampMs:a[3],isLocalOnlyMessage:a[4],extraData:a[5]})},function(a){return d[13]=!0}])},function(a){return d[4]=d[13]}])},function(a){return d[5]=c.i64.of_float(Date.now()),d[6]=c.i64.random(),d[8]="Finishing execution. Execution time: ",d[9]=c.i64.to_string(c.i64.sub(d[5],d[0])),d[10]=" ms",d[7]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][writeTopLevelMessage] ",d[7],d[8],d[7],d[9],d[7],d[10]].join("")),c.i64.eq(c.i64.mod_(d[6],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[11]=",",d[12]=c.createArray(),void 0!==void 0?d[13]=(d[12].push(void 0),d[12]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"writeTopLevelMessage",[d[8],d[11],d[9],d[11],d[10]].join(""),d[12],c.i64.cast([0,4]))):c.resolve()},function(a){return e[0]=d[4]}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSMPSWriteTopLevelMessageStoredProcedure";a.__tables__=["local_message_persistence_store","local_message_persistence_store_deleted_messages"];e.exports=a}),null);
__d("LSWriteTopLevelMessageStoredProcedure",["LSSynchronousPromise","LSWriteTopLevelMessage","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSWriteTopLevelMessage"),e.messagePayload,e.threadId,e.offlineThreadingId,e.messageTimestampMs,e.isLocalOnlyMessage,e.extraData);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("MessageBackupTagsDelimiter",[],(function(a,b,c,d,e,f){"use strict";a=":";f.INSTAMADILLO_TAG_DELIMITER=a}),66);
__d("EncryptedBackupsWriteToMPSTables",["EncryptedBackupsUploadEntity","FBLogger","I64","IGDWEBUploadMessageUtils","LSFactory","LSWriteSupplementalMessageStoredProcedure","LSWriteTopLevelMessageStoredProcedure","MessageBackupTagsDelimiter","WAErrorMessage","WAGetSafeQPLError","WAResultOrError","gkx","promiseDone","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i=c("requireDeferred")("ReverbWriteFailureFalcoEvent").__setRef("EncryptedBackupsWriteToMPSTables"),j=c("requireDeferred")("ReverbWriteSuccessFalcoEvent").__setRef("EncryptedBackupsWriteToMPSTables"),k=c("gkx")("8488");function l(a,b,d,e,f,g){e?c("promiseDone")(j.load(),function(c){return c.log(function(){return{backup_action:d,backup_protocol:f,labyrinth_version:0,message_id:a,thread_id:b}})}):c("promiseDone")(i.load(),function(c){return c.log(function(){return{backup_action:d,backup_protocol:f,failure_reason:g,labyrinth_version:0,message_id:a,thread_id:b}})})}async function a(a,b,e,f,g){var i=b.backupActionType,j=b.instamadilloItemId,m=b.msgId,n=b.originalMsgProtocolId,o=b.protobuf,p=b.serverTs,q=b.sortOrderMs;b=b.supplementalKey;g==null?void 0:g.addPoint("mps_tables_write_start");m=m.externalId;n=n==null?void 0:n.externalId;j=j!=null?j:q;if(j==null){g==null?void 0:g.addPoint("mps_tables_write_missing_protobuf_ts");return d("WAResultOrError").makeError("protobufTimestampMs is null when writing to MPS tables")}q=(h||(h=d("I64"))).of_float(j);j=!1;var r=k?"protobuf_only":"dual_upload";f&&(r="open_eb_ttlc");switch(i){case 1:g==null?void 0:g.addPoint("mps_top_level_write_start");try{f=await c("LSWriteTopLevelMessageStoredProcedure")(c("LSFactory")(a),{isLocalOnlyMessage:!1,messagePayload:d("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(o),messageTimestampMs:q,offlineThreadingId:m,threadId:e});i=f[0];i&&(j=!0);l(m,e,"upsert_top_level",i,r);g==null?void 0:g.addPoint("mps_top_level_write",{bool:{mps_top_level_write_succesful:i}})}catch(a){l(m,e,"upsert_top_level",!1,r,d("WAErrorMessage").maybeGetMessageFromError(a)),g==null?void 0:g.addPoint("mps_top_level_write_error",{string:{mps_top_level_write_error:d("WAGetSafeQPLError").getSafeQPLErrorMessage(a)}})}break;case 2:g==null?void 0:g.addPoint("mps_supplemental_write_start");if(n==null||b==null)l(m,e,"upsert_supplemental",!1,r),c("FBLogger")("labyrinth_web").warn("Missing toplevelOfflineThreadingId or supplementalKey when writing to MPS tables");else try{f=await c("LSWriteSupplementalMessageStoredProcedure")(c("LSFactory")(a),{messagePayload:d("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(o),messageTimestampMs:q,offlineThreadingId:m,supplementalKey:b,threadId:e,toplevelOfflineThreadingId:n});i=f[0];i&&(j=!0);l(m,e,"upsert_supplemental",i,r);g==null?void 0:g.addPoint("mps_supplemental_write",{bool:{mps_supplemental_write_successful:i}})}catch(a){l(m,e,"upsert_supplemental",!1,r,d("WAErrorMessage").maybeGetMessageFromError(a)),g==null?void 0:g.addPoint("mps_supplemental_write_error",{string:{mps_supplemental_write_error:d("WAGetSafeQPLError").getSafeQPLErrorMessage(a)}})}break;case 4:g==null?void 0:g.addPoint("mps_delete_top_level_with_placeholder_write_start");if(n==null)break;try{q=await c("LSWriteTopLevelMessageStoredProcedure")(c("LSFactory")(a),{isLocalOnlyMessage:!1,messagePayload:d("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(o),messageTimestampMs:(h||(h=d("I64"))).of_float(d("IGDWEBUploadMessageUtils").generateProtobufServerTs(n,p)),offlineThreadingId:m,threadId:e});b=q[0];b&&(j=!0);l(n,e,"delete_top_level",b,r);g==null?void 0:g.addPoint("mps_delete_top_level_with_placeholder_write",{bool:{mps_delete_top_level_with_placeholder_write_successful:b}})}catch(a){l(n,e,"delete_top_level_with_placeholder",!1,r,d("WAErrorMessage").maybeGetMessageFromError(a)),g==null?void 0:g.addPoint("mps_delete_top_level_with_placeholder_write_error",{string:{mps_delete_top_level_with_placeholder_write_error:d("WAGetSafeQPLError").getSafeQPLErrorMessage(a)}})}break;case 3:j=!0;n!=null&&l(n,e,"delete_top_level",!1,r);break;default:g==null?void 0:g.addPoint("mps_write_unsupported_backup_action_type"),c("FBLogger")("labyrinth_web").warn("Unsupported backupActionType when writing to MPS tables")}if(j){g==null?void 0:g.addPoint("mps_write_successful");return d("WAResultOrError").makeResult(j)}else{g==null?void 0:g.addPoint("mps_write_unsuccessful");return d("WAResultOrError").makeError("Unsuccessful writing to MPS tables")}}async function b(a,b,c){var e=b.msgId,f=b.sortOrderMs;b=b.tags;b!=null&&b.length!==0&&f!=null&&await a.local_message_persistence_store_tag_index.put({localMessagePersistenceStoreKey:(h||(h=d("I64"))).of_string(e.externalId),messageTimestampMs:h.of_float(f),offlineThreadingId:e.externalId,tag:b.join(d("MessageBackupTagsDelimiter").INSTAMADILLO_TAG_DELIMITER),threadId:c})}g.writeToMPSTables=a;g.writeTagsToMPSTables=b}),98);
__d("LSHandleBackupWriteCompletion",["EBEnableUnifiedAttachment","LSVec","MAWEBFrontendQPLLogger","cr:847"],(function(a,b,c,d,e,f,g){"use strict";async function a(a,e,f,g){if(g!=null){e=c("LSVec").toArray(g);d("EBEnableUnifiedAttachment").getEbEnableUnifiedAttachment()&&e.forEach(function(a){return d("MAWEBFrontendQPLLogger").endFlowUploadAttachmentBackup(a,f,"unified")})}if(b("cr:847")!=null){e=g!=null?c("LSVec").toArray(g):[];e.length>0&&await b("cr:847")(a,e)}return Promise.resolve()}g.call=a}),98);
__d("LSHandleBackupWriteCompletion.nop",["LSHandleBackupWriteCompletion"],(function(a,b,c,d,e,f,g){"use strict";a=function(a,b,c,e){return d("LSHandleBackupWriteCompletion").call(a,b,c,e)};a.__nop_name__="LSHandleBackupWriteCompletion";g["default"]=a}),98);
__d("LSMarkBackupAsCompleted.nop",["Promise"],(function(a,b,c,d,e,f){"use strict";var g;a=function(a,c,d,e,f,h,i){return(g||(g=b("Promise"))).resolve()};a.__nop_name__="LSMarkBackupAsCompleted";f["default"]=a}),66);
__d("LSHandleProtobufWriteResult",["LSArrayGetObjectAt","LSMarkBackupAsCompleted.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return a[3]?d[0]=!1:d[0]=!0,d[0]?c.resolve():(d[1]=a[3].get("delete_on_success"),d[1]&&a[0]&&!a[1]?(a[2]?d[2]=!1:d[2]=!0,d[2]?c.resolve():c.sequence([function(e){return d[3]=c.i64.of_float(Date.now()),d[4]=c.i64.of_int32(a[2].length),c.i64.gt(d[4],c.i64.cast([0,0]))?c.loopAsync(d[4],function(e){return d[7]=e,c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[2],d[7]).then(function(a){return a=a,d[8]=a[0],d[9]=a[1],a})},function(a){return c.filter(c.db.table(305).fetch(),function(a){return c.i64.eq(a.pendingBackupTaskId,d[8])}).next().then(function(a,d){var e=a.done;a=a.value;return e?0:(d=a.item,c.nativeOperation(b("LSMarkBackupAsCompleted.nop"),d.actThreadId,d.toplevelOfflineThreadingId,d.supplementalKey,d.messageTimestampMs,d.backupAction))})}])}):c.resolve()},function(e){return d[5]=c.i64.of_int32(a[2].length),c.i64.gt(d[5],c.i64.cast([0,0]))?c.loopAsync(d[5],function(e){return d[7]=e,c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[2],d[7]).then(function(a){return a=a,d[8]=a[0],d[9]=a[1],a})},function(a){return c.filter(c.db.table(305).fetch(),function(a){return c.i64.eq(a.pendingBackupTaskId,d[8])}).next().then(function(a,b){var e=a.done;a=a.value;return e?0:(b=a.item,d[12]=b.actThreadId,d[13]=b.toplevelOfflineThreadingId,d[11]=b.supplementalKey,d[14]=b.messageTimestampMs,d[11]!==void 0?c.forEach(c.filter(c.db.table(302).fetch(),function(a){return a.threadId===d[12]&&a.toplevelOfflineThreadingId===d[13]&&a.supplementalKey===d[11]&&c.i64.le(a.messageTimestampMs,d[14])}),function(a){return a["delete"]()}):c.forEach(c.filter(c.db.table(301).fetch(),function(a){return a.threadId===d[12]&&a.offlineThreadingId===d[13]&&c.i64.le(a.messageTimestampMs,d[14])}),function(a){return a["delete"]()}))})}])}):c.resolve()},function(e){return d[6]=c.i64.of_int32(a[2].length),c.i64.gt(d[6],c.i64.cast([0,0]))?c.loopAsync(d[6],function(e){return d[7]=e,c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[2],d[7]).then(function(a){return a=a,d[8]=a[0],d[9]=a[1],a})},function(a){return c.filter(c.db.table(305).fetch(),function(a){return c.i64.eq(a.pendingBackupTaskId,d[8])}).next().then(function(a,b){var d=a.done;a=a.value;return d?0:(b=a.item,c.forEach(c.db.table(304).fetch([[[b.toplevelOfflineThreadingId,b.actThreadId]],"offlineThreadingId"]),function(a){return a["delete"]()}))})}])}):c.resolve()}])):c.resolve())},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsHandleProtobufWriteResultStoredProcedure";a.__tables__=["pending_protobuf_backups_context","local_message_persistence_store_supplemental","local_message_persistence_store","local_message_persistence_store_tag_index"];e.exports=a}),null);
__d("LSHandleBackupWriteResultV2",["LSArrayGetObjectAt","LSDeleteBackupOnClient","LSHandleBackupWriteCompletion.nop","LSHandleProtobufWriteResult","LSLogMEBUploadSuccessEvent.nop","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsHandleBackupWriteResultV2StoredProcedure] Beginning execution."),d[1]=c.createArray(),d[2]=c.createArray(),a[3]?d[3]=!1:d[3]=!0,d[3]?c.resolve():(d[12]=c.i64.of_int32(a[3].length),c.i64.gt(d[12],c.i64.cast([0,0]))?c.loopAsync(d[12],function(e){return d[13]=e,c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[3],d[13]).then(function(a){return a=a,d[14]=a[0],d[15]=a[1],a})},function(e){return c.db.table(177).fetch([[[d[14]]],"fk_pending_tasks"]).next().then(function(e,f){var g=e.done;e=e.value;return g?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsHandleBackupWriteResultV2StoredProcedure] Pending backup task id not found!"),d[18]="Pending backup task id not found!",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsHandleBackupWriteResultV2StoredProcedure] ","",d[18]].join("")),d[17]=c.createArray(),void 0!==void 0?d[19]=(d[17].push(void 0),d[17]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsHandleBackupWriteResultV2StoredProcedure",d[18],d[17],c.i64.cast([0,3]))):(f=e.item,c.sequence([function(d){return c.i64.eq(f.contentType,c.i64.cast([0,1]))?c.nativeOperation(b("LSLogMEBUploadSuccessEvent.nop"),f.uniqueKey,f.lsTraceId,a[1]):c.resolve()},function(a){return d[17]=(d[2].push(f.persistentId),d[2])}]))})}])}):c.resolve())},function(d){return c.storedProcedure(b("LSHandleProtobufWriteResult"),a[1],a[2],a[3],a[4],!1)},function(e){return d[4]=c.i64.of_float(Date.now()),a[3]?d[5]=!1:d[5]=!0,d[5]?c.resolve():(d[12]=c.i64.of_int32(a[3].length),c.i64.gt(d[12],c.i64.cast([0,0]))?c.loopAsync(d[12],function(e){return d[13]=e,c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[3],d[13]).then(function(a){return a=a,d[14]=a[0],d[15]=a[1],a})},function(a){return c.forEach(c.filter(c.db.table(305).fetch(),function(a){return c.i64.eq(a.pendingBackupTaskId,d[14])}),function(a){return a["delete"]()})}])}):c.resolve())},function(e){return a[2]?c.sequence([function(e){return d[12]=c.i64.of_int32(a[0].length),c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[0],c.i64.cast([0,0])).then(function(a){return a=a,d[14]=a[0],d[15]=a[1],a})},function(a){return d[13]=d[14]}])},function(a){return c.storedProcedure(b("LSDeleteBackupOnClient"),void 0,void 0,!0,d[13],void 0,!0)}]):c.resolve()},function(e){return c.nativeOperation(b("LSHandleBackupWriteCompletion.nop"),a[1],a[0],d[2])},function(a){return d[6]=c.i64.of_float(Date.now()),d[7]=c.i64.random(),d[9]="Finishing execution. Execution time: ",d[10]=c.i64.to_string(c.i64.sub(d[6],d[0])),d[11]=" ms",d[8]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsHandleBackupWriteResultV2StoredProcedure] ",d[8],d[9],d[8],d[10],d[8],d[11]].join("")),c.i64.eq(c.i64.mod_(d[7],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[12]=",",d[13]=c.createArray(),void 0!==void 0?d[14]=(d[13].push(void 0),d[13]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsHandleBackupWriteResultV2StoredProcedure",[d[9],d[12],d[10],d[12],d[11]].join(""),d[13],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsHandleBackupWriteResultV2StoredProcedure";a.__tables__=["pending_backups_context_v2","pending_protobuf_backups_context"];e.exports=a}),null);
__d("LSHandleBackupWriteResultV2StoredProcedure",["LSHandleBackupWriteResultV2","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSHandleBackupWriteResultV2"),e.traceIds,e.isSuccess,e.deleteMailbox,e.taskIds,e.protobufParams);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("LSPrepareOpenEpochV2",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSIsEncryptionVersionSecure","LSIsMobileClient","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(a){return c.sequence([function(a){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure] Beginning execution."),c.filter(c.db.table(2).fetch(),function(a){return a.context==="50005"}).next().then(function(a,b){b=a.done;a=a.value;return b?d[1]=!1:(a.item,d[1]=!0)})},function(a){return c.filter(c.db.table(2).fetch(),function(a){return a.context==="320"}).next().then(function(a,b){b=a.done;a=a.value;return b?d[3]=!1:(a.item,d[3]=!0)})},function(a){return d[1]||d[3]?c.resolve((function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure] Skipping openEpoch start because there is already an openEpoch flow in progress."),d[5]=c.i64.cast([0,1]))):c.sequence([function(a){return c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,1441]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[18]=a[0],a})},function(a){return d[18]?d[19]=!0:d[19]=!1,d[19]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[21]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[21]].join("")),d[20]=c.createArray(),void 0!==void 0?d[22]=(d[20].push(void 0),d[20]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[21],d[20],c.i64.cast([0,3]))):c.resolve()}])},function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[18]=new c.Map(),d[18].set("error_msg","Expected a nonempty query result"),d[18].set("code",c.i64.cast([0,3])),d[18].set("src_line","MEBClientStateUtils.php:247 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[19]=c.createArray(),d[20]=(d[19].push(d[18]),d[19]),e=[void 0,d[19]],d[12]=e[0],d[13]=e[1],e):(b=a.item,d[18]=new c.Map(),d[18].set("backup_id",b.backupId),d[18].set("device_public_key_blob",b.devicePublicKeyBlob),d[18].set("device_private_key_blob",b.devicePrivateKeyBlob),d[18].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[18].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[18].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[18].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[18].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[18].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[18].set("orf_client_state_v2_blob",void 0),d[18].set("orf_v2_authority_level",void 0),d[18].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[18].set("device_id",b.deviceId),d[18].set("backup_tenancy",b.backupTenancy),d[18].set("encryption_version",b.encryptionVersion),d[18].set("revision_version",b.revisionVersion),d[18].set("initialize_restore_result",void 0),d[18].set("device_creation_timestamp_sec",void 0),d[18].set("authority_level",b.authorityLevel),e=[d[18],void 0],d[12]=e[0],d[13]=e[1],e)})},function(a){return d[15]=new c.Map(),d[15].set("value",d[12]),d[15].set("errors",d[13]),d[16]=d[15].get("value"),d[16]!==void 0?c.sequence([function(a){return d[18]=d[16].get("backup_id"),d[19]=d[16].get("device_public_key_blob"),d[20]=d[16].get("device_private_key_blob"),d[21]=d[16].get("epoch_storage_public_key_blob"),d[22]=d[16].get("epoch_storage_private_key_blob"),d[23]=d[16].get("epoch_auth_public_key_blob"),d[24]=d[16].get("epoch_auth_private_key_blob"),d[25]=d[16].get("mailbox_root_key_blob"),d[26]=d[16].get("ocmf_client_state_blob"),d[27]=d[16].get("orf_client_state_v2_blob"),d[28]=d[16].get("orf_v2_authority_level"),d[29]=d[16].get("oblivious_validation_token_blob"),d[30]=d[16].get("device_id"),d[31]=d[16].get("backup_tenancy"),d[32]=d[16].get("encryption_version"),d[33]=d[16].get("revision_version"),d[34]=d[16].get("initialize_restore_result"),d[35]=d[16].get("device_creation_timestamp_sec"),d[36]=d[16].get("authority_level"),c.i64.neq(d[30],void 0)?c.sequence([function(a){return d[38]=void 0,c.i64.neq(d[38],void 0)?c.resolve(d[39]=d[38]):c.sequence([function(a){return d[50]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[51]=a[0],a})},function(a){return d[51]?d[60]=(d[50].push(c.i64.cast([0,0])),d[50]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[52]=a[0],a})},function(a){return d[52]?d[60]=(d[50].push(c.i64.cast([0,2])),d[50]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[53]=a[0],a})},function(a){return d[53]?d[60]=(d[50].push(c.i64.cast([0,3])),d[50]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[54]=a[0],a})},function(a){return d[54]?d[60]=(d[50].push(c.i64.cast([0,4])),d[50]):0,d[55]=c.createArray(),d[56]=c.i64.of_int32(d[50].length),c.i64.gt(d[56],c.i64.cast([0,0]))?c.loopAsync(d[56],function(a){return d[60]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[50],d[60]).then(function(a){return a=a,d[61]=a[0],d[62]=a[1],a})},function(a){return d[63]=(d[55].push(d[61]),d[55])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[60]=c.createArray(),d[61]=c.i64.of_int32(d[55].length),c.i64.gt(d[61],c.i64.cast([0,0]))?c.loopAsync(d[61],function(a){return d[63]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[55],d[63]).then(function(a){return a=a,d[64]=a[0],d[65]=a[1],a})},function(a){return d[66]=(d[60].push(c.i64.to_string(d[64])),d[60])}])}):c.resolve()},function(a){return d[62]=d[60].join(","),d[57]=d[62]}])},function(a){return d[55].some(function(a){return c.i64.eq(d[32],a)})?d[58]=d[32]:d[58]=void 0,c.i64.neq(d[58],void 0)?d[59]=d[58]:d[59]=void 0,d[39]=d[59]}])},function(a){return c.i64.neq(d[39],void 0)?d[40]=d[39]:d[40]=c.i64.cast([0,0]),c.i64.neq(d[31],void 0)?d[41]=d[31]:d[41]=c.i64.cast([0,1]),c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2821]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[50]=a[0],a})},function(a){return d[50]?d[51]=!0:d[51]=!1,d[51]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[53]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[53]].join("")),d[52]=c.createArray(),void 0!==void 0?d[54]=(d[52].push(void 0),d[52]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[53],d[52],c.i64.cast([0,3]))):c.resolve()}])},function(a){return d[42]=c.createArray(),c.forEach(c.filter(c.db.table(169).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),function(a){a=a.item;return d[50]=(d[42].push(a.epochId),d[42])})},function(a){return d[48]="Queried locally available epochs. Count: ",d[43]=c.i64.of_int32(d[42].length),d[49]=c.i64.to_string(d[43]),d[44]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][MEBEpochClientUtils] ",d[44],d[48],d[44],d[49]].join("")),c.resolve()},function(a){return d[45]=new c.Map(),d[45].set("backup_id",d[18]),d[45].set("locally_available_epochs",d[42]),d[45].set("device_id",d[30]),d[45].set("trace_id",void 0),d[46]=c.toJSON(d[45]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"messenger_request_for_asssoc_devices",c.i64.cast([0,50005]),d[46],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[47]=a[0],a})},function(a){return c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,1442]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[50]=a[0],a})},function(a){return d[50]?d[51]=!0:d[51]=!1,d[51]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[53]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[53]].join("")),d[52]=c.createArray(),void 0!==void 0?d[54]=(d[52].push(void 0),d[52]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[53],d[52],c.i64.cast([0,3]))):c.resolve()}])},function(a){return d[37]=c.i64.cast([0,0])}]):c.sequence([function(a){return c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2822]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[39]=a[0],a})},function(a){return d[39]?d[40]=!0:d[40]=!1,d[40]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[42]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[42]].join("")),d[41]=c.createArray(),void 0!==void 0?d[43]=(d[41].push(void 0),d[41]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[42],d[41],c.i64.cast([0,3]))):c.resolve()}])},function(a){return d[38]="No backup found.",d[38]!==void 0?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure] ","",d[38]].join("")),d[39]=c.createArray(),void 0!==void 0?d[40]=(d[39].push(void 0),d[39]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure",d[38],d[39],c.i64.cast([0,3]))):c.resolve()},function(a){return d[37]=c.i64.cast([0,1])}])},function(a){return d[17]=d[37]}]):c.sequence([function(a){return d[18]=d[15].get("errors"),d[19]=d[15].get("errors"),c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2822]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[21]=a[0],a})},function(a){return d[21]?d[22]=!0:d[22]=!1,d[22]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[24]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[24]].join("")),d[23]=c.createArray(),void 0!==void 0?d[25]=(d[23].push(void 0),d[23]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[24],d[23],c.i64.cast([0,3]))):c.resolve()}])},function(a){return d[20]="No backup found.",d[20]!==void 0?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure] ","",d[20]].join("")),d[21]=c.createArray(),void 0!==void 0?d[22]=(d[21].push(void 0),d[21]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure",d[20],d[21],c.i64.cast([0,3]))):c.resolve()},function(a){return d[17]=c.i64.cast([0,1])}])},function(a){return d[5]=d[17]}])},function(a){return d[6]=c.i64.of_float(Date.now()),d[7]=c.i64.random(),d[9]="Finishing execution. Execution time: ",d[10]=c.i64.to_string(c.i64.sub(d[6],d[0])),d[11]=" ms",d[8]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure] ",d[8],d[9],d[8],d[10],d[8],d[11]].join("")),c.i64.eq(c.i64.mod_(d[7],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[12]=",",d[13]=c.createArray(),void 0!==void 0?d[14]=(d[13].push(void 0),d[13]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure",[d[9],d[12],d[10],d[12],d[11]].join(""),d[13],c.i64.cast([0,4]))):c.resolve()},function(a){return e[0]=d[5]}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure";a.__tables__=["pending_tasks","secure_encrypted_backups_client_state","secure_encrypted_backups_epochs"];e.exports=a}),null);
__d("LSPrepareOpenEpochV2StoredProcedure",["LSPrepareOpenEpochV2","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){e===void 0&&(e={});a=a.storedProcedure(c("LSPrepareOpenEpochV2"),e.backupId,e.traceId);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("LSSyncEpochs",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSIsEncryptionVersionSecure","LSIsMobileClient","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(a){return c.sequence([function(a){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsSyncEpochsStoredProcedure] Beginning execution."),c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,1436]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[13]=a[0],a})},function(a){return d[13]?d[14]=!0:d[14]=!1,d[14]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[16]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[16]].join("")),d[15]=c.createArray(),void 0!==void 0?d[17]=(d[15].push(void 0),d[15]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[16],d[15],c.i64.cast([0,3]))):c.resolve()}])},function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[13]=new c.Map(),d[13].set("error_msg","Expected a nonempty query result"),d[13].set("code",c.i64.cast([0,3])),d[13].set("src_line","MEBClientStateUtils.php:247 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[14]=c.createArray(),d[15]=(d[14].push(d[13]),d[14]),e=[void 0,d[14]],d[1]=e[0],d[2]=e[1],e):(b=a.item,d[13]=new c.Map(),d[13].set("backup_id",b.backupId),d[13].set("device_public_key_blob",b.devicePublicKeyBlob),d[13].set("device_private_key_blob",b.devicePrivateKeyBlob),d[13].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[13].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[13].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[13].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[13].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[13].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[13].set("orf_client_state_v2_blob",void 0),d[13].set("orf_v2_authority_level",void 0),d[13].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[13].set("device_id",b.deviceId),d[13].set("backup_tenancy",b.backupTenancy),d[13].set("encryption_version",b.encryptionVersion),d[13].set("revision_version",b.revisionVersion),d[13].set("initialize_restore_result",void 0),d[13].set("device_creation_timestamp_sec",void 0),d[13].set("authority_level",b.authorityLevel),e=[d[13],void 0],d[1]=e[0],d[2]=e[1],e)})},function(a){return d[4]=new c.Map(),d[4].set("value",d[1]),d[4].set("errors",d[2]),d[5]=d[4].get("value"),d[5]!==void 0?c.sequence([function(a){return d[13]=d[5].get("backup_id"),d[14]=d[5].get("device_public_key_blob"),d[15]=d[5].get("device_private_key_blob"),d[16]=d[5].get("epoch_storage_public_key_blob"),d[17]=d[5].get("epoch_storage_private_key_blob"),d[18]=d[5].get("epoch_auth_public_key_blob"),d[19]=d[5].get("epoch_auth_private_key_blob"),d[20]=d[5].get("mailbox_root_key_blob"),d[21]=d[5].get("ocmf_client_state_blob"),d[22]=d[5].get("orf_client_state_v2_blob"),d[23]=d[5].get("orf_v2_authority_level"),d[24]=d[5].get("oblivious_validation_token_blob"),d[25]=d[5].get("device_id"),d[26]=d[5].get("backup_tenancy"),d[27]=d[5].get("encryption_version"),d[28]=d[5].get("revision_version"),d[29]=d[5].get("initialize_restore_result"),d[30]=d[5].get("device_creation_timestamp_sec"),d[31]=d[5].get("authority_level"),c.i64.neq(d[25],void 0)?c.sequence([function(a){return d[33]=void 0,c.i64.neq(d[33],void 0)?c.resolve(d[34]=d[33]):c.sequence([function(a){return d[41]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[42]=a[0],a})},function(a){return d[42]?d[51]=(d[41].push(c.i64.cast([0,0])),d[41]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[43]=a[0],a})},function(a){return d[43]?d[51]=(d[41].push(c.i64.cast([0,2])),d[41]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[44]=a[0],a})},function(a){return d[44]?d[51]=(d[41].push(c.i64.cast([0,3])),d[41]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[45]=a[0],a})},function(a){return d[45]?d[51]=(d[41].push(c.i64.cast([0,4])),d[41]):0,d[46]=c.createArray(),d[47]=c.i64.of_int32(d[41].length),c.i64.gt(d[47],c.i64.cast([0,0]))?c.loopAsync(d[47],function(a){return d[51]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[41],d[51]).then(function(a){return a=a,d[52]=a[0],d[53]=a[1],a})},function(a){return d[54]=(d[46].push(d[52]),d[46])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[51]=c.createArray(),d[52]=c.i64.of_int32(d[46].length),c.i64.gt(d[52],c.i64.cast([0,0]))?c.loopAsync(d[52],function(a){return d[54]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[46],d[54]).then(function(a){return a=a,d[55]=a[0],d[56]=a[1],a})},function(a){return d[57]=(d[51].push(c.i64.to_string(d[55])),d[51])}])}):c.resolve()},function(a){return d[53]=d[51].join(","),d[48]=d[53]}])},function(a){return d[46].some(function(a){return c.i64.eq(d[27],a)})?d[49]=d[27]:d[49]=void 0,c.i64.neq(d[49],void 0)?d[50]=d[49]:d[50]=void 0,d[34]=d[50]}])},function(a){return c.i64.neq(d[34],void 0)?d[35]=d[34]:d[35]=c.i64.cast([0,0]),c.i64.neq(d[26],void 0)?d[36]=d[26]:d[36]=c.i64.cast([0,1]),c.filter(c.db.table(2).fetch(),function(a){return a.context==="50013"}).next().then(function(a,b){b=a.done;a=a.value;return b?d[37]=!1:(a.item,d[37]=!0)})},function(a){return c.filter(c.db.table(2).fetch(),function(a){return a.context==="50025"}).next().then(function(a,b){b=a.done;a=a.value;return b?d[39]=!1:(a.item,d[39]=!0)})},function(a){return d[37]||d[39]?(d[41]="Another sync job is already in progress. Terminating this.",d[41]!==void 0?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsSyncEpochsStoredProcedure] ","",d[41]].join("")),d[42]=c.createArray(),void 0!==void 0?d[43]=(d[42].push(void 0),d[42]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsSyncEpochsStoredProcedure",d[41],d[42],c.i64.cast([0,3]))):c.resolve()):c.sequence([function(a){return c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2849]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[49]=a[0],a})},function(a){return d[49]?d[50]=!0:d[50]=!1,d[50]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[52]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[52]].join("")),d[51]=c.createArray(),void 0!==void 0?d[53]=(d[51].push(void 0),d[51]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[52],d[51],c.i64.cast([0,3]))):c.resolve()}])},function(a){return d[41]=c.createArray(),c.forEach(c.filter(c.db.table(169).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),function(a){a=a.item;return d[49]=(d[41].push(a.epochId),d[41])})},function(a){return d[47]="Queried locally available epochs. Count: ",d[42]=c.i64.of_int32(d[41].length),d[48]=c.i64.to_string(d[42]),d[43]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][MEBEpochClientUtils] ",d[43],d[47],d[43],d[48]].join("")),c.resolve()},function(a){return d[44]=new c.Map(),d[44].set("backup_id",d[13]),d[44].set("device_id",d[25]),d[44].set("locally_available_epochs",d[41]),d[44].set("trace_id",void 0),d[45]=c.toJSON(d[44]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"messenger_encrypted_backups",c.i64.cast([0,50025]),d[45],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[46]=a[0],a})}])},function(a){return d[32]=!0}]):c.sequence([function(a){return d[33]=["Failed to load client state: ","","NULL_DEVICE_ID"].join(""),d[33]!==void 0?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsSyncEpochsStoredProcedure] ","",d[33]].join("")),d[34]=c.createArray(),void 0!==void 0?d[35]=(d[34].push(void 0),d[34]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsSyncEpochsStoredProcedure",d[33],d[34],c.i64.cast([0,3]))):c.resolve()},function(a){return d[32]=!1}])},function(a){return d[6]=d[32]}]):c.sequence([function(a){return d[13]=d[4].get("errors"),d[14]=d[4].get("errors"),d[15]=["Failed to load client state: ","","BACKUP_NOT_FOUND"].join(""),d[15]!==void 0?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsSyncEpochsStoredProcedure] ","",d[15]].join("")),d[16]=c.createArray(),void 0!==void 0?d[17]=(d[16].push(void 0),d[16]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsSyncEpochsStoredProcedure",d[15],d[16],c.i64.cast([0,3]))):c.resolve()},function(a){return d[6]=!1}])},function(a){return d[7]=c.i64.of_float(Date.now()),d[8]=c.i64.random(),d[10]="Finishing execution. Execution time: ",d[11]=c.i64.to_string(c.i64.sub(d[7],d[0])),d[12]=" ms",d[9]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsSyncEpochsStoredProcedure] ",d[9],d[10],d[9],d[11],d[9],d[12]].join("")),c.i64.eq(c.i64.mod_(d[8],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[13]=",",d[14]=c.createArray(),void 0!==void 0?d[15]=(d[14].push(void 0),d[14]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsSyncEpochsStoredProcedure",[d[10],d[13],d[11],d[13],d[12]].join(""),d[14],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsSyncEpochsStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state","pending_tasks","secure_encrypted_backups_epochs"];e.exports=a}),null);
__d("LSSyncEpochsStoredProcedure",["LSSyncEpochs","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a){a=a.storedProcedure(c("LSSyncEpochs"));return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("MAWEBFalcoLoggerUtils",["requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h=(f=c("requireDeferred"))("EncryptedBackupTaskFailureFalcoEvent").__setRef("MAWEBFalcoLoggerUtils"),i=f("EncryptedBackupTaskIssuedFalcoEvent").__setRef("MAWEBFalcoLoggerUtils"),j=f("EncryptedBackupTaskSkippedFalcoEvent").__setRef("MAWEBFalcoLoggerUtils"),k=f("EncryptedBackupUploadSuccessFalcoEvent").__setRef("MAWEBFalcoLoggerUtils"),l={0:"unknown",1:"upsert_top_level",2:"upsert_supplemental",3:"delete_top_level",4:"delete_top_level_with_placeholder"};function a(a,b){m(a,b)}function b(a,b,c){m(a,b,c)}function d(a,b,c){m(a,b,void 0,c)}function m(a,b,c,d){c!=null?void h.onReady(function(d){d.log(function(){var d;return{backup_action:(d=l[(d=(d=a.protoMsg)==null?void 0:d.backupActionType)!=null?d:0])!=null?d:"unknown",backup_protocol:b,failure_reason:c,labyrinth_version:0,message_id:(d=(d=a.protoMsg)==null?void 0:(d=d.msgId)==null?void 0:d.externalId)!=null?d:a.messageId,thread_id:a.threadId,trace_id:a.traceId}})}):d!=null?void j.onReady(function(c){c.log(function(){var c;return{backup_action:(c=l[(c=(c=a.protoMsg)==null?void 0:c.backupActionType)!=null?c:0])!=null?c:"unknown",backup_protocol:b,labyrinth_version:0,message_id:(c=(c=a.protoMsg)==null?void 0:(c=c.msgId)==null?void 0:c.externalId)!=null?c:a.messageId,skipped_reason:d,thread_id:a.threadId,trace_id:a.traceId}})}):void i.onReady(function(c){c.log(function(){var c;return{backup_action:(c=l[(c=(c=a.protoMsg)==null?void 0:c.backupActionType)!=null?c:0])!=null?c:"unknown",backup_protocol:b,labyrinth_version:0,message_id:(c=(c=a.protoMsg)==null?void 0:(c=c.msgId)==null?void 0:c.externalId)!=null?c:a.messageId,thread_id:a.threadId,trace_id:a.traceId}})})}function e(a){void k.onReady(function(b){b.log(function(){var b;return{labyrinth_version:0,message_id:(b=(b=a.protoMsg)==null?void 0:(b=b.msgId)==null?void 0:b.externalId)!=null?b:a.messageId,thread_id:a.threadId,trace_id:a.traceId}})})}g.BackupActionMap=l;g.logEBFalcoTaskIssued=a;g.logEBFalcoTaskFailure=b;g.logEBFalcoTaskSkipped=d;g.logEBFalcoEncryptedBackupUploadSuccess=e}),98);
__d("LSBackupContentType",[],(function(a,b,c,d,e,f){a=Object.freeze({MESSAGE:1,THREAD:2});f["default"]=a}),66);
__d("LSEncryptedBackupsAttachmentErrorCode",[],(function(a,b,c,d,e,f){a=Object.freeze({NO_ERROR:0,UNKNOWN_ERROR:1,MEDIA_TYPE_MISSING:2,PRODUCT_TYPE_MISSING:3,SERIALIZATION_ERROR:21});f["default"]=a}),66);
__d("LSPendingBackupStatus",[],(function(a,b,c,d,e,f){a=Object.freeze({NEEDS_BACKUP:1,BACKUP_IN_PROGRESS:2,BLOCKED:3});f["default"]=a}),66);
__d("LSSerializeAttachmentBackupPayload",["LSArrayGetObjectAt","LSBase64Encode.nop","LSGetBlobFromString.nop","LSHmac_v2.nop","LSIsEncryptionVersionSecure","LSLogMebClientEvent.nop","LSOcmfClientMap.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][serializeAttachmentBackupPayload] Beginning execution."),d[1]=c.i64.of_float(Date.now()),d[2]=void 0,d[3]=c.i64.of_int32(a[0].length),c.i64.gt(d[3],c.i64.cast([0,0]))?c.loopAsync(d[3],function(e){return d[17]=e,c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[0],d[17]).then(function(a){return a=a,d[18]=a[0],d[19]=a[1],a})},function(a){return d[20]=d[18].get("attachment_trace_id"),d[2]=d[20]}])}):c.resolve()},function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[17]=new c.Map(),d[17].set("error_msg","Expected a nonempty query result"),d[17].set("code",c.i64.cast([0,3])),d[17].set("src_line","MEBClientStateUtils.php:247 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[18]=c.createArray(),d[19]=(d[18].push(d[17]),d[18]),e=[void 0,d[18]],d[4]=e[0],d[5]=e[1],e):(b=a.item,d[17]=new c.Map(),d[17].set("backup_id",b.backupId),d[17].set("device_public_key_blob",b.devicePublicKeyBlob),d[17].set("device_private_key_blob",b.devicePrivateKeyBlob),d[17].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[17].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[17].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[17].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[17].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[17].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[17].set("orf_client_state_v2_blob",void 0),d[17].set("orf_v2_authority_level",void 0),d[17].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[17].set("device_id",b.deviceId),d[17].set("backup_tenancy",b.backupTenancy),d[17].set("encryption_version",b.encryptionVersion),d[17].set("revision_version",b.revisionVersion),d[17].set("initialize_restore_result",void 0),d[17].set("device_creation_timestamp_sec",void 0),d[17].set("authority_level",b.authorityLevel),e=[d[17],void 0],d[4]=e[0],d[5]=e[1],e)})},function(e){return d[7]=new c.Map(),d[7].set("value",d[4]),d[7].set("errors",d[5]),d[8]=d[7].get("value"),d[8]!==void 0?c.sequence([function(e){return d[17]=d[8].get("backup_id"),d[18]=d[8].get("device_public_key_blob"),d[19]=d[8].get("device_private_key_blob"),d[20]=d[8].get("epoch_storage_public_key_blob"),d[21]=d[8].get("epoch_storage_private_key_blob"),d[22]=d[8].get("epoch_auth_public_key_blob"),d[23]=d[8].get("epoch_auth_private_key_blob"),d[24]=d[8].get("mailbox_root_key_blob"),d[25]=d[8].get("ocmf_client_state_blob"),d[26]=d[8].get("orf_client_state_v2_blob"),d[27]=d[8].get("orf_v2_authority_level"),d[28]=d[8].get("oblivious_validation_token_blob"),d[29]=d[8].get("device_id"),d[30]=d[8].get("backup_tenancy"),d[31]=d[8].get("encryption_version"),d[32]=d[8].get("revision_version"),d[33]=d[8].get("initialize_restore_result"),d[34]=d[8].get("device_creation_timestamp_sec"),d[35]=d[8].get("authority_level"),c.i64.neq(d[29],void 0)?c.sequence([function(a){return d[38]=void 0,c.i64.neq(d[38],void 0)?c.resolve(d[39]=d[38]):c.sequence([function(a){return d[44]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[45]=a[0],a})},function(a){return d[45]?d[54]=(d[44].push(c.i64.cast([0,0])),d[44]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[46]=a[0],a})},function(a){return d[46]?d[54]=(d[44].push(c.i64.cast([0,2])),d[44]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[47]=a[0],a})},function(a){return d[47]?d[54]=(d[44].push(c.i64.cast([0,3])),d[44]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[48]=a[0],a})},function(a){return d[48]?d[54]=(d[44].push(c.i64.cast([0,4])),d[44]):0,d[49]=c.createArray(),d[50]=c.i64.of_int32(d[44].length),c.i64.gt(d[50],c.i64.cast([0,0]))?c.loopAsync(d[50],function(a){return d[54]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[44],d[54]).then(function(a){return a=a,d[55]=a[0],d[56]=a[1],a})},function(a){return d[57]=(d[49].push(d[55]),d[49])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[54]=c.createArray(),d[55]=c.i64.of_int32(d[49].length),c.i64.gt(d[55],c.i64.cast([0,0]))?c.loopAsync(d[55],function(a){return d[57]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[49],d[57]).then(function(a){return a=a,d[58]=a[0],d[59]=a[1],a})},function(a){return d[60]=(d[54].push(c.i64.to_string(d[58])),d[54])}])}):c.resolve()},function(a){return d[56]=d[54].join(","),d[51]=d[56]}])},function(a){return d[49].some(function(a){return c.i64.eq(d[31],a)})?d[52]=d[31]:d[52]=void 0,c.i64.neq(d[52],void 0)?d[53]=d[52]:d[53]=void 0,d[39]=d[53]}])},function(e){return c.i64.neq(d[39],void 0)?d[40]=d[39]:d[40]=c.i64.cast([0,0]),c.i64.neq(d[30],void 0)?d[41]=d[30]:d[41]=c.i64.cast([0,1]),c.i64.eq(a[4],c.i64.cast([0,0]))?c.sequence([function(e){return d[44]=c.createArray(),d[45]=c.i64.of_int32(a[0].length),c.i64.gt(d[45],c.i64.cast([0,0]))?c.loopAsync(d[45],function(e){return d[61]=e,c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[0],d[61]).then(function(a){return a=a,d[62]=a[0],d[63]=a[1],a})},function(e){return d[64]=d[62].get("media_type"),d[65]=d[62].get("zippy_object_id"),d[84]=d[65],d[66]=d[62].get("attachment_trace_id"),d[67]=c.createArray(),d[85]=(d[67].push(c.i64.to_string(d[17])),d[67]),d[85]=(d[67].push(d[84]),d[67]),d[68]=c.toJSON(d[67]),d[69]=c.createArray(),d[85]=(d[69].push(a[1]),d[69]),d[85]=(d[69].push(d[84]),d[69]),d[70]=c.toJSON(d[69]),c.nativeOperation(b("LSGetBlobFromString.nop"),d[68]).then(function(a){return a=a,d[71]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF9rZXlfc2NvcGU="),d[71]).then(function(a){return a=a,d[72]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[25],d[72]).then(function(a){return a=a,d[73]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[73]).then(function(a){return a=a,d[74]=a[0],a})},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),d[70]).then(function(a){return a=a,d[75]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF90b2tlbl9zYWx0X3Njb3Bl"),d[75]).then(function(a){return a=a,d[76]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[25],d[76]).then(function(a){return a=a,d[77]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[77]).then(function(a){return a=a,d[78]=a[0],a})},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),d[68]).then(function(a){return a=a,d[79]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF9rZXlfc2FsdF9zY29wZQ=="),d[79]).then(function(a){return a=a,d[80]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[25],d[80]).then(function(a){return a=a,d[81]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[81]).then(function(a){return a=a,d[82]=a[0],a})},function(a){return d[83]=new c.Map(),d[83].set("attachment_index_key",d[74]==null?"":d[74]),d[83].set("media_type",d[64]),d[83].set("zippy_object_id",d[84]),d[83].set("attachment_trace_id",d[66]),d[83].set("salt_partial_access_token",d[78]==null?"":d[78]),d[83].set("salt_partial_attachment_index_key",d[82]==null?"":d[82]),d[85]=(d[44].push(d[83]),d[44])}])}):c.resolve()},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[1]).then(function(a){return a=a,d[46]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("bWVzc2FnZV9pZF9zY29wZQ=="),d[46]).then(function(a){return a=a,d[47]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[25],d[47]).then(function(a){return a=a,d[48]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[48]).then(function(a){return a=a,d[49]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[1]).then(function(a){return a=a,d[50]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF90b2tlbl9zYWx0X3Njb3Bl"),d[50]).then(function(a){return a=a,d[51]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[25],d[51]).then(function(a){return a=a,d[52]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[52]).then(function(a){return a=a,d[53]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[2]).then(function(a){return a=a,d[54]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("dGhyZWFkX2lkX3Njb3Bl"),d[54]).then(function(a){return a=a,d[55]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[25],d[55]).then(function(a){return a=a,d[56]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[56]).then(function(a){return a=a,d[57]=a[0],a})},function(b){return d[58]=new c.Map(),d[58].set("attachment_infos",d[44]),d[58].set("message_partial_id",d[49]==null?"":d[49]),d[58].set("product_type",a[3]),d[58].set("salt_partial_id",d[53]==null?"":d[53]),d[58].set("thread_partial_id",d[57]==null?"":d[57]),d[59]=c.toJSON(d[58]),d[60]=new c.Map(),d[60].set("payload",d[59]),b=[d[60],void 0],d[42]=b[0],d[43]=b[1],b}]):c.resolve((a[5]!==void 0?d[44]=a[5]:d[44]="",d[45]=".",d[46]=new c.Map(),d[46].set("error_code",c.i64.cast([-1,4294967295])),d[46].set("stored_procedure","LSEncryptedBackupsSerializeAttachmentBackupPayloadStoredProcedure"),d[46].set("error_message",d[44]),e=[void 0,d[46]],d[42]=e[0],d[43]=e[1],e))},function(a){return a=[d[42],d[43]],d[36]=a[0],d[37]=a[1],a}]):c.resolve((d[38]=".",d[39]=new c.Map(),d[39].set("error_code",c.i64.cast([0,24])),d[39].set("stored_procedure","LSEncryptedBackupsSerializeAttachmentBackupPayloadStoredProcedure"),d[39].set("error_message",""),e=[void 0,d[39]],d[36]=e[0],d[37]=e[1],e))},function(a){return a=[d[36],d[37]],d[9]=a[0],d[10]=a[1],a}]):c.resolve((d[17]=d[7].get("errors"),d[18]=d[7].get("errors"),d[19]=".",d[20]=new c.Map(),d[20].set("error_code",c.i64.cast([0,1])),d[20].set("stored_procedure","LSEncryptedBackupsSerializeAttachmentBackupPayloadStoredProcedure"),d[20].set("error_message",""),e=[void 0,d[20]],d[9]=e[0],d[10]=e[1],e))},function(a){return d[11]=c.i64.of_float(Date.now()),d[12]=c.i64.random(),d[14]="Finishing execution. Execution time: ",d[15]=c.i64.to_string(c.i64.sub(d[11],d[0])),d[16]=" ms",d[13]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][serializeAttachmentBackupPayload] ",d[13],d[14],d[13],d[15],d[13],d[16]].join("")),c.i64.eq(c.i64.mod_(d[12],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[17]=",",d[18]=c.createArray(),void 0!==void 0?d[19]=(d[18].push(void 0),d[18]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"serializeAttachmentBackupPayload",[d[14],d[17],d[15],d[17],d[16]].join(""),d[18],c.i64.cast([0,4]))):c.resolve()},function(a){return a=[d[9],d[10]],e[0]=a[0],e[1]=a[1],a}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsSerializeAttachmentBackupPayloadStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state"];e.exports=a}),null);
__d("LSSerializeAttachmentBackupPayloadStoredProcedure",["LSSerializeAttachmentBackupPayload","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSSerializeAttachmentBackupPayload"),e.attachmentInfos,e.messageId,e.threadId,e.productType,e.error,e.errorMessage);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("LSWriteToPendingProtobufBackupsContextV2",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[];return b.sequence([function(c){return b.db.table(305).add({pk:void 0,pendingBackupTaskId:a[0],actThreadId:a[1],toplevelOfflineThreadingId:a[2],messageTimestampMs:a[6],backupAction:a[7],supplementalKey:a[5],attachmentPayload:a[8],senderId:a[9]})},function(a){return b.resolve(c)}])}a.__sproc_name__="LSEncryptedBackupsWriteToPendingProtobufBackupsContextV2StoredProcedure";a.__tables__=["pending_protobuf_backups_context"];e.exports=a}),null);
__d("LSIssueMessageBackup",["LSArrayGetObjectAt","LSIsEncryptionVersionSecure","LSIssueNewTaskAndGetTaskID","LSLogMebClientEvent.nop","LSSerializeAttachmentBackupPayload","LSWriteToPendingProtobufBackupsContextV2"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(a){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][issueMessageBackup] Beginning execution."),d[1]=c.i64.of_float(Date.now()),c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[15]=new c.Map(),d[15].set("error_msg","Expected a nonempty query result"),d[15].set("code",c.i64.cast([0,3])),d[15].set("src_line","MEBClientStateUtils.php:247 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[16]=c.createArray(),d[17]=(d[16].push(d[15]),d[16]),e=[void 0,d[16]],d[2]=e[0],d[3]=e[1],e):(b=a.item,d[15]=new c.Map(),d[15].set("backup_id",b.backupId),d[15].set("device_public_key_blob",b.devicePublicKeyBlob),d[15].set("device_private_key_blob",b.devicePrivateKeyBlob),d[15].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[15].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[15].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[15].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[15].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[15].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[15].set("orf_client_state_v2_blob",void 0),d[15].set("orf_v2_authority_level",void 0),d[15].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[15].set("device_id",b.deviceId),d[15].set("backup_tenancy",b.backupTenancy),d[15].set("encryption_version",b.encryptionVersion),d[15].set("revision_version",b.revisionVersion),d[15].set("initialize_restore_result",void 0),d[15].set("device_creation_timestamp_sec",void 0),d[15].set("authority_level",b.authorityLevel),e=[d[15],void 0],d[2]=e[0],d[3]=e[1],e)})},function(e){return d[5]=new c.Map(),d[5].set("value",d[2]),d[5].set("errors",d[3]),d[6]=d[5].get("value"),d[6]!==void 0?c.sequence([function(e){return d[15]=d[6].get("backup_id"),d[16]=d[6].get("device_public_key_blob"),d[17]=d[6].get("device_private_key_blob"),d[18]=d[6].get("epoch_storage_public_key_blob"),d[19]=d[6].get("epoch_storage_private_key_blob"),d[20]=d[6].get("epoch_auth_public_key_blob"),d[21]=d[6].get("epoch_auth_private_key_blob"),d[22]=d[6].get("mailbox_root_key_blob"),d[23]=d[6].get("ocmf_client_state_blob"),d[24]=d[6].get("orf_client_state_v2_blob"),d[25]=d[6].get("orf_v2_authority_level"),d[26]=d[6].get("oblivious_validation_token_blob"),d[27]=d[6].get("device_id"),d[28]=d[6].get("backup_tenancy"),d[29]=d[6].get("encryption_version"),d[30]=d[6].get("revision_version"),d[31]=d[6].get("initialize_restore_result"),d[32]=d[6].get("device_creation_timestamp_sec"),d[33]=d[6].get("authority_level"),c.i64.neq(d[27],void 0)?c.sequence([function(a){return d[36]=void 0,c.i64.neq(d[36],void 0)?c.resolve(d[37]=d[36]):c.sequence([function(a){return d[48]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[49]=a[0],a})},function(a){return d[49]?d[58]=(d[48].push(c.i64.cast([0,0])),d[48]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[50]=a[0],a})},function(a){return d[50]?d[58]=(d[48].push(c.i64.cast([0,2])),d[48]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[51]=a[0],a})},function(a){return d[51]?d[58]=(d[48].push(c.i64.cast([0,3])),d[48]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[52]=a[0],a})},function(a){return d[52]?d[58]=(d[48].push(c.i64.cast([0,4])),d[48]):0,d[53]=c.createArray(),d[54]=c.i64.of_int32(d[48].length),c.i64.gt(d[54],c.i64.cast([0,0]))?c.loopAsync(d[54],function(a){return d[58]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[48],d[58]).then(function(a){return a=a,d[59]=a[0],d[60]=a[1],a})},function(a){return d[61]=(d[53].push(d[59]),d[53])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[58]=c.createArray(),d[59]=c.i64.of_int32(d[53].length),c.i64.gt(d[59],c.i64.cast([0,0]))?c.loopAsync(d[59],function(a){return d[61]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[53],d[61]).then(function(a){return a=a,d[62]=a[0],d[63]=a[1],a})},function(a){return d[64]=(d[58].push(c.i64.to_string(d[62])),d[58])}])}):c.resolve()},function(a){return d[60]=d[58].join(","),d[55]=d[60]}])},function(a){return d[53].some(function(a){return c.i64.eq(d[29],a)})?d[56]=d[29]:d[56]=void 0,c.i64.neq(d[56],void 0)?d[57]=d[56]:d[57]=void 0,d[37]=d[57]}])},function(e){var f;return c.i64.neq(d[37],void 0)?d[38]=d[37]:d[38]=c.i64.cast([0,0]),c.i64.neq(d[28],void 0)?d[39]=d[28]:d[39]=c.i64.cast([0,1]),c.sequence([function(e){return a[11]!==void 0?c.sequence([function(e){return d[50]=a[11].get("attachment_infos"),d[51]=a[11].get("attachment_infos"),d[52]=a[11].get("product_type"),d[53]=a[11].get("error"),d[54]=a[11].get("error_message"),c.storedProcedure(b("LSSerializeAttachmentBackupPayload"),d[51],a[1],a[0],d[52],d[53],d[54]).then(function(a){return a=a,d[55]=a[0],d[56]=a[1],a})},function(a){return d[55]?d[57]=!1:d[57]=!0,d[57]?c.sequence([function(a){return d[56]?d[63]=!1:d[63]=!0,d[63]?c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsIssueMessageBackupStoredProcedure] Invalid Attachment payload generated"),d[68]="Invalid Attachment payload generated",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsIssueMessageBackupStoredProcedure] ","",d[68]].join("")),d[67]=c.createArray(),void 0!==void 0?d[69]=(d[67].push(void 0),d[67]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueMessageBackupStoredProcedure",d[68],d[67],c.i64.cast([0,3]))},function(a){return a=[void 0,void 0,d[50]],d[64]=a[0],d[65]=a[1],d[66]=a[2],a}]):c.resolve((a=[void 0,d[56],d[50]],d[64]=a[0],d[65]=a[1],d[66]=a[2],a))},function(a){return a=[d[64],d[65],d[66]],d[58]=a[0],d[59]=a[1],d[60]=a[2],a}]):c.resolve((d[63]=d[55].get("payload"),a=[d[63],void 0,d[50]],d[58]=a[0],d[59]=a[1],d[60]=a[2],a))},function(b){return d[63]=new c.Map(),d[64]=d[63].set("success",d[58]),d[65]=d[63].set("failure",d[59]),d[66]=d[63].set("upload_context",d[60]),d[67]=c.toJSON(d[63]),d[61]=d[67],d[62]=a[11].get("error"),b=[d[61],d[62]],d[48]=b[0],d[49]=b[1],b}]):c.resolve((function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsIssueMessageBackupStoredProcedure] Null Attachments for the message"),e=[void 0,void 0],d[48]=e[0],d[49]=e[1],e))},function(a){return a=[d[48],d[49]],d[40]=a[0],d[41]=a[1],a}])},function(e){return d[46]=c.i64.add(c.i64.mul(c.i64.div(a[2],c.i64.cast([0,1e3])),c.i64.cast([0,1e3])),c.i64.div(c.i64.mod_(c.i64.and_(c.i64.asr_(c.i64.from_string(a[1]),c.i64.to_int32(c.i64.cast([0,22]))),c.i64.cast([511,4294967295])),c.i64.cast([0,1e5])),c.i64.cast([0,100]))),a[9]!==void 0?(d[48]=a[9].get("backup_action"),c.i64.eq(d[48],c.i64.cast([0,4]))?d[49]=a[2]:d[49]=d[46],d[42]=d[49]):d[42]=d[46],d[47]=["Sort Key (",c.i64.to_string(d[42]),") is not in MS. ","auth_ts (",c.i64.to_string(a[2]),"), otid (",a[1],")"].join(""),c.i64.lt(d[42],c.i64.cast([2,1410065408]))?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsIssueMessageBackupStoredProcedure] ","",d[47]].join("")),d[48]=c.createArray(),void 0!==void 0?d[49]=(d[48].push(void 0),d[48]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueMessageBackupStoredProcedure",d[47],d[48],c.i64.cast([0,3]))):c.i64.gt(c.i64.sub(d[42],c.i64.cast([249,3468343296])),c.i64.cast([255,4294967295]))?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsIssueMessageBackupStoredProcedure] ","",d[47]].join("")),d[48]=c.createArray(),void 0!==void 0?d[49]=(d[48].push(void 0),d[48]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueMessageBackupStoredProcedure",d[47],d[48],c.i64.cast([0,3]))):c.resolve()},function(e){return d[43]=c.i64.of_float(Date.now()),c.storedProcedure(b("LSIssueNewTaskAndGetTaskID"),["eb_upload",":",a[0]].join(""),c.i64.cast([0,50026]),"",void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]),c.i64.cast([0,93]),void 0,c.i64.le(c.i64.cast([0,0]),c.i64.cast([0,0]))?c.i64.cast([0,0]):c.i64.add(d[43],c.i64.sub(c.i64.cast([0,0]),c.i64.mod_(d[43],c.i64.cast([0,0])))),c.i64.cast([0,0])).then(function(a){return a=a,d[44]=a[0],a})},function(b){return c.db.table(177).add({pk:void 0,pendingBackupTaskId:d[44],actionType:c.i64.cast([0,1]),contentType:c.i64.cast([0,1]),backupStatus:c.i64.cast([0,1]),listKey:a[0],uniqueKey:a[1],sortKey:c.i64.to_string(d[42]),persistentId:"",isInstamadillo:a[12],echoContent:a[4],lsTraceId:a[5],error:a[6],echoEncodingLatencyNs:a[7],errorMessage:a[8],attachmentPayload:d[40],attachmentErrorCode:d[41]})},function(b){return c.i64.eq(c.i64.cast([0,1]),c.i64.cast([0,1]))?c.i64.eq(c.i64.cast([0,1]),c.i64.cast([0,1]))?(d[48]=c.createArray(),d[50]=(d[48].push("Successfully issued message backup task. act thread id = "),d[48]),d[50]=(d[48].push(a[0]),d[48]),d[50]=(d[48].push(", otid = "),d[48]),d[50]=(d[48].push(a[1]),d[48]),d[49]=d[48].join(void 0||""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][issueMessageBackup] ","",d[49]].join("")),c.resolve()):(d[48]=c.createArray(),d[50]=(d[48].push("Successfully issued message remove task. act thread id = "),d[48]),d[50]=(d[48].push(a[0]),d[48]),d[50]=(d[48].push(", otid = "),d[48]),d[50]=(d[48].push(a[1]),d[48]),d[49]=d[48].join(void 0||""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][issueMessageBackup] ","",d[49]].join("")),c.resolve()):(d[48]=c.createArray(),d[50]=(d[48].push("Successfully issued thread remove task. act thread id = "),d[48]),d[50]=(d[48].push(a[0]),d[48]),d[49]=d[48].join(void 0||""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][issueMessageBackup] ","",d[49]].join("")),c.resolve())},function(e){return a[9]!==void 0?c.sequence([function(e){return d[48]=a[9].get("act_thread_id"),d[49]=a[9].get("backup_action"),d[50]=a[9].get("toplevel_offline_threading_id"),d[51]=a[9].get("supplemental_offline_threading_id"),d[52]=a[9].get("message_timestamp_ms"),d[53]=a[9].get("supplemental_key"),d[54]=a[9].get("attachment_payload"),d[55]=a[9].get("extra_data_for_eb_upload"),d[56]=a[9].get("message_protobuf"),c.storedProcedure(b("LSWriteToPendingProtobufBackupsContextV2"),d[44],d[48],d[50],d[51],void 0,d[53],d[52],d[49],d[54],void 0,d[56],d[55])},function(e){return d[57]=a[9].get("backup_action"),c.i64.eq(d[42],a[2])?(d[59]=["Sort key and authoritative_ts are equal for event type: ",c.i64.to_string(d[57])].join(""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsIssueMessageBackupStoredProcedure] ",d[59]].join("")),d[58]=c.createArray(),void 0!==void 0?d[60]=(d[58].push(void 0),d[58]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueMessageBackupStoredProcedure",d[59],d[58],c.i64.cast([0,4]))):(d[59]=["Sort key (",c.i64.to_string(d[42]),") and authoritative_ts (",c.i64.to_string(a[2]),") are not equal given OTID (",a[1],") for event type: ",c.i64.to_string(d[57])].join(""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsIssueMessageBackupStoredProcedure] ",d[59]].join("")),d[58]=c.createArray(),void 0!==void 0?d[60]=(d[58].push(void 0),d[58]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueMessageBackupStoredProcedure",d[59],d[58],c.i64.cast([0,4])))}]):c.i64.eq(d[42],a[2])?(d[49]=["Sort key and authoritative_ts are equal for event type: ",c.i64.to_string(c.i64.cast([-1,4294967295]))].join(""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsIssueMessageBackupStoredProcedure] ",d[49]].join("")),d[48]=c.createArray(),void 0!==void 0?d[50]=(d[48].push(void 0),d[48]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueMessageBackupStoredProcedure",d[49],d[48],c.i64.cast([0,4]))):(d[49]=["Sort key (",c.i64.to_string(d[42]),") and authoritative_ts (",c.i64.to_string(a[2]),") are not equal given OTID (",a[1],") for event type: ",c.i64.to_string(c.i64.cast([-1,4294967295]))].join(""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsIssueMessageBackupStoredProcedure] ",d[49]].join("")),d[48]=c.createArray(),void 0!==void 0?d[50]=(d[48].push(void 0),d[48]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueMessageBackupStoredProcedure",d[49],d[48],c.i64.cast([0,4])))},function(a){return d[45]=new c.Map(),d[45].set("task_id",d[44]),a=[d[45],void 0],d[34]=a[0],d[35]=a[1],a}]):c.sequence([function(b){return d[36]=c.createArray(),d[39]=(d[36].push("Skipping the message upload since EB is disabled. act thread id = "),d[36]),d[39]=(d[36].push(a[0]),d[36]),d[39]=(d[36].push(", otid = "),d[36]),d[39]=(d[36].push(a[1]),d[36]),d[37]=d[36].join(void 0||""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][issueMessageBackup] ","",d[37]].join("")),c.resolve()},function(a){return d[38]=new c.Map(),d[38].set("error_code",c.i64.cast([0,24])),d[38].set("stored_procedure","LSEncryptedBackupsIssueMessageBackupStoredProcedure"),d[38].set("error_message",""),a=[void 0,d[38]],d[34]=a[0],d[35]=a[1],a}])},function(a){return a=[d[34],d[35]],d[7]=a[0],d[8]=a[1],a}]):c.sequence([function(b){return d[15]=d[5].get("errors"),d[16]=d[5].get("errors"),d[17]=c.createArray(),d[20]=(d[17].push("Skipping the message upload since EB is disabled. act thread id = "),d[17]),d[20]=(d[17].push(a[0]),d[17]),d[20]=(d[17].push(", otid = "),d[17]),d[20]=(d[17].push(a[1]),d[17]),d[18]=d[17].join(void 0||""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][issueMessageBackup] ","",d[18]].join("")),c.resolve()},function(a){return d[19]=new c.Map(),d[19].set("error_code",c.i64.cast([0,1])),d[19].set("stored_procedure","LSEncryptedBackupsIssueMessageBackupStoredProcedure"),d[19].set("error_message",""),a=[void 0,d[19]],d[7]=a[0],d[8]=a[1],a}])},function(a){return d[9]=c.i64.of_float(Date.now()),d[10]=c.i64.random(),d[12]="Finishing execution. Execution time: ",d[13]=c.i64.to_string(c.i64.sub(d[9],d[0])),d[14]=" ms",d[11]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][issueMessageBackup] ",d[11],d[12],d[11],d[13],d[11],d[14]].join("")),c.i64.eq(c.i64.mod_(d[10],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[15]=",",d[16]=c.createArray(),void 0!==void 0?d[17]=(d[16].push(void 0),d[16]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"issueMessageBackup",[d[12],d[15],d[13],d[15],d[14]].join(""),d[16],c.i64.cast([0,4]))):c.resolve()},function(a){return a=[d[7],d[8]],e[0]=a[0],e[1]=a[1],a}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsIssueMessageBackupStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state","pending_backups_context_v2"];e.exports=a}),null);
__d("LSIssueMessageBackupStoredProcedure",["LSIssueMessageBackup","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSIssueMessageBackup"),e.actThreadId,e.otid,e.authoritativeTs,e.source,e.echoDocument,e.traceId,e.error,e.echoEncodingLatencyNs,e.errorMessage,e.protobufBackupContext,e.tamThreadSubtype,e.attachmentBackupContext,e.isInstamadillo);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("LSIssueMessageRemove",["LSArrayGetObjectAt","LSIsEncryptionVersionSecure","LSIssueNewTaskAndGetTaskID","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(a){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][issueMessageRemove] Beginning execution."),d[1]=c.i64.of_float(Date.now()),c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[15]=new c.Map(),d[15].set("error_msg","Expected a nonempty query result"),d[15].set("code",c.i64.cast([0,3])),d[15].set("src_line","MEBClientStateUtils.php:247 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[16]=c.createArray(),d[17]=(d[16].push(d[15]),d[16]),e=[void 0,d[16]],d[2]=e[0],d[3]=e[1],e):(b=a.item,d[15]=new c.Map(),d[15].set("backup_id",b.backupId),d[15].set("device_public_key_blob",b.devicePublicKeyBlob),d[15].set("device_private_key_blob",b.devicePrivateKeyBlob),d[15].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[15].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[15].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[15].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[15].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[15].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[15].set("orf_client_state_v2_blob",void 0),d[15].set("orf_v2_authority_level",void 0),d[15].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[15].set("device_id",b.deviceId),d[15].set("backup_tenancy",b.backupTenancy),d[15].set("encryption_version",b.encryptionVersion),d[15].set("revision_version",b.revisionVersion),d[15].set("initialize_restore_result",void 0),d[15].set("device_creation_timestamp_sec",void 0),d[15].set("authority_level",b.authorityLevel),e=[d[15],void 0],d[2]=e[0],d[3]=e[1],e)})},function(e){return d[5]=new c.Map(),d[5].set("value",d[2]),d[5].set("errors",d[3]),d[6]=d[5].get("value"),d[6]!==void 0?c.sequence([function(e){return d[15]=d[6].get("backup_id"),d[16]=d[6].get("device_public_key_blob"),d[17]=d[6].get("device_private_key_blob"),d[18]=d[6].get("epoch_storage_public_key_blob"),d[19]=d[6].get("epoch_storage_private_key_blob"),d[20]=d[6].get("epoch_auth_public_key_blob"),d[21]=d[6].get("epoch_auth_private_key_blob"),d[22]=d[6].get("mailbox_root_key_blob"),d[23]=d[6].get("ocmf_client_state_blob"),d[24]=d[6].get("orf_client_state_v2_blob"),d[25]=d[6].get("orf_v2_authority_level"),d[26]=d[6].get("oblivious_validation_token_blob"),d[27]=d[6].get("device_id"),d[28]=d[6].get("backup_tenancy"),d[29]=d[6].get("encryption_version"),d[30]=d[6].get("revision_version"),d[31]=d[6].get("initialize_restore_result"),d[32]=d[6].get("device_creation_timestamp_sec"),d[33]=d[6].get("authority_level"),c.i64.neq(d[27],void 0)?c.sequence([function(a){return d[36]=void 0,c.i64.neq(d[36],void 0)?c.resolve(d[37]=d[36]):c.sequence([function(a){return d[43]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[44]=a[0],a})},function(a){return d[44]?d[53]=(d[43].push(c.i64.cast([0,0])),d[43]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[45]=a[0],a})},function(a){return d[45]?d[53]=(d[43].push(c.i64.cast([0,2])),d[43]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[46]=a[0],a})},function(a){return d[46]?d[53]=(d[43].push(c.i64.cast([0,3])),d[43]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[47]=a[0],a})},function(a){return d[47]?d[53]=(d[43].push(c.i64.cast([0,4])),d[43]):0,d[48]=c.createArray(),d[49]=c.i64.of_int32(d[43].length),c.i64.gt(d[49],c.i64.cast([0,0]))?c.loopAsync(d[49],function(a){return d[53]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[43],d[53]).then(function(a){return a=a,d[54]=a[0],d[55]=a[1],a})},function(a){return d[56]=(d[48].push(d[54]),d[48])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[53]=c.createArray(),d[54]=c.i64.of_int32(d[48].length),c.i64.gt(d[54],c.i64.cast([0,0]))?c.loopAsync(d[54],function(a){return d[56]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[48],d[56]).then(function(a){return a=a,d[57]=a[0],d[58]=a[1],a})},function(a){return d[59]=(d[53].push(c.i64.to_string(d[57])),d[53])}])}):c.resolve()},function(a){return d[55]=d[53].join(","),d[50]=d[55]}])},function(a){return d[48].some(function(a){return c.i64.eq(d[29],a)})?d[51]=d[29]:d[51]=void 0,c.i64.neq(d[51],void 0)?d[52]=d[51]:d[52]=void 0,d[37]=d[52]}])},function(e){return c.i64.neq(d[37],void 0)?d[38]=d[37]:d[38]=c.i64.cast([0,0]),c.i64.neq(d[28],void 0)?d[39]=d[28]:d[39]=c.i64.cast([0,1]),d[40]=c.i64.of_float(Date.now()),c.storedProcedure(b("LSIssueNewTaskAndGetTaskID"),["eb_upload",":",a[0]].join(""),c.i64.cast([0,50026]),"",void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]),c.i64.cast([0,93]),void 0,c.i64.le(c.i64.cast([0,0]),c.i64.cast([0,0]))?c.i64.cast([0,0]):c.i64.add(d[40],c.i64.sub(c.i64.cast([0,0]),c.i64.mod_(d[40],c.i64.cast([0,0])))),c.i64.cast([0,0])).then(function(a){return a=a,d[41]=a[0],a})},function(b){return c.db.table(177).add({pk:void 0,pendingBackupTaskId:d[41],actionType:c.i64.cast([0,2]),contentType:c.i64.cast([0,1]),backupStatus:c.i64.cast([0,1]),listKey:a[0],uniqueKey:a[1],sortKey:c.i64.to_string(c.i64.add(c.i64.mul(c.i64.div(a[2],c.i64.cast([0,1e3])),c.i64.cast([0,1e3])),c.i64.div(c.i64.mod_(c.i64.and_(c.i64.asr_(c.i64.from_string(a[1]),c.i64.to_int32(c.i64.cast([0,22]))),c.i64.cast([511,4294967295])),c.i64.cast([0,1e5])),c.i64.cast([0,100])))),persistentId:"",isInstamadillo:!1,lsTraceId:a[4],error:a[5]})},function(b){return c.i64.eq(c.i64.cast([0,1]),c.i64.cast([0,1]))?c.i64.eq(c.i64.cast([0,2]),c.i64.cast([0,1]))?(d[43]=c.createArray(),d[45]=(d[43].push("Successfully issued message backup task. act thread id = "),d[43]),d[45]=(d[43].push(a[0]),d[43]),d[45]=(d[43].push(", otid = "),d[43]),d[45]=(d[43].push(a[1]),d[43]),d[44]=d[43].join(void 0||""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][issueMessageRemove] ","",d[44]].join("")),c.resolve()):(d[43]=c.createArray(),d[45]=(d[43].push("Successfully issued message remove task. act thread id = "),d[43]),d[45]=(d[43].push(a[0]),d[43]),d[45]=(d[43].push(", otid = "),d[43]),d[45]=(d[43].push(a[1]),d[43]),d[44]=d[43].join(void 0||""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][issueMessageRemove] ","",d[44]].join("")),c.resolve()):(d[43]=c.createArray(),d[45]=(d[43].push("Successfully issued thread remove task. act thread id = "),d[43]),d[45]=(d[43].push(a[0]),d[43]),d[44]=d[43].join(void 0||""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][issueMessageRemove] ","",d[44]].join("")),c.resolve())},function(a){return d[42]=new c.Map(),d[42].set("task_id",d[41]),a=[d[42],void 0],d[34]=a[0],d[35]=a[1],a}]):c.sequence([function(b){return d[36]=c.createArray(),d[39]=(d[36].push("Skipping message upload since EB is disabled. act thread id = "),d[36]),d[39]=(d[36].push(a[0]),d[36]),d[39]=(d[36].push(", otid = "),d[36]),d[39]=(d[36].push(a[1]),d[36]),d[37]=d[36].join(void 0||""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][issueMessageRemove] ","",d[37]].join("")),c.resolve()},function(a){return d[38]=new c.Map(),d[38].set("error_code",c.i64.cast([0,24])),d[38].set("stored_procedure","LSEncryptedBackupsIssueMessageRemoveStoredProcedure"),d[38].set("error_message",""),a=[void 0,d[38]],d[34]=a[0],d[35]=a[1],a}])},function(a){return a=[d[34],d[35]],d[7]=a[0],d[8]=a[1],a}]):c.sequence([function(b){return d[15]=d[5].get("errors"),d[16]=d[5].get("errors"),d[17]=c.createArray(),d[20]=(d[17].push("Skipping message upload since EB is disabled. act thread id = "),d[17]),d[20]=(d[17].push(a[0]),d[17]),d[20]=(d[17].push(", otid = "),d[17]),d[20]=(d[17].push(a[1]),d[17]),d[18]=d[17].join(void 0||""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][issueMessageRemove] ","",d[18]].join("")),c.resolve()},function(a){return d[19]=new c.Map(),d[19].set("error_code",c.i64.cast([0,1])),d[19].set("stored_procedure","LSEncryptedBackupsIssueMessageRemoveStoredProcedure"),d[19].set("error_message",""),a=[void 0,d[19]],d[7]=a[0],d[8]=a[1],a}])},function(a){return d[9]=c.i64.of_float(Date.now()),d[10]=c.i64.random(),d[12]="Finishing execution. Execution time: ",d[13]=c.i64.to_string(c.i64.sub(d[9],d[0])),d[14]=" ms",d[11]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][issueMessageRemove] ",d[11],d[12],d[11],d[13],d[11],d[14]].join("")),c.i64.eq(c.i64.mod_(d[10],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[15]=",",d[16]=c.createArray(),void 0!==void 0?d[17]=(d[16].push(void 0),d[16]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"issueMessageRemove",[d[12],d[15],d[13],d[15],d[14]].join(""),d[16],c.i64.cast([0,4]))):c.resolve()},function(a){return a=[d[7],d[8]],e[0]=a[0],e[1]=a[1],a}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsIssueMessageRemoveStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state","pending_backups_context_v2"];e.exports=a}),null);
__d("LSIssueMessageRemoveStoredProcedure",["LSIssueMessageRemove","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSIssueMessageRemove"),e.actThreadId,e.otid,e.authoritativeTs,e.source,e.traceId,e.error);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("LSTamThreadSubtype",[],(function(a,b,c,d,e,f){a=Object.freeze({STANDARD:0,VANISH_MODE:1,DUAL_SEND_SHADOW:2,BTV_COMPANION:3,BLEND_DUAL_SEND:4,BLEND_DUAL_SEND_NO_NETWORK:5});f["default"]=a}),66);
__d("MAWBridgeUploadMessageHandler",["EBIsEbEnabled","EncryptedBackupsWriteToMPSTables","FBLogger","I64","LSDataTraceCheckPoint","LSEncryptedBackupsAttachmentErrorCode","LSFactory","LSIntEnum","LSIssueMessageBackupStoredProcedure","LSIssueMessageRemoveStoredProcedure","LSMEBTaskCreationSource","LSShape","LSTamThreadSubtype","LSVec","MAWCastToMsgrServerMediaType","MAWEBFrontendQPLLogger","MAWMsgType","MAWTraceUtils","MWEBODSEntityName.enum","MWEBODSUtils","WATimeUtils","cr:17101","gkx","isInstamadillo","isInstamadilloEB"],(function(a,b,c,d,e,f,g){"use strict";var h,i;async function a(a,e){var f,g;if(c("isInstamadilloEB")())return Promise.resolve();var l=k(e.uploadTrackingInstanceKey);e.uploadTrackingInstanceKey!=null&&d("MAWEBFrontendQPLLogger").addPointEBUploadTracking(e.uploadTrackingInstanceKey,"upload_tracking_bridge_handler");d("MWEBODSUtils").markODSForEB(c("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"upload."+((f=e.messageType)!=null?f:"unknown"));f=e.protoMsg;var m=e.traceId;g=((g=e.uploadTrackingInstanceKey)!=null?g:e.traceId).toString();if(!await d("EBIsEbEnabled").isEbEnabledLS(a,m,l)){if(e.uploadTrackingInstanceKey!=null){m=e.uploadTrackingInstanceKey;d("MAWEBFrontendQPLLogger").addPointEBUploadTracking(m,"user_device_not_enrolled_invalid_echo_request");d("MAWEBFrontendQPLLogger").endEBUploadTracking(m)}d("MAWTraceUtils").recordCheckpointForTrace(g,(h||(h=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_WEB_UPLOAD_USER_DEVICE_NOT_ENROLLED),[],!1);d("MAWTraceUtils").recordInvalidUploadRequestAndFlushTrace(g,h.ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_WEB_ECHO_MESSAGE_UPLOAD_INVALID_REQUEST),[]);return}m=e.echoDocument;var n=d("WATimeUtils").castMilliSecondsToUnixTime(e.sortOrderMs);if(e.actionType===1){var o=e.echoEncodingLatencyNs,p=e.errorCode,q=e.errorMessage;e.uploadTrackingInstanceKey!=null&&d("MAWEBFrontendQPLLogger").addPointEBUploadTracking(e.uploadTrackingInstanceKey,"issuing_message_backup");var r;if(f!=null)try{var s=f.sortOrderMs;if(s==null)throw c("FBLogger")("messenger_web").mustfixThrow("sort order is null for the protobuf message");await d("EncryptedBackupsWriteToMPSTables").writeToMPSTables(a,f,e.threadId,!1,l);r=d("LSShape").ofRecord({act_thread_id:e.threadId,attachment_payload:null,backup_action:(h||(h=d("LSIntEnum"))).ofNumber(f.backupActionType),message_timestamp_ms:(i||(i=d("I64"))).of_float(s),supplemental_key:f.supplementalKey,toplevel_offline_threading_id:(s=(l=f.originalMsgProtocolId)==null?void 0:l.externalId)!=null?s:f.msgId.externalId})}catch(a){a instanceof Error?c("FBLogger")("labyrinth_web").catching(a).mustfix("[labyrinth_web] Error writing to MPSTables for the upload message due to runtime error"):c("FBLogger")("labyrinth_web").mustfix("[labyrinth_web] Error writing to MPSTables for the upload message")}var t;if(e.attachmentBackupContext!=null){l=j({bridgeUploadAttachmentBackupContext:e.attachmentBackupContext,messageId:e.messageId,serverThreadKey:null,threadId:e.threadId,traceId:e.traceId});l!=null&&(t=d("LSShape").ofRecord(l))}e.uploadTrackingInstanceKey!=null&&d("MAWEBFrontendQPLLogger").addPointEBUploadTracking(e.uploadTrackingInstanceKey,"upload_handler_echo_protobuf_context",{bool:{attachment_backup_context:t!=null,protobuf_context:r!=null}});if(e.messageType!=null){s=d("MAWMsgType").isMAWSupportedMediaType(e.messageType)?"media":"non-media";d("MWEBODSUtils").markODSForEB(c("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"upload."+s)}t!=null&&d("MWEBODSUtils").markODSForEB(c("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"upload.attachment_unified_backup");await c("LSIssueMessageBackupStoredProcedure")(c("LSFactory")(a),{actThreadId:e.threadId,attachmentBackupContext:t,authoritativeTs:(i||(i=d("I64"))).of_float(n*1e3),echoDocument:m!=null?m:"",echoEncodingLatencyNs:o!=null?(i||(i=d("I64"))).of_float(o):void 0,error:p!=null?(h||(h=d("LSIntEnum"))).ofNumber(p):void 0,errorMessage:q!=null?q:void 0,isInstamadillo:c("isInstamadillo")(),otid:e.messageId,protobufBackupContext:r,source:(h||(h=d("LSIntEnum"))).ofNumber(c("LSMEBTaskCreationSource").TAM),tamThreadSubtype:h.ofNumber(c("isInstamadillo")()?c("LSTamThreadSubtype").BLEND_DUAL_SEND:c("LSTamThreadSubtype").STANDARD),traceId:g});e.uploadTrackingInstanceKey!=null&&d("MAWEBFrontendQPLLogger").addPointEBUploadTracking(e.uploadTrackingInstanceKey,"upload_tracking_upload_task_issued");void b("cr:17101").log(function(){return{message_id:e.messageId,trace_id:e.traceId}})}else e.actionType===2&&(await c("LSIssueMessageRemoveStoredProcedure")(c("LSFactory")(a),{actThreadId:e.threadId,authoritativeTs:(i||(i=d("I64"))).of_float(n*1e3),otid:e.messageId,source:(h||(h=d("LSIntEnum"))).ofNumber(c("LSMEBTaskCreationSource").TAM),traceId:g}),e.uploadTrackingInstanceKey!=null&&d("MAWEBFrontendQPLLogger").addPointEBUploadTracking(e.uploadTrackingInstanceKey,"upload_tracking_remove_task_issued"))}function j(a){var b;if(!c("gkx")("6956"))return void 0;var e=a.bridgeUploadAttachmentBackupContext,f=a.messageId,g=a.serverThreadKey,i=a.threadId;a=a.traceId;if(e.attachmentInfos.length===0)return;var j=e.attachmentInfos;d("MAWEBFrontendQPLLogger").startFlowUploadAttachmentBackup({deliveryObjectId:j[0].zippyObjectId,flow:"unified",mediaType:(b=d("MAWCastToMsgrServerMediaType").castMediaAttachmentTypeToServerMediaType(j[0].mediaType))!=null?b:"unknown",messageId:f,threadId:i,traceId:a});b=c("LSVec").ofArray(j.map(function(a){return d("LSShape").ofRecord({attachment_trace_id:a.attachmentTraceId,media_type:a.mediaType,zippy_object_id:a.zippyObjectId})}));f=(h||(h=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsAttachmentErrorCode").NO_ERROR);e.error!=null&&(f=(h||(h=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsAttachmentErrorCode").UNKNOWN_ERROR));i={attachment_infos:b,error:f,error_message:null,product_type:e.productType,server_thread_key:g};return i}function k(a){return a==null?null:d("MAWEBFrontendQPLLogger").makeEBFrontendQplFlowFromInstanceKey(a)}g.call=a;g.getMessageUploadAttachmentBackupContext=j}),98);
__d("MAWUploadPayloadGenerator",["EBLogger","EBParseUploadSerializationPayload","I64","LSBackupContentType","LSEncryptedBackupsAttachmentErrorCode","LSFactory","LSIntEnum","LSPendingBackupStatus","LSSerializeAttachmentBackupPayloadStoredProcedure","LSShape","LSTaskSerializerEncryptedBackupsUpload","LSVec","MAWBridgeUploadMessageHandler","MAWEBFrontendQPLLogger","MWEBODSUtils","Random","ReQL","WAErrorMessage","WAGetSafeQPLError","WAResultOrError","gkx","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["upload message is missing echo document msgType: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["EB upload serializer error: "," in ",""]);k=function(){return a};return a}var l=d("EBLogger").EBLogger.tags(["MAWUploadPayloadGenerator"]),m="0",n=new Set();function o(){for(var a=0;a<1e8;a++){var b=d("Random").uint32();if(!n.has(b))return b}throw l.mustfixThrow("Unable to generate a unique task ID after 100 million attempts")}async function a(a,b,e){var f="unknown";c("justknobx")._("4439")&&(f=await t(a)?"available":"unavailable");b=b.map(function(b){try{var c=o();n.add(c);return d("WAResultOrError").makeResult({msg:b,taskMetadata:p(a,b,c)})}catch(a){c=d("WAErrorMessage").maybeGetMessageFromError(a);return d("WAResultOrError").makeError({error:c,instanceKey:b.uploadTrackingInstanceKey})}});b=await Promise.all(b.map(function(a){return a.success?a.value:null}).filter(Boolean));b=await Promise.all(b.map(function(b){var g=b.taskMetadata;return g.then(function(g){var i;d("MAWEBFrontendQPLLogger").addPointEBUploadTracking((i=g.uploadTrackingInstanceKey)!=null?i:null,"upload_task_serialization_start",{string:{base_epoch_availability:f,execution_environment:e}});return c("LSTaskSerializerEncryptedBackupsUpload")((h||(h=d("I64"))).of_int32(g.task),c("LSFactory")(a)).then(function(f){if(f.length>0&&f[0]!=null){var h=d("EBParseUploadSerializationPayload").parseUploadSerializationResponse(f[0]);if(h.success){h=h.value;var i=!1;h.failure!=null&&(i=!0,d("EBParseUploadSerializationPayload").logUploadSerializationErrors([h.failure],"echo",e,g.uploadTrackingInstanceKey));if(h.protobuf_failures!=null){h=c("LSVec").toArray(h.protobuf_failures).filter(Boolean);h.length>0&&(i=!0,d("EBParseUploadSerializationPayload").logUploadSerializationErrors(h,"protobuf",e,g.uploadTrackingInstanceKey))}if(!i){d("MAWEBFrontendQPLLogger").addPointEBUploadTracking((h=g.uploadTrackingInstanceKey)!=null?h:null,"upload_task_serialization_success",{string:{execution_environment:e}})}}}i=g.pending_protobuf_backups_context_pk;return Promise.all([a.pending_backups_context_v2.delete(g.pending_backups_context_v2_pk),i!=null?a.pending_protobuf_backups_context.delete(i):Promise.resolve(null)]).then(function(){n.delete(g.task);return d("WAResultOrError").makeResult({msg:b.msg,payload:f[0]})})}).catch(function(a){var c,f=d("WAErrorMessage").maybeGetMessageFromError(a);d("MAWEBFrontendQPLLogger").addPointEBUploadTracking((c=g.uploadTrackingInstanceKey)!=null?c:null,"upload_task_serialization_failure",{string:{serialization_error:d("WAGetSafeQPLError").getSafeQPLErrorMessage(a)}});l.MUSTFIX(k(),d("WAGetSafeQPLError").getSafeQPLErrorMessage(a),e);return d("WAResultOrError").makeError({error:f,instanceKey:b.msg.uploadTrackingInstanceKey})})})}));return b}async function p(a,b,e){var f=b.sortOrderMs.toString(),g=(h||(h=d("I64"))).of_int32(e),k=h.of_float(b.actionType),m=await r(a,b),n=b.protoMsg,o=n!=null&&c("gkx")("8488");if(!o&&(b.echoDocument==null||b.echoDocument.length===0)){var p;l.MUSTFIX(j(),(p=b.messageType)!=null?p:"unknown");d("MWEBODSUtils").markODSForEB("upload","missing_echo_document."+((p=b.messageType)!=null?p:"unknown"))}k=await a.pending_backups_context_v2.add({actionType:k,attachmentErrorCode:s(b),attachmentPayload:m,backupStatus:(i||(i=d("LSIntEnum"))).ofNumber(c("LSPendingBackupStatus").BACKUP_IN_PROGRESS),contentType:i.ofNumber(c("LSBackupContentType").MESSAGE),echoContent:o?"":(p=b.echoDocument)!=null?p:"",listKey:b.threadId,pendingBackupTaskId:h.of_int32(e),persistentId:"",pk:g,sortKey:f,uniqueKey:b.messageId});if(n==null)return{pending_backups_context_v2_pk:k[0],task:e,uploadTrackingInstanceKey:b.uploadTrackingInstanceKey};g=await a.pending_protobuf_backups_context.add({actThreadId:b.threadId,attachmentPayload:m,backupAction:h.of_float(n.backupActionType),messageTimestampMs:h.of_float(b.sortOrderMs),pendingBackupTaskId:h.of_float(e),supplementalKey:n.supplementalKey,toplevelOfflineThreadingId:n.backupActionType===4?n.msgId.externalId:(p=(o=n.originalMsgProtocolId)==null?void 0:o.externalId)!=null?p:n.msgId.externalId});return{pending_backups_context_v2_pk:k[0],pending_protobuf_backups_context_pk:g[0],task:e,uploadTrackingInstanceKey:b.uploadTrackingInstanceKey}}function q(a){if(a.attachmentInfos.length!==1)return[];a=a.attachmentInfos[0];return[{attachment_trace_id:a.attachmentTraceId,media_type:a.mediaType,zippy_object_id:a.zippyObjectId}]}async function r(a,b){if(!c("gkx")("6956"))return void 0;var e,f,g=b.attachmentBackupContext;if(g!=null){f=d("MAWBridgeUploadMessageHandler").getMessageUploadAttachmentBackupContext({bridgeUploadAttachmentBackupContext:g,messageId:b.messageId,serverThreadKey:null,threadId:b.threadId,traceId:b.traceId});if(f!=null){a=await c("LSSerializeAttachmentBackupPayloadStoredProcedure")(c("LSFactory")(a),{attachmentInfos:f.attachment_infos,error:f.error,errorMessage:f.error_message,messageId:b.messageId,productType:f.product_type,threadId:b.threadId});f=a[0];b=a[1];if(f!=null){a=d("LSShape").toRecord(f);e=JSON.stringify({success:a.payload,upload_context:q(g)})}else if(b!=null){f=d("LSShape").toRecord(b);a=f.error_code;e=JSON.stringify({failure:{error_code:(h||(h=d("I64"))).to_float(a),error_message:f.error_message,stored_procedure:f.stored_procedure},upload_context:q(g)})}}}return e}function s(a){return!c("gkx")("6956")?void 0:(h||(h=d("I64"))).of_float(((a=a.attachmentBackupContext)==null?void 0:a.error)!=null?c("LSEncryptedBackupsAttachmentErrorCode").UNKNOWN_ERROR:c("LSEncryptedBackupsAttachmentErrorCode").NO_ERROR)}function t(a){var b=new TextDecoder();return d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.secure_encrypted_backups_epochs).filter(function(a){return b.decode(a.epochAnonIdBlob)===m})).then(function(a){if(a!=null)return!0;else return!1})}g.genUploadPayload=a}),98);
__d("XFBEBDeviceEpochStatus.facebook",["$InternalEnum"],(function(a,b,c,d,e,f){a=b("$InternalEnum").Mirrored(["INELIGIBLE_FOR_LABYRINTH_11","NO_OPEN_EPOCH","OK","OUTDATED","RATE_LIMITED"]);c=a;f["default"]=c}),66);
__d("EBUploadMessagesFromWorkerMutation",["EBIsEbEnabled","EBLS","EBUploadMessagesFromWorkerMutation.graphql","EncryptedBackupsWriteToMPSTables","FBLogger","LSFactory","LSHandleBackupWriteResultV2StoredProcedure","LSPrepareOpenEpochV2StoredProcedure","LSShape","LSSyncEpochsStoredProcedure","LSVec","MAWCurrentUser","MAWEBFalcoLoggerUtils","MAWEBUploadTrackingUtils","MAWUploadPayloadGenerator","MWEBODSEntityName.enum","ODS","WAErrorMessage","WALogger","WAResultOrError","createWorkerMutation"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to upload with EBLS: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] graphqlResponse is null"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to generate payload: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] backupWriteResult is null"]);m=function(){return a};return a}var n=h!==void 0?h:h=b("EBUploadMessagesFromWorkerMutation.graphql");function o(a,b){a.forEach(function(a){a.uploadTrackingInstanceKey!=null&&d("MAWEBUploadTrackingUtils").addPointWorkerOnly(a.uploadTrackingInstanceKey,b)})}function p(a,b,c){a.forEach(function(a){a.uploadTrackingInstanceKey!=null&&d("MAWEBUploadTrackingUtils").endFailWorkerOnly(a.uploadTrackingInstanceKey,b,c)})}async function q(a){var b=a.backupWriteResult,e=a.deviceEpochStatus,g=a.exception_string,h=a.inputMessages;if(b==null){p(h,"ebls_upload_failed_backup_write_result_null",{string:{error:"backupWriteResult is null"}});d("WALogger").ERROR(m());return d("WAResultOrError").makeError("backup_write_result_null")}a=await d("EBLS").getLSStorage();var i=b.is_success,j=b.delete_mailbox,k=(b=b.protobuf_params)==null?void 0:b.delete_on_success;if(i!=null&&j!=null){if(!i){p(h,"ebls_upload_failed",{string:{error:g}});return d("WAResultOrError").makeError("gql_upload_failed")}else c("FBLogger")("labyrinth_web").info("Worker successfully completed GQL upload batch of size %s",h.length),o(h,"ebls_upload_success");await a.runInTransaction(function(a){return c("LSHandleBackupWriteResultV2StoredProcedure")(c("LSFactory")(a),{deleteMailbox:j,isSuccess:i,protobufParams:k!=null?d("LSShape").ofRecord({delete_on_success:k}):void 0,traceIds:c("LSVec").ofArray(h.map(function(a){return a.traceId}))})},"readwrite",void 0,void 0,f.id+":156")}if(e==null)return d("WAResultOrError").makeError("device_epoch_status_null");switch(e){case"NO_OPEN_EPOCH":o(h,"prepare_open_epoch_v2_start");await a.runInTransaction(function(a){return c("LSPrepareOpenEpochV2StoredProcedure")(c("LSFactory")(a),{backupId:void 0})},"readwrite",void 0,void 0,f.id+":180");o(h,"prepare_open_epoch_v2_end");break;case"OUTDATED":o(h,"sync_epochs_start");await a.runInTransaction(function(a){return c("LSSyncEpochsStoredProcedure")(c("LSFactory")(a))},"readonly",void 0,void 0,f.id+":191");o(h,"sync_epochs_start");break;case"OK":break;default:}return d("WAResultOrError").makeResult()}async function a(a){try{(i||(i=d("ODS"))).bumpEntityKey(7319,c("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"worker_thread");o(a,"ebls_init_start");await d("EBLS").init();var b=await d("EBLS").getLSStorage();o(a,"ebls_backup_tenancy_start");if(!await d("EBIsEbEnabled").isEbEnabledLS(b.tables)){for(var e of a)if(e.uploadTrackingInstanceKey!=null){var g=e.uploadTrackingInstanceKey;d("MAWEBUploadTrackingUtils").addPointWorkerOnly(g,"user_device_not_enrolled_invalid_gql_request");var h=e.echoDocument!=null?"dual_upload":"protobuf_only";d("MAWEBFalcoLoggerUtils").logEBFalcoTaskSkipped(e,h,"user_device_not_enrolled");d("MAWEBUploadTrackingUtils").endSuccessWorkerOnly(g,"upload_tracking_completed")}return d("WAResultOrError").makeError("ebls_not_initialized")}o(a,"ebls_upload_start");var m;try{m=await b.runInTransaction(async function(b){o(a,"ebls_lsdb_write_start");var c=await Promise.all(a.map(function(a){var c=a.protoMsg,e=a.threadId,f=a.uploadTrackingInstanceKey;if(c==null)return null;f=f!=null?d("MAWEBUploadTrackingUtils").makeEBWorkerQplFlowFromInstanceKey(f):null;c=c.backupActionType===1?Promise.all([d("EncryptedBackupsWriteToMPSTables").writeToMPSTables(b,c,e,!1,f),d("EncryptedBackupsWriteToMPSTables").writeTagsToMPSTables(b,c,e)]).then(function(a){var b=a[0];a[1];return b}):d("EncryptedBackupsWriteToMPSTables").writeToMPSTables(b,c,e,!1,f);return c.then(function(b){if(!b.success){a.uploadTrackingInstanceKey!=null&&d("MAWEBUploadTrackingUtils").endFailWorkerOnly(a.uploadTrackingInstanceKey,"mps_write_failed",{string:{error:b.error}});return null}return a})}).filter(Boolean)).then(function(a){return a.filter(Boolean)});o(a,"ebls_mps_write_complete");return d("MAWUploadPayloadGenerator").genUploadPayload(b,c,"worker").then(function(a){return a.map(function(a){if(!a.success){var b=a.error,c=b.error;b=b.instanceKey;b!=null&&d("MAWEBUploadTrackingUtils").endFailWorkerOnly(b,"ebls_payload_generation_failed",{string:{error:c}});return null}return a.value}).filter(Boolean)})},"readwrite",void 0,void 0,f.id+":244"),o(a,"ebls_upload_payload_generated")}catch(b){h=d("WAErrorMessage").maybeGetMessageFromError(b);p(a,"ebls_upload_failed_payload",{string:{error:h}});d("WALogger").ERROR(l(),h);return d("WAResultOrError").makeError("upload_serialization_failure")}if(m.length===0){p(a,"ebls_upload_payload_empty");return d("WAResultOrError").makeResult()}g=m.map(function(a){return a.msg});g.forEach(function(b){var a=b.echoDocument!=null?"dual_upload":"protobuf_only";d("MAWEBFalcoLoggerUtils").logEBFalcoTaskIssued(b,a)});e=c("createWorkerMutation")(n);b=e[0];h=await b({input:{app_id_str:d("MAWCurrentUser").getAppID(),payload:{msg_payloads:m.map(function(a){return a.payload}).filter(Boolean)}}});o(g,"ebls_received_gql_upload_response");if(h==null){p(g,"ebls_upload_failed_response_null");d("WALogger").ERROR(k());g.forEach(function(a){var b=a.echoDocument!=null?"dual_upload":"protobuf_only";d("MAWEBFalcoLoggerUtils").logEBFalcoTaskFailure(a,b,"ebls_not_initialized")});return d("WAResultOrError").makeError("gql_upload_null_response")}b=(e=h.xfb_upload_encrypted_msg_to_backup)!=null?e:{};h=b.backup_write_result_response;e=b.device_epoch_status;b=b.exception_string;var r=await q({backupWriteResult:h,deviceEpochStatus:e,exception_string:b,inputMessages:g});!r.success?g.forEach(function(a){var b=a.echoDocument!=null?"dual_upload":"protobuf_only";d("MAWEBFalcoLoggerUtils").logEBFalcoTaskFailure(a,b,r.error)}):g.forEach(function(a){d("MAWEBFalcoLoggerUtils").logEBFalcoEncryptedBackupUploadSuccess(a)});return r}catch(b){h=d("WAErrorMessage").maybeGetMessageFromError(b);p(a,"ebls_upload_failed_response",{string:{error:h}});a.forEach(function(a){var b=a.echoDocument!=null?"dual_upload":"protobuf_only";d("MAWEBFalcoLoggerUtils").logEBFalcoTaskFailure(a,b,"ebls_not_initialized")});d("WALogger").ERROR(j(),b);return d("WAResultOrError").makeError("gql_upload_runtime_error")}}g.uploadMessagesFromWorker=a}),98);
__d("EncryptedBackupTaskIssuedFalcoEventDeferred",["requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h=c("requireDeferred")("EncryptedBackupTaskIssuedFalcoEvent").__setRef("EncryptedBackupTaskIssuedFalcoEventDeferred");function a(a){return h.load().then(function(b){return b.log(a)})}g.log=a}),98);
__d("EncryptedBackupTaskSkippedFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("5727");b=d("FalcoLoggerInternal").create("encrypted_backup_task_skipped",a);e=b;g["default"]=e}),98);
__d("ReverbWriteFailureFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("5829");b=d("FalcoLoggerInternal").create("reverb_write_failure",a);e=b;g["default"]=e}),98);
__d("ReverbWriteSuccessFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("5831");b=d("FalcoLoggerInternal").create("reverb_write_success",a);e=b;g["default"]=e}),98);