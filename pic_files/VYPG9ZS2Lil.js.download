;/*FB_PKG_DELIM*/

__d("EBFormatUtils",["I64","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b){if(a!=null)return(h||(h=d("I64"))).min(a,h.of_float(d("WATimeUtils").millisTime()));switch(b){case"before":return(h||(h=d("I64"))).of_float(d("WATimeUtils").millisTime());case"after":return(h||(h=d("I64"))).zero;default:b;return(h||(h=d("I64"))).max_int}}function b(a,b){switch(b){case"before":return[a,0];case"after":return[0,a];default:b;return[Math.ceil(a/2),Math.ceil(a/2)]}}g.adjustTs=a;g.adjustCount=b}),98);
__d("EntMessageReplyType",[],(function(a,b,c,d,e,f){a=Object.freeze({REGULAR:0,BUMP:1});f["default"]=a}),66);
__d("LSOnSendMessageFailure.nop",["MWChatInteraction","Promise","err","justknobx","promiseDone","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i=c("requireDeferred")("sendToSentQPLLogger").__setRef("LSOnSendMessageFailure.nop");function a(a,d,e,f){if(!c("justknobx")._("1414"))return(h||(h=b("Promise"))).resolve();if(e==null)return(h||(h=b("Promise"))).resolve();var g=j(e);if(g==null)return(h||(h=b("Promise"))).resolve();c("promiseDone")(i.load().then(function(a){return a.markSendToSentFail(g,"send_message_server_error",c("err")("send_message_server_error: %s",f))}));return(h||(h=b("Promise"))).resolve()}function j(a){a=d("MWChatInteraction").get(d("MWChatInteraction").s2sKey(a));return a==null?null:Number(a)}a.__nop_name__="LSOnSendMessageFailure";g["default"]=a}),98);
__d("LSMarkOptimisticMessageFailed",["LSOnSendMessageFailure.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(e){return a[2]===!0?d[0]=c.i64.cast([0,5]):d[0]=c.i64.cast([0,4]),a[2]===!0?d[1]=c.i64.cast([0,5]):d[1]=c.i64.cast([0,4]),a[2]===!0?d[2]=c.i64.cast([0,5]):d[2]=c.i64.cast([0,4]),c.nativeOperation(b("LSOnSendMessageFailure.nop"),a[0],a[1])},function(b){return c.forEach(c.filter(c.db.table(12).fetch([[[a[0]]],"optimistic"]),function(b){return b.offlineThreadingId===a[0]&&c.i64.eq(b.authorityLevel,c.i64.cast([0,20]))}),function(a){var b=a.update;a.item;return b({sendStatus:d[0],sendStatusV2:d[1]})})}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSMailboxMarkOptimisticMessageFailedStoredProcedure";a.__tables__=["messages"];e.exports=a}),null);
__d("LSMarkOptimisticMessageFailedStoredProcedure",["LSMarkOptimisticMessageFailed","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSMarkOptimisticMessageFailed"),e.optimisticMid,e.errorMessage,e.isRetryable);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("LSMediaUrlUtils",["I64","ServerTime"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){if((h||(h=d("I64"))).gt(a,(h||(h=d("I64"))).zero)){var b=(h||(h=d("I64"))).of_float(d("ServerTime").getMillis()/1e3);return h.lt(a,b)}return!1}function i(a){if((h||(h=d("I64"))).gt(a,(h||(h=d("I64"))).zero)){var b=(h||(h=d("I64"))).of_float(d("ServerTime").getMillis());return h.lt(a,b)}return!1}function b(a,b){return a!=null&&b!=null&&!i(b)}g.isTimestampExpired=a;g.isTimestampExpiredForMillis=i;g.hasValidReceiverFetchPreviewUrl=b}),98);
__d("LSMessageReplySourceType",[],(function(a,b,c,d,e,f){a=Object.freeze({NONE:0,MESSAGE:1,STORY:2,FORWARD:3,FB_STORY_SHARE:4,IG_STORY_SHARE:5,LIGHTWEIGHT_STATUS:6,LIGHTWEIGHT_STATUS_REACTION:7,FB_FEED_POST:13,HIGHLIGHTS_TAB_POST_REPLY:14,HIGHLIGHTS_TAB_LOCAL_EVENT_REPLY:15,SHARED_ALBUM:16,AVATAR_DETAIL:17,NOTE_REPLY_ARMADILLO:18,HIGHLIGHTS_TAB_CARDS_FOR_MOM:19,HIGHLIGHTS_TAB_CARDS_FOR_BIRTHDAY:20,NOTE_MENTION:21,AI_PERSONA_NOTE_REPLY:26});f["default"]=a}),66);
__d("LSMessageSearchType",[],(function(a,b,c,d,e,f){a=Object.freeze({THREAD:1,MESSAGE:2});f["default"]=a}),66);
__d("LSThreadAttributionTypeUtil",["I64","LSIntEnum","LSMessagingThreadAttributionType","LSThreadAttributionStore"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(a,b){b=d("LSThreadAttributionStore").getSourceWithoutReset({type:"MWLSEntrypoint",value:b},(h||(h=d("I64"))).to_string(a));return j(b)}function b(a,b){b=d("LSThreadAttributionStore").getSourceAndResetAttribution({type:"MWLSEntrypoint",value:b},(h||(h=d("I64"))).to_string(a));return j(b)}function j(a){if(a.type==="LSThreadAttribution")return a.value;a=a.value;if(a==="inboxPendingRequests")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").MESSENGER_INBOX_PENDING_REQUESTS);else if(a==="fullscreenChat")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").MESSENGER_COMMUNITY_MESSAGING_FULLSCREEN_CHAT);else if(a==="sidebarGroupsList")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").SIDEBAR_CONTACTS_GROUPS);else if(a==="jewel")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").JEWEL_THREAD_LIST);else if(a==="shop")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").MINI_SHOP_VIEW_MENU_BUTTON);else if(a==="chatheadsOverflow")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").CHATHEADS_OVERFLOW);else if(a==="hovercard"||a==="feedDynamicHoverCard")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").FB_FEED_DYNAMIC_HOVER_CARD);else if(a==="search"||a==="messengerUniversalSearch")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").MESSENGER_UNIVERSAL_SEARCH);else if(a==="story"||a==="storyAggregatedUsers"||a==="storySeenByList")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").FB_STORY);else if(a==="timeline"||a==="feedOrganicPost")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").FB_FEED_ORGANIC_POST);else if(a==="pageAboutCard")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").FB_PAGE_ABOUT_CARD);else if(a==="inboxInThread")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").MESSENGER_INBOX_IN_THREAD);else if(a==="notificationInThreadReply")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").MESSENGER_NOTIFICATION_IN_THREAD_REPLY);else if(a==="archieve")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").MESSENGER_ARCHIVED_THREADS);else if(a==="storyViewerSheetRow")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").FB_STORY_VIEWER_SHEET_ROW);else if(a==="chatheadsNewMessage")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").CHATHEADS_NEW_MESSAGE);else if(a==="event")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").FB_EVENT);else if(a==="jewelSearch")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").JEWEL_SEARCH);else if(a==="inboxSpam"||a==="inboxThreadList"||a==="inboxRestricted")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").MESSENGER_INBOX);else if(a==="jewelNewMessage")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").JEWEL_NEW_MESSAGE);else if(a==="pendingRequests")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").MESSENGER_PENDING_REQUESTS_INBOX_THREAD_LIST);else if(a==="sidebarSearch")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").SIDEBAR_CONTACTS_SEARCH);else if(a==="inboxRemainingThreads")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").MESSENGER_INBOX_REMAINING_THREADS);else if(a==="pagesHeader")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").FB_PAGE_PROFILE_HEADER_MESSAGE_BUTTON);else if(a==="inboxRecentThreads")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").MESSENGER_INBOX_RECENT_THREADS);else if(a==="chatheads")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").CHATHEADS);else if(a==="pageResponsivenessCard")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").FB_PAGE_RESPONSIVENESS_CONTEXT_CARD);else if(a==="inboxSearch")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").MESSENGER_INBOX_MESSAGE_SEARCH);else if(a==="jewelNestedFolder")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").JEWEL_NESTED_FOLDER);else if(a==="marketplace")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").MARKETPLACE_SEND_MESSAGE);else if(a==="feedOrganicPostViewAndMessage")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").FB_FEED_ORGANIC_POST_VIEW_AND_MESSAGE);else if(a==="adsCta")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").CLICK_TO_MESSENGER_AD_SEND_MESSAGE_CTA);else if(a==="chatInThread")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").MESSENGER_CHAT_IN_THREAD);else if(a==="payments")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").PAYMENTS);else if(a==="inboxFolder")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").MESSENGER_INBOX_NESTED_FOLDER);else if(a==="inboxArchived")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").MESSENGER_INBOX_ARCHIVED_THREADS);else if(a==="inboxActiveContacts")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").MESSENGER_INBOX_ACTIVE_CONTACTS);else if(a==="sidebarContactsList")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").SIDEBAR_CONTACTS_LIST);else if(a==="sidebarCommunityChatsList")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").SIDEBAR_CONTACTS_COMMUNITY_CHATS);else if(a==="igdChatTabsThreadView")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").IGD_WEB_CHAT_TAB_IN_THREAD);else if(a==="inboxTrayActiveNow")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").MONTAGE_AND_ACTIVE_NOW_ACTIVE_NOW);else if(a==="communityFriendsDialog")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").MESSENGER_COMMUNITY_MESSAGING_COMMUNITY_FRIENDS_DIALOG);else if(a==="pagesHomeFriendsDialog")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").FB_PAGE_PAGES_HOME_FRIENDS_DIALOG);else if(a==="mutualFriendsDialog")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").FB_PROFILE_MUTUAL_FRIENDS_DIALOG);else if(a==="birthday")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").FB_BIRTHDAY_CENTER);else if(a==="groupMembers")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").FB_GROUPS_MEMBER_LIST);else if(a==="fundraiserSupportersList")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").FUNDRAISER_SUPPORTERS_LIST);else if(a==="memories")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").MEMORIES);else if(a==="feedPoll")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").FB_FEED_FEED_POLL);else if(a==="reactorList")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").FB_FEED_REACTORS_LIST_MESSAGE_BUTTON);else if(a==="friendsList")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").FRIENDS_HOME);else if(a==="pagesPrivateReply")return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").FB_PAGE_PAGES_PRIVATE_REPLY);else return(i||(i=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").UNKNOWN)}g.getSourceWithoutReset=a;g.getSourceAndResetAttribution=b}),98);
__d("MAWDeanonDataCheck",["gkx"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,d){if(!c("gkx")("8338")){var e=b;d||(e=b+1);return a.length>=e}if(a.length===0)return!1;var f=a[a.length-1].sortOrderMs;e=a.filter(function(a){return a.sortOrderMs===f});e=a.length-e.length;if(!d){var g=a[0].sortOrderMs;d=a.filter(function(a){return a.sortOrderMs===g});e-=d.length}return e>=b}g.hasEnoughDeanonData=a}),98);
__d("MAWEBMsgsWithSameSortOrderFix",["MAWMessagesCompare","MAWMessagesDirection","qex"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){if(b==null)return a;b=(b=c("qex")._("23"))!=null?b:0;return a+b}function b(a){var b=a.direction,d=a.ebFetchResult,e=a.msgCount;a=a.referenceExternalId;if(!c("qex")._("18"))return d;e=h({direction:b,includeReferenceExternalId:!0,msgCount:e,referenceExternalId:a,sourceMsgs:[].concat(d.messages)});return babelHelpers["extends"]({},d,{hasMoreAfter:l({ebFetchResult:d,fetchDirection:b,fixedMessages:e,hasMoreDirection:"after"}),hasMoreBefore:l({ebFetchResult:d,fetchDirection:b,fixedMessages:e,hasMoreDirection:"before"}),messages:e})}function h(a){var b=a.direction,e=a.includeReferenceExternalId,f=a.msgCount,g=a.referenceExternalId;a=a.sourceMsgs;if(!c("qex")._("18"))return a;var h=k(a,b),l=d("MAWMessagesCompare").getSortComparisonFunctionForDirection(h);a=a.toSorted(l);l=a.findIndex(function(a){return a.externalId===g});if(m({fetchDirection:b,msgsDirection:h})){l=i({includeReferenceExternalId:e,referenceMsgIndex:l});return a.slice(l,l+f)}else{l=j({includeReferenceExternalId:e,msgsCount:a.length,referenceMsgIndex:l});b=Math.max(0,l-f+1);return a.slice(b,l+1)}}function i(a){var b=a.includeReferenceExternalId;a=a.referenceMsgIndex;return a===-1?0:b?a:a+1}function j(a){var b=a.includeReferenceExternalId,c=a.msgsCount;a=a.referenceMsgIndex;return a===-1?c-1:b?a:a-1}function k(a,b){var c;c=(c=a.find(function(a){return a.sortOrderMs!=null}))==null?void 0:c.sortOrderMs;a=(a=a.findLast(function(a){return a.sortOrderMs!=null}))==null?void 0:a.sortOrderMs;return c==null||a==null?d("MAWMessagesDirection").translateMawDirectionToMwpDirection(b):c>=a?"desc":"asc"}function l(a){var b=a.ebFetchResult,c=a.fetchDirection,e=a.fixedMessages;a=a.hasMoreDirection;if(c!==a||b.messages.length===0)return d("MAWMessagesDirection").switchOnMAWMessagesDirection(a,{after:b.hasMoreAfter,before:b.hasMoreBefore});if(e.length===0)return!0;var f=k(b.messages,c),g=d("MAWMessagesCompare").getSortComparisonFunctionForDirection(f);g=b.messages.toSorted(g);m({fetchDirection:c,msgsDirection:f})?(c=g[0],f=e[0]):(c=g[g.length-1],f=e[e.length-1]);return c.externalId===f.externalId?d("MAWMessagesDirection").switchOnMAWMessagesDirection(a,{after:b.hasMoreAfter,before:b.hasMoreBefore}):!0}function m(a){var b=a.fetchDirection;a=a.msgsDirection;return b==="before"&&a==="desc"||b==="after"&&a==="asc"}g.overFetchEBMsgsIfNeeded=a;g.fixEBFetchResultPagination=b;g.fixEBMessagesPagination=h}),98);
__d("MAWEBDeanonFetch",["EBMessageMetadataQuery","FBLogger","MAWEBMsgsWithSameSortOrderFix","WAJids","WAResultOrError","getErrorSafe"],(function(a,b,c,d,e,f,g){"use strict";async function a(a){var b=a.chatJid,e=a.count,f=a.direction,g=a.includeReferenceTimestamp,h=a.referenceExternalId,i=a.referenceTimestampMs;a=a.sortFn;try{var j=d("MAWEBMsgsWithSameSortOrderFix").overFetchEBMsgsIfNeeded(e,h);j=await d("EBMessageMetadataQuery").messageMetadataQueryForMainThreadMAWDeanon({direction:f,includeAnonymizedMessages:!1,numberOfMessages:j,referenceTimestamp:i,threadId:d("WAJids").threadIdForChatJid(b)});if(j.success===!1)return d("WAResultOrError").DEPRECATED_makeError("error",j.payload);b=j.value.messages;j=b.reduce(function(a,b){var c=b.offlineThreadingId;b=b.sortOrderMs;if(c==null||b==null)return a;b=Number(b);if(g!==!0&&b===i)return a;a.push({externalId:c,msgType:"unknown-deanon",sortOrderMs:b});return a},[]);b=d("MAWEBMsgsWithSameSortOrderFix").fixEBMessagesPagination({direction:f,includeReferenceExternalId:g,msgCount:e,referenceExternalId:h,sourceMsgs:j});f=a==null?b:b.sort(a);return d("WAResultOrError").makeResult(f)}catch(a){e=c("getErrorSafe")(a);c("FBLogger")("messenger_web_missing_messages").catching(e).mustfix("Deanon GraphQL fails with error");return d("WAResultOrError").DEPRECATED_makeError("request-error",e)}}g.fetchMessagesMetadataFromEBDeanon=a}),98);
__d("MAWFetchExternalIdUsingCache",["FBLogger","LSDatabaseSingleton","MAWBridgeSendAndReceive","MAWDbMsg","WAStanzaUtils"],(function(a,b,c,d,e,f,g){"use strict";var h,i=new Map();async function a(a){if(a==="")return null;var b=k(a);if(b!=null)return b;b=await j(a);if(b!=null){l(a,b);return b}try{b=d("MAWDbMsg").toMsgId(a);if(b==null){c("FBLogger")("messenger_web").warn("[MAWFetchProtocolMessageIdUsingCache] failed fetch external id, invalid msgId %s",a);return null}b=await d("MAWBridgeSendAndReceive").sendAndReceive("backend","getProtocolMsgIdByMsgId",{msgId:b});if((b==null?void 0:b.externalId)==null){c("FBLogger")("messenger_web").warn("[MAWFetchProtocolMessageIdUsingCache] external id for msgId %s not found",a);return null}l(a,b.externalId);return b.externalId}catch(a){c("FBLogger")("messenger_web").catching(a).mustfix("[MAWFetchProtocolMessageIdUsingCache] getProtocolMsgIdByMsgId bridge call failed");throw a}}async function j(a){var b=await (h||(h=d("LSDatabaseSingleton"))).LSDatabaseSingleton;b=await b.tables.messages.index("messageId").get(a);return b!=null?d("WAStanzaUtils").toStanzaId(b.offlineThreadingId):null}function k(a){return i.get(a)}function l(a,b){if(a==="")return!1;i.set(a,b);return!0}g.fetchExternalIdUsingCache=a;g.populateExternalIdCache=l}),98);
__d("MAWMessagesPaginationUtils",["FBLogger","MAWFetchExternalIdUsingCache","MAWMessagesDirection","WAStanzaUtils","qex"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){a=d("MAWMessagesDirection").getRangeMsgIdForDirection(a,b);return h(a)}function b(a){c("qex")._("18")&&a.forEach(function(a){return d("MAWFetchExternalIdUsingCache").populateExternalIdCache(a.msgId.toString(),d("WAStanzaUtils").toStanzaId(a.externalId))})}async function h(a){if(a==null||a==="")return null;if(!c("qex")._("18"))return null;var b=await d("MAWFetchExternalIdUsingCache").fetchExternalIdUsingCache(a);b==null&&c("FBLogger")("messenger_web").mustfix("[MAWMessagesPaginationUtils] getExternalIdByMsgId for msgId: %s returned null",a);return b}function e(a,b,c){if(a===b)return Promise.resolve(c);else return i(b)}async function i(a){if(!c("qex")._("18"))return{maxExternalId:null,minExternalId:null};var b=await h(a.minMessageId);a=await h(a.maxMessageId);return{maxExternalId:a==null?void 0:a.toString(),minExternalId:b==null?void 0:b.toString()}}g.getRangeExternalIdForDirection=a;g.populateExternalIdCache=b;g.getExternalIdByMsgId=h;g.getMessagesRangesV2ExternalIdsIfChanged=e;g.getMessagesRangesV2ExternalIds=i}),98);
__d("MAWFetchEBDeanonMessagesMetadata",["DateConsts","EBFormatUtils","FBLogger","I64","MAWEBDeanonFetch","MAWMessagesDirection","MAWMessagesPaginationUtils","WAResultOrError","qex"],(function(a,b,c,d,e,f,g){"use strict";var h,i=100,j="timeout",k=10*d("DateConsts").MS_PER_SEC;async function a(a){var b=a.chatJid,e=a.direction,f=a.includeReferenceTimestamp,g=a.logger,l=a.range;a=a.sortFn;c("FBLogger")("messenger_web").info("EBMessageRangeDataSource: Issuing fetch request to EB Deanon API");g==null?void 0:g.markQPLPoint("eb_fetch_deanon_start");var m=d("MAWMessagesDirection").translateMwpDirectionToMawDirection(e),n=(h||(h=d("I64"))).to_float(d("EBFormatUtils").adjustTs(d("MAWMessagesDirection").getI64RangeTimestampForDirection(e,l),m));e=await d("MAWMessagesPaginationUtils").getRangeExternalIdForDirection(e,l);l=(l=c("qex")._("3653"))!=null?l:i;return Promise.race([d("MAWEBDeanonFetch").fetchMessagesMetadataFromEBDeanon({chatJid:b,count:l,direction:m,includeReferenceTimestamp:f,referenceExternalId:e,referenceTimestampMs:n,sortFn:a}),new Promise(function(a){return window.setTimeout(function(){return a(d("WAResultOrError").makeError(j))},k)})]).then(function(a){g==null?void 0:g.markQPLPoint("eb_fetch_deanon_end");return a})}g.fetchEBDeanonMessagesMetadata=a}),98);
__d("MAWSubscribeToLSTruncateMetadataThreads",["I64","Int64Hooks","MAWMiActMappingTableAPI","gkx","promiseDone","react-compiler-runtime","useAsyncReStore"],(function(a,b,c,d,e,f,g){"use strict";var h,i=function(a,b){return!c("gkx")("9855")?function(){}:d("MAWMiActMappingTableAPI").subscribeToMappingDeletion(a,b)};function a(a,b){var e=d("react-compiler-runtime").c(5),f=c("useAsyncReStore")(),g,k;e[0]!==f||e[1]!==b||e[2]!==a?(g=function(){if(!c("gkx")("9855"))return;var e=f.then(function(c){return i(c,function(c,e){(h||(h=d("I64"))).equal(e,a)&&b()})});return function(){c("promiseDone")(e,j)}},k=[a,f,b],e[0]=f,e[1]=b,e[2]=a,e[3]=g,e[4]=k):(g=e[3],k=e[4]);d("Int64Hooks").useEffectInt64(g,k)}function j(a){return a()}g.subscribeToLSTruncateMetadataThreads=i;g.useLSTruncateMetadataThread=a}),98);
__d("MAWFetchDeanonMetadataUsingCache",["I64","MAWDeanonDataCheck","MAWFetchEBDeanonMessagesMetadata","MAWMessagesCompare","MAWMessagesDirection","MAWSubscribeToLSTruncateMetadataThreads","WAJids","WAResultOrError","WATagsLogger","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Using init-sync deanon data for ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Using cached Deanon messages metadata for comparison to local data"]);j=function(){return a};return a}var k=d("WATagsLogger").TAGS(["MAWFetchDeanonMetadataUsingCache"]),l=new Map(),m=c("justknobx")._("3763"),n=new Map(),o=null;async function a(a){var b=a.chatJid,c=a.db,e=a.direction,f=a.isFirstPage,g=a.logger,h=a.pageSize,i=a.range;a=a.sortFn;q(c);c=p(b,e,g,i);if(c!=null){g==null?void 0:g.addQPLAnnotations({bool:{is_first_page:f},int:{deanon_cached_data_size:c==null?void 0:c.length}});if(d("MAWDeanonDataCheck").hasEnoughDeanonData(c,h,f)){k.LOG(j());g==null?void 0:g.addQPLAnnotations({bool:{is_deanon_cached_data_used:!0}});return d("WAResultOrError").makeResult(c)}}h=await d("MAWFetchEBDeanonMessagesMetadata").fetchEBDeanonMessagesMetadata({chatJid:b,direction:e,includeReferenceTimestamp:!f,logger:g,range:i,sortFn:a});h.success===!0&&(g==null?void 0:g.addQPLAnnotations({bool:{is_deanon_data_fetched:!0}}),s(b,e,g,h.value,i));return h}function p(a,b,c,e){c==null?void 0:c.markQPLPoint("deanon_cache_fetch_start");t(a,b);a=(a=l.get(d("WAJids").threadIdForChatJid(a)))==null?void 0:a.get(b);if(a==null)return null;var f=d("MAWMessagesDirection").getI64RangeTimestampForDirection(b,e);e=(h||(h=d("I64"))).ge(f,a.minTimestampMs)&&(h||(h=d("I64"))).le(f,a.maxTimestampMs);if(!e)return null;e=d("MAWMessagesDirection").switchOnMWPMessagesDirection(b,{asc:a.msgsMetadata.findIndex(function(a){return(h||(h=d("I64"))).ge(h.of_float(a.sortOrderMs),f)}),desc:a.msgsMetadata.findIndex(function(a){return(h||(h=d("I64"))).le(h.of_float(a.sortOrderMs),f)})});b=a.msgsMetadata.slice(e);c==null?void 0:c.markQPLPoint("deanon_cache_fetch_end");return b}function q(a){if(o!=null)return;o=d("MAWSubscribeToLSTruncateMetadataThreads").subscribeToLSTruncateMetadataThreads(a,function(a,b){b=(h||(h=d("I64"))).to_string(a);l.delete(b);n.delete(b)})}function r(a,b,c,e){var f;a=d("WAJids").threadIdForChatJid(a);f=(f=l.get(a))!=null?f:new Map();f.set(b,{maxTimestampMs:e.max,minTimestampMs:e.min,msgsMetadata:c});l.set(a,f)}function s(a,b,c,e,f){if(e.length===0)return;c==null?void 0:c.markQPLPoint("deanon_cache_replace_start");var g=(h||(h=d("I64"))).of_float(e[e.length-1].sortOrderMs);f=d("MAWMessagesDirection").switchOnMWPMessagesDirection(b,{asc:{max:g,min:f.maxTimestampMs},desc:{max:f.minTimestampMs,min:g}});r(a,b,e,f);c==null?void 0:c.markQPLPoint("deanon_cache_replace_end")}function b(a,b){if(b.length===0)return;b=[].concat(b).sort(d("MAWMessagesCompare").getSortComparisonFunctionForDirection("desc"));var c=0,e=b.length-1;while(c<e&&b[c].sortOrderMs===b[c+1].sortOrderMs)c++;if(c===e)return;e=(h||(h=d("I64"))).of_float(b[e].sortOrderMs);n.set(h.to_string(a),{insertTime:Date.now(),minTimestampMs:e,msgsMetadata:b.slice(c)})}function t(a,b){var c=u(a,b);if(c==null)return;k.LOG(i(),a);r(a,b,c.msgsMetadata,{max:(h||(h=d("I64"))).max_int,min:c.minTimestampMs});n.delete(d("WAJids").threadIdForChatJid(a))}function u(a,b){if(b!=="desc")return;b=Date.now();a=n.get(d("WAJids").threadIdForChatJid(a));if(a!=null&&b-a.insertTime>m)return;return a}g.MAWFetchDeanonMetadataUsingCache=a;g.fetchDeanonDataFromCache=p;g.initDeanonCacheDescForThread=b}),98);
__d("MAWMarkMessageSendAsFailedLSDB",["LSFactory","LSMarkOptimisticMessageFailedStoredProcedure"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,d,e,g){return(b=e==null?void 0:e.runInTransaction(async function(b){await c("LSMarkOptimisticMessageFailedStoredProcedure")(c("LSFactory")(b),{errorMessage:d,isRetryable:g,optimisticMid:a})},"readwrite",void 0,void 0,f.id+":29"))!=null?b:Promise.resolve()}g.markMessageSendAsFailed=a}),98);
__d("MAWMessageSendReporter",["FBLogger","MAWMarkMessageSendAsFailedLSDB","MAWReportSendMessageSuccessResult","MAWSetupWorkerAuxStateForLogging","MWLogSendToSentFailedError","QPLUserFlow","WAGetSafeQPLError","justknobx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";async function a(a,b,e,f){var g=e.qplEventType;e=e.qplInstanceKey;try{b=await b;if(b==null)return;if(b.success)b.value!=null?d("MAWReportSendMessageSuccessResult").reportSendMessageSuccessResultFn(b.value):c("QPLUserFlow").addPoint(g,"no-op",{instanceKey:e}),c("QPLUserFlow").endSuccess(g,{instanceKey:e});else{var i,j=b.error.isRetriable===!0;c("MWLogSendToSentFailedError")({qplEventType:g,qplInstanceKey:e},b.error.type,void 0,b.error.errorCode,b.error.applicationErrorCode);c("QPLUserFlow").endFailure(g,b.error.type,{annotations:{bool:{isRetriable:(i=b.error.isRetriable)!=null?i:!1,workerTerminatedPermanently:d("MAWSetupWorkerAuxStateForLogging").WorkerLifeCycleState.workerTerminatedPermanently},int:{errorCode:(i=b.error.errorCode)!=null?i:0},string:{details:(i=b.error.details)!=null?i:""},string_array:{worker_restart_msgs:d("MAWSetupWorkerAuxStateForLogging").WorkerLifeCycleState.restartMessageTypes,worker_restart_reasons:d("MAWSetupWorkerAuxStateForLogging").WorkerLifeCycleState.restartReasons}},instanceKey:e});h(a,j,f)}}catch(k){c("MWLogSendToSentFailedError")({qplEventType:g,qplInstanceKey:e},"runtime-failure",k);c("QPLUserFlow").endFailure(g,"runtime-failure",{annotations:{bool:{workerTerminatedPermanently:d("MAWSetupWorkerAuxStateForLogging").WorkerLifeCycleState.workerTerminatedPermanently},string:{errorDescription:d("WAGetSafeQPLError").getSafeQPLErrorMessage(k)},string_array:{worker_restart_msgs:d("MAWSetupWorkerAuxStateForLogging").WorkerLifeCycleState.restartMessageTypes,worker_restart_reasons:d("MAWSetupWorkerAuxStateForLogging").WorkerLifeCycleState.restartReasons}},instanceKey:e});h(a,!1,f,k);c("FBLogger")("messenger_web").catching(k).mustfix("MAWMessageSendReporter");if(c("justknobx")._("4010")&&typeof k==="object"){b=String(k==null?void 0:k.message);i=String(k==null?void 0:k.messageParams);j=String(k==null?void 0:k.stack);c("FBLogger")("messenger_web").mustfix("Failed to send, e: %s. error params: %s. call stack: %s",b,i,j)}}}function h(a,b,e,f){if(a==null)return;var g=a.chatJid;a=a.externalId;c("promiseDone")(d("MAWMarkMessageSendAsFailedLSDB").markMessageSendAsFailed(a,g,d("WAGetSafeQPLError").getSafeQPLErrorMessage(f),e,b))}g.MAWMessageSendReporter=a}),98);
__d("MAWMessageSendReporterUtils",["WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";function a(a){if(!Array.isArray(a))return a.success===!0?d("WAResultOrError").makeResult([a.value]):a;else{var b=[];for(a of a){if((a==null?void 0:a.success)===!1)return a;(a==null?void 0:a.value)!=null&&b.push(a.value)}return d("WAResultOrError").makeResult(b)}}function b(a){for(var b of a)switch(b.messageType){case"sendMsg":case"editMsg":case"reactionMsg":case"revokeMsg":case"bumpMsg":case"sendPoll":case"noteReplyMsg":continue;case"fixMe":return!0;default:b.messageType}return a.length===0}g.maybeCombineMultipleSendResults=a;g.getWasOverallOperationANoOp=b}),98);
__d("MAWMessageSendReporterV2",["FBLogger","LSIntEnum","LSMessagingThreadAttributionType","LSMessagingThreadTypeUtil","LSThreadAttributionTypeUtil","MAWMarkMessageSendAsFailedLSDB","MAWMessageSendReporterUtils","MAWMiActGetMappingWithMawTypes","MAWReportSendMessageSuccessResult","MWMsgMediaTypeLogUtils","MWSharedMsgLogUtils","MWSharedS2SBaseAnnotations","ReQL","WAGetSafeQPLError","mergeDeep","promiseDone","qex","sendToSentQPLLogger"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){var b;a===void 0&&(a="exposure_logging_enabled");switch(a){case"exposure_logging_disabled":return(b=c("qex")._("404"))!=null?b:!1;case"exposure_logging_enabled":return(b=c("qex")._("408"))!=null?b:!1;default:a;return!1}}async function b(a,b,e){var f=a.composerEntrypoint,g=a.extraAnnotations;g=g===void 0?{}:g;var j=a.lsSource,k=a.messageTypeParamsArgs,l=a.s2sInstanceKey,m=a.thread,n=a.externalId,o,p=[],q=await d("MWSharedS2SBaseAnnotations").queryMediaStagingAndGetMessageTypeParams(babelHelpers.extends({},k,{db:e,threadKey:m==null?void 0:m.threadKey}));o=q.messageTypeParams;p=q.mediaStagings;q=d("MWMsgMediaTypeLogUtils").getAttachmentType({hasFile:o.hasFile,hasGif:o.hasGif,hasHotEmoji:o.hasHotEmoji,hasImage:o.hasImage,hasLinks:o.hasLinks,hasShare:o.hasShare,hasSticker:o.hasSticker,hasVideo:o.hasVideo,hasVoiceClip:o.hasVoiceClip,isAttachmentsGrouped:o.isAttachmentsGrouped,numberOfAttachments:o.numberOfAttachments,numberOfGroupedAttachments:o.numberOfGroupedAttachments});l=l!=null?l:d("sendToSentQPLLogger").markSendToSentStart(void 0,q);q=(h||(h=d("LSIntEnum"))).ofNumber(c("LSMessagingThreadAttributionType").UNKNOWN);m!=null?(q=d("LSThreadAttributionTypeUtil").getSourceAndResetAttribution(m.threadKey,j),j=await d("MWSharedMsgLogUtils").getSendToSentAnnotations(m,o,(h||(h=d("LSIntEnum"))).unwrapIntEnum(q),f,n)):(o=d("MWSharedS2SBaseAnnotations").getMessageTypeParams(babelHelpers.extends({},k)),j=await d("MWSharedS2SBaseAnnotations").getSendToSentBaseAnnotations(o,c("LSMessagingThreadAttributionType").UNKNOWN,f,n));m=c("mergeDeep")(j,g);d("sendToSentQPLLogger").addSendToSentAnnotations(l,m);try{k=await b(l,o,p,q);if(k==null)return;f=d("MAWMessageSendReporterUtils").maybeCombineMultipleSendResults(k);if(f.success)d("MAWMessageSendReporterUtils").getWasOverallOperationANoOp(f.value)?(d("sendToSentQPLLogger").markSendToSentPoint(l,"no-op"),d("sendToSentQPLLogger").markSendToSentSuccess(l)):(f.value.forEach(d("MAWReportSendMessageSuccessResult").reportSendMessageSuccessResultFn),d("sendToSentQPLLogger").markSendToSentSuccess(l));else{n=f.error.isRetriable===!0;d("sendToSentQPLLogger").addSendToSentAnnotations(l,{bool:{isRetriable:(j=f.error.isRetriable)!=null?j:!1},int:{errorCode:(g=f.error.errorCode)!=null?g:0},string:{details:(m=f.error.details)!=null?m:""}});d("sendToSentQPLLogger").markSendToSentFail(l,"runtime-failure",void 0,f.error);i(a,n,e)}}catch(b){d("sendToSentQPLLogger").markSendToSentFail(l,"runtime-failure",b),i(a,!1,e,b),c("FBLogger")("messenger_web").catching(b).mustfix("MAWMessageSendReporterV2")}}function i(a,b,e,f){if(e==null)return;var g=a.externalId,h=a.thread;if(h==null||g==null)return;c("promiseDone")(d("ReQL").firstAsync(d("ReQL").fromTableAscending(e.tables.mi_act_mapping_table).getKeyRange(h.threadKey)),async function(a){if(a!=null){a=c("MAWMiActGetMappingWithMawTypes")(a,d("LSMessagingThreadTypeUtil").isGroup(h.threadType));a=a.jid;await d("MAWMarkMessageSendAsFailedLSDB").markMessageSendAsFailed(g,a,d("WAGetSafeQPLError").getSafeQPLErrorMessage(f),e,b)}})}g.isMessageSendReporterV2Enabled=a;g.MAWMessageSendReporterV2=b}),98);
__d("MAWMiActOnActThreadReadyWithoutValidator",["I64","MAWMiActGetThreadLifecycleState","MAWMiActOnActThreadReadyInstrumentation","MAWMiActOnActThreadReadyQueue","MAWMiActThreadLifecycleState","MWFBLogger","emptyFunction","err"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[MiActMapping] Enqueue by thread key: ",", threadState: ",", threadKey: "," on act thread ready"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[MiActMapping] Executing thread action: ",", threadState: ",", threadKey: "," on act thread ready"]);j=function(){return a};return a}var k=d("MWFBLogger").MWLogger.tags(["Occam","MiActMapping"]);async function l(a,b,e,f,g,l){var m=d("MAWMiActOnActThreadReadyInstrumentation").getOnActThreadReadyInstanceKey(e);d("MAWMiActOnActThreadReadyInstrumentation").startQPL(m,e,b,"onActThreadReady");d("MAWMiActOnActThreadReadyInstrumentation").addPointQPL(m,"get_thread_lifecycle_state_by_thread_key_start");l=l||await d("MAWMiActGetThreadLifecycleState").getThreadLifecycleStateByThreadKey(a,b,e);d("MAWMiActOnActThreadReadyInstrumentation").addPointQPL(m,"get_thread_lifecycle_state_by_thread_key_end");d("MAWMiActOnActThreadReadyInstrumentation").addAnnotationsQPL(m,{string:{threadState:l.type}});switch(l.type){case d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.MI_AND_ACT_THREAD_COMPLETE:case d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.OPTIMISTIC_THREAD_WITH_ACT:case d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.CLIENT_PARTIAL_MI_THREAD_WITH_ACT:k.DEBUG(j(),e,l.type,(h||(h=d("I64"))).to_string(b));d("MAWMiActOnActThreadReadyInstrumentation").endSuccessQPL(m);return f(b,l.jid);case d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.THREAD_KEY_ONLY:case d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.AUTHORITATIVE_THREAD_MISSING_MAPPING_ROW:case d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.OPTIMISTIC_THREAD_NO_ACT:case d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.AUTHORITATIVE_THREAD_ONLY:case d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.CLIENT_PARTIAL_MI_THREAD:case d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.SERVER_PARTIAL_MI_THREAD:k.DEBUG(i(),e,l.type,(h||(h=d("I64"))).to_string(b));return d("MAWMiActOnActThreadReadyQueue").enqueueByThreadKey(b,f,g!=null?g:c("emptyFunction"),e,l.type,m);case d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.JID_MISSING_MI_THREAD:case d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.JID_MISSING_MAPPING_ROW:d("MAWMiActOnActThreadReadyInstrumentation").endFailureQPL(m,"jid_missing_mi_or_mapping_state");throw k.mustfixThrow("Unhandled onActThreadReady for threadKey:%s, thread action: %s",(h||(h=d("I64"))).to_string(b),e);default:l.type;throw k.mustfixThrow(" Unreachable miActThreadState.type: %s",l.type)}}function a(a,b,d){return new Promise(function(e,f){l(a,b,d,function(a,b){e({chatJid:b,serverThreadKey:a});return Promise.resolve()},function(a){return f(c("err")("Timed out waiting for ACT thread to be ready in %s. Thread state: %s",d,a))}).catch(function(){return f()})})}g.onActThreadReadyWithoutValidator=l;g.waitForACTThreadReadyWithoutValidator=a}),98);
__d("MAWMiActOnActThreadReady",["MAWMIC","MAWMiActGetThreadLifecycleState","MAWMiActOnActThreadReadyWithoutValidator","cr:7542","err","promiseDone","sendToSentQPLLogger"],(function(a,b,c,d,e,f,g){"use strict";async function h(a,c,e,f,g){var h=await d("MAWMiActGetThreadLifecycleState").getThreadLifecycleStateByThreadKey(a,c,e),i=h.type,j=async function(d,g){b("cr:7542")&&await b("cr:7542").load().then(function(b){b=b.validateActThreadReady;return b({chatJid:g,description:e,initialMappingStateType:i,tables:a,threadKey:c})});return f==null?void 0:f(d,g)};return d("MAWMiActOnActThreadReadyWithoutValidator").onActThreadReadyWithoutValidator(a,c,e,j,g,h)}function a(a,b,e,f){return new Promise(function(g,i){h(a,b,e,function(a,b){g({chatJid:b,serverThreadKey:a});return Promise.resolve()},function(a){i(c("err")("Timed out waiting for ACT thread to be ready in %s. Thread state: %s",e,a)),c("promiseDone")(d("MAWMIC").getState().then(function(a){f!=null&&d("sendToSentQPLLogger").addSendToSentAnnotations(f,{string:{mic_state:a}})}))}).catch(function(){return i()})})}g.onActThreadReady=h;g.waitForACTThreadReady=a}),98);
__d("MWLSContactTypeExactUtils",["I64","LSContactTypeExact","LSIntEnum"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(a){if((h||(h=d("I64"))).equal(a,(i||(i=d("LSIntEnum"))).ofNumber(c("LSContactTypeExact").IG_USER))||(h||(h=d("I64"))).equal(a,(i||(i=d("LSIntEnum"))).ofNumber(c("LSContactTypeExact").IG_BUSINESS_USER)))return!0;else return(h||(h=d("I64"))).equal(a,(i||(i=d("LSIntEnum"))).ofNumber(c("LSContactTypeExact").IG_CREATOR_USER))}g.isIgContact=a}),98);
__d("MaybeUpdateTargetBasedOnODCutoverOrDefaultE2EEDeferred",["requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";a=c("requireDeferred")("MaybeUpdateTargetBasedOnODCutoverOrDefaultE2EE").__setRef("MaybeUpdateTargetBasedOnODCutoverOrDefaultE2EEDeferred");g["default"]=a}),98);
__d("isMWBumpMessage",["EntMessageReplyType","I64","LSIntEnum"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(a){return a!=null&&(h||(h=d("I64"))).equal(a,(i||(i=d("LSIntEnum"))).ofNumber(c("EntMessageReplyType").BUMP))}g["default"]=a}),98);