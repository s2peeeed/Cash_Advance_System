;/*FB_PKG_DELIM*/

__d("CryptoUtils",["Base64Utils","EncryptedBackupsSymmetricEncryptionUtils","HChaCha20","MEBEncryptionVersion","SymmetricEncryptionCreateEncryptedData","SymmetricEncryptionPaddingUtils","XPlatReactCrypto","XPlatReactTextDecoder","err"],(function(a,b,c,d,e,f,g){"use strict";var h=32,i=2147483647,j="message_key_in_epoch",k="_",l="cipher_version",m="thread",n="message_thread";f="supplemental_enc_aad";var o="kdf_info:mailbox_root_key_v2>supplemental_enc_key";function a(a,b,d,e){var f=d>=c("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_NULL_SALT?null:p(e);a=q(a,d,e);if(a==null)throw c("err")("Error in derive message symmetric key. info is null");return s(a,f,b,[h])}function p(a){try{return new TextEncoder().encode(a).buffer}catch(a){throw c("err")("Error in get blob from string with exception: ",a)}}function q(a,b,c){a=r(a,b,c);return p(a)}function r(a,b,e){if(b>=c("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_NULL_SALT_DF_CANARY||b>=c("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_NULL_SALT)return[j,new(d("XPlatReactTextDecoder").TextDecoder)().decode(a),l,b,m,e!=null?e:""].join(k);else if(b>=c("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_VERSION)return[j,new(d("XPlatReactTextDecoder").TextDecoder)().decode(a),l,b].join(k);else return[j,new(d("XPlatReactTextDecoder").TextDecoder)().decode(a)].join(k)}function s(a,b,e,f){if(f.length<1||f.some(function(a){return a>i}))throw c("err")("Invalid key lengths for derive keys");var g=f.reduce(function(a,b){return a+b},0)*8;return d("XPlatReactCrypto").subtleImportKey("raw",e,"HKDF",!1,["deriveBits"]).then(function(c){return d("XPlatReactCrypto").subtleDeriveBits({hash:"SHA-256",info:a,name:"HKDF",salt:b!=null?b:new Uint8Array(10).buffer},c,g)}).then(function(a){a=new Uint8Array(a);var b=[],c=0;for(var d=0,e=f.length;d<e;++d){var g=c+f[d];b.push(a.slice(c,g).buffer);c=g}return b}).catch(function(a){throw c("err")("Exception in create derived keys",a)})}function b(a,b,e){e=d("Base64Utils").toArrayBuffer(e);return t(a,b,e).then(function(a){return a}).then(function(a){if(a==null)throw c("err")("symmetric string decryption with null result");return new(d("XPlatReactTextDecoder").TextDecoder)().decode(a)}).catch(function(a){throw c("err")("symmetric string decryption failed with error",a)})}function t(a,b,e){if(e.byteLength<d("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes+d("EncryptedBackupsSymmetricEncryptionUtils").aesGcmTagLengthInBytes)throw c("err")("cipher text is invalid");e=new Uint8Array(e);var f=e.slice(0,d("EncryptedBackupsSymmetricEncryptionUtils").totalNonceLengthInBytes),g=new(d("HChaCha20").HChaCha20)(),h=e.slice(d("EncryptedBackupsSymmetricEncryptionUtils").totalNonceLengthInBytes).buffer;e=g.hChaCha20Bytes(f.slice(0,d("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes).buffer,a);return d("XPlatReactCrypto").subtleImportKey("raw",e,"AES-GCM",!1,["decrypt"]).then(function(a){return d("XPlatReactCrypto").subtleDecrypt({additionalData:b,iv:new Uint8Array(f.slice(d("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes).buffer),name:"AES-GCM",tagLength:d("EncryptedBackupsSymmetricEncryptionUtils").aesGcmTagLength},a,h)}).then(function(a){a=d("SymmetricEncryptionPaddingUtils").stripPadding(a);if(a==null)throw c("err")("Failed to strip padding for symmetric decryption");return a}).catch(function(a){throw c("err")("symmetric data decryption failed with error",a)})}async function e(a,b,e){b=await c("SymmetricEncryptionCreateEncryptedData")(b,new TextEncoder().encode([n,e].join(k)).buffer,a);e=b[0];return e!=null?d("Base64Utils").fromArrayBuffer(e):null}g.KEY_LEN=h;g.MAX_INT_32=i;g.STRING_JOIN_SEPARATOR=k;g.MESSAGE_ENCYPTION_AAD=n;g.SUPPLEMENTAL_ENC_AAD=f;g.SUPPLEMENTAL_ENC_KEY_INFO=o;g.deriveMessageSymmetricKey=a;g.getBlobFromString=p;g.createDerivedKeys=s;g.symmetricEncryptionCreateDecryptedString=b;g.encryptThenBase64EncodeBlob=e}),98);
__d("PublicEncryptionCreateEncryptedData",["CryptoLogger","Promise","PublicKeyEncryptionUtils","RetUtil","UInt8Array","XPlatReactCrypto","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i=c("requireDeferred")("PublicKeyCrypto").__setRef("PublicEncryptionCreateEncryptedData"),j=c("requireDeferred")("X25519").__setRef("PublicEncryptionCreateEncryptedData");function k(a,b){if(a.byteLength>32)return b("PSK is too long")}function l(a,c){return new(h||(h=b("Promise")))(function(b,e){d("PublicKeyEncryptionUtils").assertValidCurvePoint(c,e);k(a,e);return b()})}function a(a,c,e,f,g,k){var m=new Uint8Array([1]),n=new Uint8Array(g),o=d("PublicKeyEncryptionUtils").getSalt(f),p=new Uint8Array(a),q=new Uint8Array(c),r=new Uint8Array(e);return(h||(h=b("Promise"))).all([d("PublicKeyEncryptionUtils").assertKeyLength(p),d("PublicKeyEncryptionUtils").assertKeyLength(q),d("PublicKeyEncryptionUtils").assertKeyLength(r)]).then(function(){return l(o,p)}).then(function(){return j.load()}).then(function(a){var c=a.generateKeys(a.KeyPurpose.Encryption),e=c.pk,f=d("PublicKeyEncryptionUtils").concatAad(m,q,p,e,n);e=function(c,d,e){c=a.publicKeyFromBytes(c,a.KeyPurpose.Encryption);d=a.publicKeyFromBytes(d,a.KeyPurpose.Encryption);e=a.secretKeyFromBytes(e,a.KeyPurpose.Encryption);return c==null||d==null||e==null?(h||(h=b("Promise"))).resolve():(h||(h=b("Promise"))).resolve([c,d,e])};return e(p,q,r).then(function(a){return a==null?null:{ephemeralPriv:c.sk,ephemeralPubBytes:c.pk,innerAad:f,receiverPub:a[0],senderPriv:a[2],senderPub:a[1]}})}).then(function(a){if(a==null)return;var b=a.ephemeralPubBytes,c=a.ephemeralPriv,e=a.senderPriv,f=a.receiverPub,g=a.innerAad;return i.load().then(function(a){return a.senderDeriveSharedSecret(e,c,f)}).then(function(a){if(a==null)return;return d("PublicKeyEncryptionUtils").getAesKey(a,o,g,"encrypt")}).then(function(a){if(a==null)return;var b=new Uint8Array(12).buffer;return d("XPlatReactCrypto").subtleEncrypt({additionalData:g,iv:new Uint8Array(b),name:"AES-GCM",tagLength:128},a,k)}).then(function(a){if(a==null)return;a=new Uint8Array(a);return d("UInt8Array").concatBytes([m,b,a]).buffer})}).then(function(a){return(h||(h=b("Promise"))).resolve(d("RetUtil").getNullableRetResult(a))})["catch"](function(a){var c=d("CryptoLogger").CryptoLogger("public_encryption_create_encrypted_data");d("CryptoLogger").captureError(c,a).mustfix("Creation of encrypted data for public encryption failed");return(h||(h=b("Promise"))).resolve(d("RetUtil").getNullableRetResult(void 0))})}g["default"]=a}),98);
__d("EpochUtils",["Base64Utils","CryptoUtils","FBLogger","I64","LSBase64Decode","LSCryptoUtils","PublicEncryptionCreateDecryptedData","PublicEncryptionCreateEncryptedData","XPlatReactTextDecoder"],(function(a,b,c,d,e,f,g){"use strict";var h,i="epoch_chaining",j="epoch_root_key",k="epoch_data_storage",l="epoch_data_metadata",m=18;function a(a){var b=d("LSCryptoUtils").strToBuf("0");if(a==null)return b;if(a.byteLength===0)return b;b=new(d("XPlatReactTextDecoder").TextDecoder)();b=b.decode(a);a=Number.parseInt(b,10);if(Number.isNaN(a))throw c("FBLogger")("messenger_web").mustfixThrow("currentEpochInt is NaN");b=a+1;return d("LSCryptoUtils").strToBuf(b.toString())}async function b(a,b,e){var f,g=[(f=d("CryptoUtils")).KEY_LEN,f.KEY_LEN];f=f.getBlobFromString([i,a,(h||(h=d("I64"))).to_string(b)].join(d("CryptoUtils").STRING_JOIN_SEPARATOR));if(f==null)throw c("FBLogger")("messenger_web").mustfixThrow("infoForEpochChaining is empty");a=await d("CryptoUtils").createDerivedKeys(f,null,e,g);return{epoch_chaining_key:a[0],epoch_distribution_pre_shared_key:a[1]}}async function e(a,b,d,e,f,g){a=await c("PublicEncryptionCreateDecryptedData")(a,b,d,e,n(f),g);return a[0]}async function f(a,b,d,e,f,g){a=await c("PublicEncryptionCreateEncryptedData")(a,b,d,e,n(f),g);return a[0]}function n(a){return new TextEncoder().encode(["epoch_",a].join(d("CryptoUtils").STRING_JOIN_SEPARATOR)).buffer}async function o(a,b,c,e){a=await d("CryptoUtils").createDerivedKeys(a,b,c,e);return a[0]}function p(a,b){var e=d("CryptoUtils").getBlobFromString(j);if(e==null)throw c("FBLogger")("messenger_web").mustfixThrow("epochRootKey is empty");return o(e,a,b,[d("CryptoUtils").KEY_LEN])}function q(a,b){b=new TextEncoder().encode("meb/debug/fingerprint/"+b).buffer;if(b==null)throw c("FBLogger")("messenger_web").mustfixThrow("blob type for which fingerprints are supported is empty");return o(b,null,a,[m])}async function r(a,b,c){var e=[d("CryptoUtils").KEY_LEN];b=d("Base64Utils").fromArrayBuffer(b);a=[a,b].join(d("CryptoUtils").STRING_JOIN_SEPARATOR);b=await d("CryptoUtils").createDerivedKeys(new TextEncoder().encode(a).buffer,null,c,e);return b.length===0?Promise.resolve():b[0]}function s(a){return r(k,a.epochAnonIdBlob,a.epochRootKeyBlob)}async function t(a,b){b=d("Base64Utils").fromArrayBuffer(b);b=await u(b,a,l);if(b==null)throw c("FBLogger")("messenger_web").mustfixThrow("symmetricDecryptAndBase64Decode output is empty while decrypting backward edge");return b}async function u(a,b,e){e=d("LSBase64Decode").decode(e);if(e==null)throw c("FBLogger")("messenger_web").mustfixThrow("aadBuffer is empty");b=await d("CryptoUtils").symmetricEncryptionCreateDecryptedString(b,e,a);if(b==null)throw c("FBLogger")("messenger_web").mustfixThrow("decrypted_string_base64 is empty");return d("LSBase64Decode").decode(b)}g.getNextEpochId=a;g.generateEpochChainingAndDistributionPreSharedKey=b;g.decryptEpochKey=e;g.generateEncryptedEpochKey=f;g.deriveKey=o;g.generateEpochRootKey=p;g.getFingerPrint=q;g.createDerivedKeysForEpoch=r;g.deriveBackwardEdgeKey=s;g.decryptBackwardEdge=t}),98);
__d("LSEpochStatus",[],(function(a,b,c,d,e,f){a=Object.freeze({ES_OPEN:1,ES_CLOSE:2});f["default"]=a}),66);
__d("MEBEpochDerivationResult",[],(function(a,b,c,d,e,f){a=Object.freeze({SUCCESS:0,UNKNOWN_ERROR:1,EDGE_NEITHER_FORWARD_NOR_BACKWARD:2,FORWARD_DECRYPTION_FAILED:3,FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED:4,BACKWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED:5,BACKWARD_DECRYPTION_FAILED:6,MISSING_CLIENT_STATE:7,DEVICE_ID_MISMATCH:8,SOURCE_FINGERPRINT_MISMATCH:9,DEST_FINGERPRINT_MISMATCH:10,STORAGE_KEY_MISMATH:11,PSK_FINGERPRINT_MISMATCH:12,SOURCE_EPOCH_NOT_FOUND:13,FORWARD_EDGE_NOT_CONSECUTIVE:14,BACKWARD_EDGE_NOT_CONSECUTIVE:15,DERIVATION_DEST_EXISTS:16,DERIVATION_DEST_ANON_ID_EXISTS:17});f["default"]=a}),66);
__d("RecordEpochSyncMutation_facebookRelayOperation",[],(function(a,b,c,d,e,f){e.exports="8864236030343819"}),null);
__d("RecordEpochSyncMutation.graphql",["RecordEpochSyncMutation_facebookRelayOperation"],(function(a,b,c,d,e,f){"use strict";a=function(){var a=[{defaultValue:null,kind:"LocalArgument",name:"input"}],c=[{alias:null,args:[{kind:"Variable",name:"request",variableName:"input"}],concreteType:"XFBRecordSyncEpochResponse",kind:"LinkedField",name:"xfb_record_epoch_sync",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"is_success",storageKey:null}],storageKey:null}];return{fragment:{argumentDefinitions:a,kind:"Fragment",metadata:null,name:"RecordEpochSyncMutation",selections:c,type:"Mutation",abstractKey:null},kind:"Request",operation:{argumentDefinitions:a,kind:"Operation",name:"RecordEpochSyncMutation",selections:c},params:{id:b("RecordEpochSyncMutation_facebookRelayOperation"),metadata:{},name:"RecordEpochSyncMutation",operationKind:"mutation",text:null}}}();e.exports=a}),null);
__d("RecordEpochSyncMutation",["FBLogger","RecordEpochSyncMutation.graphql","createWorkerMutation"],(function(a,b,c,d,e,f,g){"use strict";var h,i=h!==void 0?h:h=b("RecordEpochSyncMutation.graphql");function a(a){var b=c("createWorkerMutation")(i);b=b[0];b=b({input:a});if(b==null)throw c("FBLogger")("messenger_web").mustfixThrow("Failed to record epoch sync");return b}g["default"]=a}),98);
__d("DeriveAndStoreEpochs",["Base64Utils","EpochUtils","I64","LSAuthorityLevel","LSBase64Decode","LSEpochStatus","MAWCurrentUser","MEBEpochDerivationResult","MEBEpochSyncReason","ReQL","RecordEpochSyncMutation","WACryptoUtils","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";var h;async function i(a,b,e,f){var g,i=await d("EpochUtils").getNextEpochId(f.epochAnonIdBlob);if(new TextDecoder().decode(i)!==(e==null?void 0:(i=e.to_epoch)==null?void 0:i.epoch_anon_id))return d("WAResultOrError").makeError({errorMessage:"epoch forward edge not consecutive",resultCode:c("MEBEpochDerivationResult").FORWARD_EDGE_NOT_CONSECUTIVE});i=e==null?void 0:(i=e.from_epoch)==null?void 0:i.epoch_id;g=e==null?void 0:(g=e.from_epoch)==null?void 0:g.epoch_anon_id;if(i==null||g==null)return d("WAResultOrError").makeError({errorMessage:"fromEpochId or fromEpochAnonId is null",resultCode:c("MEBEpochDerivationResult").SOURCE_EPOCH_NOT_FOUND});g=await d("EpochUtils").generateEpochChainingAndDistributionPreSharedKey(g,(h||(h=d("I64"))).of_string(i),f.epochRootKeyBlob);i=g.epoch_distribution_pre_shared_key;f=await d("EpochUtils").getFingerPrint(i,"MEBCryptoPreSharedKey");if((b==null?void 0:b.psk_fingerprint)!==d("Base64Utils").fromArrayBuffer(f))return d("WAResultOrError").makeError({errorMessage:"epoch forward edge psk fingerprint mismatch",resultCode:c("MEBEpochDerivationResult").PSK_FINGERPRINT_MISMATCH});f=b==null?void 0:b.epoch_storage_public_key;if(d("Base64Utils").fromArrayBuffer(a.epochStoragePublicKeyBlob)!==f)return d("WAResultOrError").makeError({errorMessage:"epoch forward edge storage key mismatch",resultCode:c("MEBEpochDerivationResult").STORAGE_KEY_MISMATH});f=b==null?void 0:b.auth_public_key;if(f==null)return d("WAResultOrError").makeError({errorMessage:"epoch forward edge auth public key is null",resultCode:c("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});e=e==null?void 0:(e=e.to_epoch)==null?void 0:e.epoch_anon_id;if(e==null)return d("WAResultOrError").makeError({errorMessage:"epoch forward edge target epoch anon id is null",resultCode:c("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});b=b==null?void 0:b.encrypted_entropy;if(b==null)return d("WAResultOrError").makeError({errorMessage:"epoch forward edge encrypted entropy is null",resultCode:c("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});f=d("LSBase64Decode").decode(f);if(f==null)return d("WAResultOrError").makeError({errorMessage:"epoch forward edge auth public key is null",resultCode:c("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});b=d("LSBase64Decode").decode(b);if(b==null)return d("WAResultOrError").makeError({errorMessage:"epoch forward edge encrypted entropy is null",resultCode:c("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});a=await d("EpochUtils").decryptEpochKey(a.epochStoragePublicKeyBlob,a.epochStoragePrivateKeyBlob,f,i,e,b);return a==null?d("WAResultOrError").makeError({errorMessage:"epoch forward edge entropy is null",resultCode:c("MEBEpochDerivationResult").FORWARD_DECRYPTION_FAILED}):d("WAResultOrError").makeResult(await d("EpochUtils").generateEpochRootKey(g.epoch_chaining_key,a))}async function j(a,b,e){b=b==null?void 0:(b=b.to_epoch)==null?void 0:b.epoch_anon_id;if(b==null)return d("WAResultOrError").makeError({errorMessage:"toEpochId is null",resultCode:c("MEBEpochDerivationResult").BACKWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});b=d("EpochUtils").getNextEpochId(d("LSBase64Decode").decode(b));if(d("WACryptoUtils").arrayBuffersEqual(b,a.epochAnonIdBlob))return d("WAResultOrError").makeError({errorMessage:"epoch backward edge not consecutive",resultCode:c("MEBEpochDerivationResult").BACKWARD_EDGE_NOT_CONSECUTIVE});b=await d("EpochUtils").deriveBackwardEdgeKey(a);return b==null?d("WAResultOrError").makeError({errorMessage:"epoch backward edge storage key is null",resultCode:c("MEBEpochDerivationResult").STORAGE_KEY_MISMATH}):d("WAResultOrError").makeResult(await d("EpochUtils").decryptBackwardEdge(b,e))}async function k(a,b,e){var g,k,l=await a.runInTransaction(function(a){return d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.secure_encrypted_backups_client_state))},"readwrite",void 0,void 0,f.id+":226");if(l==null)return d("WAResultOrError").makeError({errorMessage:"client state is missing",resultCode:c("MEBEpochDerivationResult").MISSING_CLIENT_STATE});var m=b==null?void 0:(g=b.from_epoch)==null?void 0:g.epoch_id;if(m==null)return d("WAResultOrError").makeError({errorMessage:"fromEpochId is null",resultCode:c("MEBEpochDerivationResult").SOURCE_EPOCH_NOT_FOUND});g=await a.runInTransaction(function(a){return a.secure_encrypted_backups_epochs.get((h||(h=d("I64"))).of_string(m))},"readwrite",void 0,void 0,f.id+":244");if(g==null)return d("WAResultOrError").makeError({errorMessage:"source epoch is missing",resultCode:c("MEBEpochDerivationResult").SOURCE_EPOCH_NOT_FOUND});k=b==null?void 0:(k=b.from_epoch)==null?void 0:k.epoch_anon_id;if(new TextDecoder().decode(g.epochAnonIdBlob)!==k)return d("WAResultOrError").makeError({errorMessage:"epoch derivation source epoch anon id mismatch",resultCode:c("MEBEpochDerivationResult").SOURCE_FINGERPRINT_MISMATCH});k=b==null?void 0:b.from_epoch_fingerprint;var n=await d("EpochUtils").getFingerPrint(g.epochRootKeyBlob,"MEBEpochRootKey");if(d("Base64Utils").fromArrayBuffer(n)!==k)return d("WAResultOrError").makeError({errorMessage:"epoch derivation source epoch fingerprint mismatch",resultCode:c("MEBEpochDerivationResult").SOURCE_FINGERPRINT_MISMATCH});n=b==null?void 0:b.forward_edge;if(n!=null)k=await i(l,n,b,g);else{n=b==null?void 0:b.backward_edge;if(n==null)return d("WAResultOrError").makeError({errorMessage:"backward edge is null",resultCode:c("MEBEpochDerivationResult").BACKWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});k=await j(g,b,new TextEncoder().encode(n).buffer)}g=b==null?void 0:b.to_epoch_fingerprint;var o=k.value,p=b==null?void 0:(n=b.to_epoch)==null?void 0:n.epoch_id,q=b==null?void 0:(n=b.to_epoch)==null?void 0:n.epoch_anon_id;if(p==null||q==null)return d("WAResultOrError").makeError({errorMessage:"target epoch id or anon id is null",resultCode:c("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});if(o==null)return k;b=await d("EpochUtils").getFingerPrint(o,"MEBEpochRootKey");if(g!==d("Base64Utils").fromArrayBuffer(b))return d("WAResultOrError").makeError({errorMessage:"epoch derivation target epoch fingerprint mismatch",resultCode:c("MEBEpochDerivationResult").DEST_FINGERPRINT_MISMATCH});if(e)return d("WAResultOrError").makeResult(o);await a.runInTransaction(function(a){return a.secure_encrypted_backups_epochs.put({authorityLevel:(h||(h=d("I64"))).of_float(c("LSAuthorityLevel").AUTHORITATIVE),backupId:l.backupId,epochAnonIdBlob:new TextEncoder().encode(q).buffer,epochId:h.of_string(p),epochRootKeyBlob:o,epochStatus:h.of_float(c("LSEpochStatus").ES_CLOSE)})},"readwrite",void 0,void 0,f.id+":328");return d("WAResultOrError").makeResult(o)}async function a(a,b,e,f){var g;f===void 0&&(f=!1);var h=Date.now();b=await Promise.all((b=b==null?void 0:b.epoch_edges.map(async function(b){var d,e=await k(a,b,f);return{resultForEpochSync:{error_message:e.success?"":e.error.errorMessage,from:{epoch_anon_id:b==null?void 0:(d=b.from_epoch)==null?void 0:d.epoch_anon_id,epoch_id:b==null?void 0:(d=b.from_epoch)==null?void 0:d.epoch_id},has_backward_edge:(b==null?void 0:b.backward_edge)!=null,has_forward_edge:(b==null?void 0:b.forward_edge)!=null,result_code:e.success?c("MEBEpochDerivationResult").SUCCESS:e.error.resultCode,to:{epoch_anon_id:b==null?void 0:(d=b.to_epoch)==null?void 0:d.epoch_anon_id,epoch_id:b==null?void 0:(d=b.to_epoch)==null?void 0:d.epoch_id}},resultForShadowTestComparison:e.success?e.value:null}}))!=null?b:[]);await c("RecordEpochSyncMutation")({app_id:(g=d("MAWCurrentUser").getAppID())!=null?g:"0",payload:JSON.stringify({decryption_device_id:e,end_ms:Date.now(),epoch_sync_reason:c("MEBEpochSyncReason").NONE_PROVIDED_BY_SERVER,results:b.map(function(a){return a.resultForEpochSync}),start_ms:h,target_device_id:e})});return b.map(function(a){return a.resultForShadowTestComparison})}g.deriveAndStoreEpochs=a}),98);
__d("EBMessageRangeQueryWithPersistenceQuery_facebookRelayOperation",[],(function(a,b,c,d,e,f){e.exports="23891425050463617"}),null);
__d("EBMessageRangeQueryWithPersistenceQuery.graphql",["EBMessageRangeQueryWithPersistenceQuery_facebookRelayOperation"],(function(a,b,c,d,e,f){"use strict";a=function(){var a={defaultValue:null,kind:"LocalArgument",name:"app_id"},c={defaultValue:null,kind:"LocalArgument",name:"restore_payload_string"},d={defaultValue:null,kind:"LocalArgument",name:"restore_type"},e=[{kind:"Variable",name:"app_id",variableName:"app_id"},{kind:"Variable",name:"restore_payload_string",variableName:"restore_payload_string"},{kind:"Variable",name:"restore_type",variableName:"restore_type"}],f={alias:null,args:null,kind:"ScalarField",name:"encryption_version",storageKey:null},g={alias:null,args:null,kind:"ScalarField",name:"epoch_anon_id",storageKey:null},h={alias:null,args:null,kind:"ScalarField",name:"epoch_id",storageKey:null},i={alias:null,args:null,kind:"ScalarField",name:"encrypted_protobuf_stanza",storageKey:null},j={alias:null,args:null,kind:"ScalarField",name:"protobuf_timestamp_ms",storageKey:null},k={alias:null,args:null,kind:"ScalarField",name:"sk_ciphertext",storageKey:null},l=[g,h];return{fragment:{argumentDefinitions:[a,c,d],kind:"Fragment",metadata:null,name:"EBMessageRangeQueryWithPersistenceQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:e,concreteType:"XFBEncryptedBackupMessages",kind:"LinkedField",name:"messages",plural:!1,selections:[{args:null,kind:"FragmentSpread",name:"handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages"}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],type:"Query",abstractKey:null},kind:"Request",operation:{argumentDefinitions:[c,d,a],kind:"Operation",name:"EBMessageRangeQueryWithPersistenceQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:e,concreteType:"XFBEncryptedBackupMessages",kind:"LinkedField",name:"messages",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMessage",kind:"LinkedField",name:"encrypted_messages",plural:!0,selections:[{alias:null,args:null,concreteType:"XFBEchoDocument",kind:"LinkedField",name:"echo_document",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"echo_document_string",storageKey:null},f,g,h,{alias:null,args:null,kind:"ScalarField",name:"epoch_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"otid",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanzas",kind:"LinkedField",name:"protobuf_stanzas",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"top_level_protobuf",plural:!1,selections:[i,f,g,h,j,k],storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"supplemental_protobufs",plural:!0,selections:[i,f,g,h,j,k,{alias:null,args:null,kind:"ScalarField",name:"supplemental_key",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"backup_id",storageKey:null},{alias:null,args:null,concreteType:"XFBMessageRangeInfo",kind:"LinkedField",name:"message_range_info",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"has_more_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"has_more_after",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_after",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"should_delete_mailbox",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"exception_string",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"thread_not_found",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochDerivationSet",kind:"LinkedField",name:"epoch_derivation_set",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupsEpochEdge",kind:"LinkedField",name:"epoch_edges",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"backward_edge",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochForwardEdge",kind:"LinkedField",name:"forward_edge",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"auth_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_entropy",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"entropy_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"epoch_storage_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"psk_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"from_epoch",plural:!1,selections:l,storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"to_epoch",plural:!1,selections:l,storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"from_epoch_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"to_epoch_fingerprint",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"id",storageKey:null}],storageKey:null}],storageKey:null}]},params:{id:b("EBMessageRangeQueryWithPersistenceQuery_facebookRelayOperation"),metadata:{},name:"EBMessageRangeQueryWithPersistenceQuery",operationKind:"query",text:null}}}();e.exports=a}),null);
__d("EchoMessageDecryptor",["CryptoUtils","I64","LSAuthorityLevel","LSIntEnum","MEBEncryptionVersion","ReQL","WACryptoUtils","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to derive symmetric key for message"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No epoch keys found for message"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Empty echo message string - cannot decrypt"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] SecureEncryptedBackupsEpoch table is empty"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No backup id provided"]);n=function(){return a};return a}async function o(a,b,e){if(b==null){d("WALogger").ERROR(n());return[]}a=await d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a.tables.secure_encrypted_backups_epochs));if(a.length===0){d("WALogger").ERROR(m());return[]}return a.filter(function(a){return(h||(h=d("I64"))).equal(a.authorityLevel,(i||(i=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").AUTHORITATIVE))&&(h||(h=d("I64"))).equal(a.backupId,(h||(h=d("I64"))).of_string(b))&&e.equals(a[e.key])})}function p(a,b){var c=b.epoch_id;return c!=null?o(a,b.backup_id,{equals:function(a){return a instanceof ArrayBuffer?!1:(h||(h=d("I64"))).equal(c,a)},key:"epochId",value:c}):o(a,b.backup_id,{equals:function(a){return a instanceof ArrayBuffer?d("WACryptoUtils").arrayBuffersEqual(b.epoch_anon_id,a):!1},key:"epochAnonIdBlob",value:b.epoch_anon_id})}a=function(){function a(){}var b=a.prototype;b.decrypt=function(a,b,e){e=e.map(async function(e){if(e.value==null){d("WALogger").ERROR(l());return{otid:e.otid,value:null}}var f=e.value,g=await p(a,e);if(g.length===0){d("WALogger").ERROR(k());return{otid:e.otid,value:null}}g=await d("CryptoUtils").deriveMessageSymmetricKey(g[0].epochAnonIdBlob,g[0].epochRootKeyBlob,(g=e.encryption_version)!=null?g:c("MEBEncryptionVersion").UNKNOWN,b);if(g==null||g.length===0){d("WALogger").ERROR(j());return{otid:e.otid,value:null}}g=await d("CryptoUtils").symmetricEncryptionCreateDecryptedString(g[0],new TextEncoder().encode([d("CryptoUtils").MESSAGE_ENCYPTION_AAD,b].join(d("CryptoUtils").STRING_JOIN_SEPARATOR)).buffer,f);return{otid:e.otid,value:g}});return Promise.all(e)};return a}();g.getEpochKeysByID=p;g.EchoMessageDecryptor=a}),98);
__d("ProtobufMessageDecryptor",["CryptoUtils","EchoMessageDecryptor","MEBEncryptionVersion","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decrypt protobuf message for message with otid ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] decrypted supplemental key is null"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decrypt supplemental protobuf"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decrypt top level protobuf"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] protobuf timestamp is null"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decrypt protobuf"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] encrypted protobuf content is null"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to derive symmetric key for message"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No epoch keys found for message"]);p=function(){return a};return a}a=function(){function a(){}var b=a.prototype;b.$1=async function(a,b,e){var f;a=await d("EchoMessageDecryptor").getEpochKeysByID(a,e);if(a.length===0){d("WALogger").ERROR(p());return}a=a[0];f=await d("CryptoUtils").deriveMessageSymmetricKey(a.epochAnonIdBlob,a.epochRootKeyBlob,(f=e.encryption_version)!=null?f:c("MEBEncryptionVersion").UNKNOWN,b);if(f==null||f.length===0){d("WALogger").ERROR(o());return}if(e.encryptedProtobufContent==null){d("WALogger").ERROR(n());return}var g=e.encryptedProtobufContent;f=await d("CryptoUtils").symmetricEncryptionCreateDecryptedString(f[0],new TextEncoder().encode([d("CryptoUtils").MESSAGE_ENCYPTION_AAD,b].join(d("CryptoUtils").STRING_JOIN_SEPARATOR)).buffer,g);var h;if(e.skCipherText!=null){b=e.skCipherText;a=await (g=d("CryptoUtils")).createDerivedKeys(new TextEncoder().encode(g.SUPPLEMENTAL_ENC_KEY_INFO).buffer,void 0,a.epochRootKeyBlob,[g.KEY_LEN]);h=await g.symmetricEncryptionCreateDecryptedString(a[0],new TextEncoder().encode(g.SUPPLEMENTAL_ENC_AAD).buffer,b)}if(f==null){d("WALogger").ERROR(m());return}if(e.protobufTimestampMs==null){d("WALogger").ERROR(l());return}return{decryptedProtobuf:f,decryptedSupplementalKey:h,protobufTimestampMs:e.protobufTimestampMs}};b.$2=async function(a,b,c){var e=this,f=c.topLevelProtobuf,g=c.supplementalProtobufs;f=await this.$1(a,b,f);if(f==null){d("WALogger").ERROR(k());return}var h=new Map();await Promise.all(g.map(async function(c){c=await e.$1(a,b,c);if(c==null){d("WALogger").ERROR(j());return}var f=c.decryptedSupplementalKey;if(f==null){d("WALogger").ERROR(i());return}h.set(f,c)}));return{otid:c.topLevelProtobuf.otid,supplementalProtobufs:h,topLevelProtobuf:f}};b.decrypt=async function(a,b,c){var e=this,f=[];await Promise.all(c.map(async function(c){var g=await e.$2(a,b,c);if(g==null){d("WALogger").ERROR(h(),c.topLevelProtobuf.otid);return}f.push(g)}));return f};return a}();g.ProtobufMessageDecryptor=a}),98);
__d("EBMessageRangeQueryWithPersistence",["Base64Utils","DeriveAndStoreEpochs","EBAPIQPLPoints","EBAPISharedUtils","EBAPIWorkerCheck","EBMessageRangeQueryUtils","EBMessageRangeQueryWithPersistenceQuery.graphql","EchoMessageDecryptor","I64","LSAuthorityLevel","LSDatabaseSingleton","LSDecryptMessageProtobufsStoredProcedure","LSDecryptMessagesStoredProcedure","LSDeleteAndReenrollDeviceStateStoredProcedure","LSEncryptedBackupsMessagesRangeQueryDirection","LSFactory","LSIntEnum","LSMEBDeviceReenrollmentReason","LSMEBTaskCreationSource","LSShape","LSVec","MAWCurrentUser","MAWEBRestoreTrackingUtils","MAWEncryptedBackupUtils","MAWJids","MAWJobDefinitions","MAWMiActGetThreadLifecycleState","MAWMiActThreadLifecycleState","ProtobufMessageDecryptor","QPLFlow","ReQL","WAHashStringToNumber","WAJids","WAResultOrError","WATagsLogger","WorkerRelay","WorkerRelayNetwork","getErrorSafe","gkx","handleRestoreMessagesGraphQLResponse","justknobx","promiseDone","qpl","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k;function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Decrypted supplemental protobuf message mismatch - supplemental key: ",", decryptedNonLSProtobuf OTID: ",", decryptedLSProtobuf OTID: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Decrypted supplemental protobuf missing in decryptedLSProtobuf supplementals map"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Decrypted supplemental protobuf supplemental key missing in decryptedLSProtobuf supplementals map"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Decrypted supplemental protobuf supplemental key null"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Decrypted supplemental protobuf message map sizes are unequal - decryptedNonLSProtobufs supplementals length: ",", decryptedLSProtobufs supplementals length: ",", decryptedNonLSProtobuf OTID: ",", decryptedLSProtobuf OTID: ",""]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Decrypted protobuf message mismatch - decryptedNonLSProtobuf OTID: ",", decryptedLSProtobuf OTID: ",""]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Unable to find protobuf in decrypted non ls batch corresponding for otid ",""]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Decrypted LS protobuf otid is null"]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Decrypted protobuf message set sizes are unequal - decryptedNonLSProtobufs length: ",", decryptedLSProtobufs length: ",""]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["[protobuf-only] decryptProtobufMessagesAndCompareWithLightspeedDecryptionResponse failed with an error: ",""]);u=function(){return a};return a}function v(){var a=babelHelpers.taggedTemplateLiteralLoose(["[protobuf-only] decryptMessageProtobufs failed with error: ",""]);v=function(){return a};return a}function w(){var a=babelHelpers.taggedTemplateLiteralLoose(["[protobuf-only] decryptMessageProtobufs failed with an error"]);w=function(){return a};return a}function x(){var a=babelHelpers.taggedTemplateLiteralLoose(["[echo] decryptEchoMessagesAndCompareWithLightspeedDecryptionResponse failed with an error: ",""]);x=function(){return a};return a}function y(){var a=babelHelpers.taggedTemplateLiteralLoose(["[echo-only][echo] decryptMessageEcho failed with error: ",""]);y=function(){return a};return a}function z(){var a=babelHelpers.taggedTemplateLiteralLoose(["[echo-only][echo] decryptMessageEcho failed with an error."]);z=function(){return a};return a}function A(){var a=babelHelpers.taggedTemplateLiteralLoose(["[mixed] [echo] decryptEchoMessagesAndCompareWithLightspeedDecryptionResponse failed with an error: ",""]);A=function(){return a};return a}function B(){var a=babelHelpers.taggedTemplateLiteralLoose(["[mixed][protobuf] decryptProtobufMessagesAndCompareWithLightspeedDecryptionResponse failed with an error: ",""]);B=function(){return a};return a}function C(){var a=babelHelpers.taggedTemplateLiteralLoose(["[mixed][protobuf] decryptMessageProtobufs failed with error: ",""]);C=function(){return a};return a}function D(){var a=babelHelpers.taggedTemplateLiteralLoose(["[mixed][protobuf] decryptMessageProtobufs failed with an error."]);D=function(){return a};return a}function E(){var a=babelHelpers.taggedTemplateLiteralLoose(["[mixed][echo] decryptMessageEcho failed with error: ",""]);E=function(){return a};return a}function F(){var a=babelHelpers.taggedTemplateLiteralLoose(["[mixed][echo] decryptMessageEcho failed with an error."]);F=function(){return a};return a}function G(){var a=babelHelpers.taggedTemplateLiteralLoose(["[","] messageRangeQuery echo: "," protobuf: "," nonLsEcho: "," nonLSProtobuf: ",""]);G=function(){return a};return a}function H(){var a=babelHelpers.taggedTemplateLiteralLoose(["message range info is not complete - cannot proceed with graphQL restore"]);H=function(){return a};return a}function I(){var a=babelHelpers.taggedTemplateLiteralLoose(["message range info is null - cannot proceed with graphQL restore"]);I=function(){return a};return a}function J(){var a=babelHelpers.taggedTemplateLiteralLoose(["No messages to restore"]);J=function(){return a};return a}function K(){var a=babelHelpers.taggedTemplateLiteralLoose(["graphQL range restore error ",""]);K=function(){return a};return a}function L(){var a=babelHelpers.taggedTemplateLiteralLoose(["backup_id is null during graphQL restore"]);L=function(){return a};return a}function M(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error while comparing LS and non LS epoch derivation ",""]);M=function(){return a};return a}function N(){var a=babelHelpers.taggedTemplateLiteralLoose(["server side exception during graphql restore - ",""]);N=function(){return a};return a}function O(){var a=babelHelpers.taggedTemplateLiteralLoose(["GQL worker range restore query returned null for message response"]);O=function(){return a};return a}function P(){var a=babelHelpers.taggedTemplateLiteralLoose(["mandatory params of client state are null"]);P=function(){return a};return a}function Q(){var a=babelHelpers.taggedTemplateLiteralLoose(["No client state found - unable to restore"]);Q=function(){return a};return a}function R(){var a=babelHelpers.taggedTemplateLiteralLoose(["[","] Issuing messageRangeQuery with args: ",""]);R=function(){return a};return a}var S=c("requireDeferred")("LSEBUnifiedRestoreUtils").__setRef("EBMessageRangeQueryWithPersistence"),T=c("requireDeferred")("LSRestoreEchoBlobs.nop").__setRef("EBMessageRangeQueryWithPersistence"),U=c("requireDeferred")("LSRestoreProtobufs.nop").__setRef("EBMessageRangeQueryWithPersistence"),V=d("WATagsLogger").TAGS(["labyrinth_web","EBMessageRangeQueryWithPersistence"]),W=h!==void 0?h:h=b("EBMessageRangeQueryWithPersistenceQuery.graphql");async function a(a){var b=a.chatJid,e=a.direction,g=a.includeOffset;g=g===void 0?!1:g;var h=a.numMessages,l=a.sortOrderMs,m=a.source,n=a.traceId;if(d("EBAPIWorkerCheck").runningInWorker())return d("WAResultOrError").makeError("unsupported-context");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql");var o=d("WAHashStringToNumber").hashStringToNumber(n),p=c("qpl")._(521471755,"2586"),q=d("QPLFlow").startQPLFlow(p,{annotations:{bool:{mainThreadRestore:!0,workerThreadRestore:!1},int:{num_messages_requested:h,source:m!=null?m:c("LSMEBTaskCreationSource").UNKNOWN},string:{request_args:JSON.stringify(a)}},instanceKey:o,timeoutInMs:c("justknobx")._("2950")});try{V.LOG(R(),n,JSON.stringify(a));d("MAWEBRestoreTrackingUtils").markEBRestorePaginated(m,n,"GQL_MAIN_THREAD");var r=await (i||(i=d("LSDatabaseSingleton"))).getLSDatabaseSingletonPromiseOrValue(),s;await r.runInTransaction(async function(a){var c;q.addPoint("get_client_state_start");s=await d("handleRestoreMessagesGraphQLResponse").getClientState(r,a);d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotations({annotations:{string:{device_id:(j||(j=d("I64"))).to_string((c=(c=s)==null?void 0:c.device_id)!=null?c:(j||(j=d("I64"))).zero)}},pointName:"client_state_retrieved",traceId:n});q.addPoint("get_client_state_end",{string:{device_id:j.to_string((c=(c=s)==null?void 0:c.device_id)!=null?c:(j||(j=d("I64"))).zero)}});c=await d("MAWMiActGetThreadLifecycleState").getThreadLifecycleStateByJid(a,d("MAWJids").convertChatJidToIntJid(b),"GQL_range_restore_eb_api_call");if(c.type===d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.JID_MISSING_MAPPING_ROW||c.type===d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.JID_MISSING_MI_THREAD){d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotations({annotations:{string:{thread_state_by_jid:c.type}},pointName:"chat_jid_not_found_in_act_mapping_table",traceId:n});q.addPoint("chat_jid_not_found_in_act_mapping_table");d("MAWEBRestoreTrackingUtils").markEBRestoreSuccess(n,!1);q.endSuccess();d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.thread.missing.error");return d("WAResultOrError").makeError("thread-not-found-in-mi-act-mapping-table")}else d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotations({annotations:{string:{thread_state_by_jid:c.type}},pointName:"chat_jid_exists_in_act_mapping_table",traceId:n}),q.addPoint("chat_jid_exists_in_act_mapping_table")},"readwrite",void 0,void 0,f.id+":210");if(s==null){V.ERROR(Q());q.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(n,!1,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE);d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("no-client-state")}p=s;o=p.backupId;var t=p.device_id;a=p.locally_available_epochs;var u=p.mailboxRootKey;p=p.ocmfClientStateBlob;if(o==null||t==null||u==null||p==null){V.ERROR(P());q.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(n,!1,"client_state_null");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("invalid-client-state")}var v=d("MAWCurrentUser").getAppID();d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"app_id_retrieved",traceId:n});q.addPoint("app_id_retrieved");var w=d("WAJids").threadIdForChatJid(b);d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"converted_chatjid_to_threadid",traceId:n});q.addPoint("converted_chatjid_to_threadid");e=e==="before"?c("LSEncryptedBackupsMessagesRangeQueryDirection").BEFORE:c("LSEncryptedBackupsMessagesRangeQueryDirection").AFTER;u={restore_context:{act_thread_id:d("MAWJobDefinitions").toThreadJidPrimaryId(w),site:"www",tam_thread_subtype:0},success:babelHelpers.extends({device_context:{device_id:(j||(j=d("I64"))).to_string(t),locally_available_epochs:a,raw_tokens:{mailbox_root_key:d("Base64Utils").fromArrayBuffer(u),ocmf_client_state_blob:d("Base64Utils").fromArrayBuffer(p)}},direction:e,include_offset:g,query_num_messages:h,server_thread_key:w},l!=null?{reference_timestamp:d("EBMessageRangeQueryUtils").safeTimestampMsString(l)}:{})};q.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_START);d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"graphql_query_start",traceId:n});var x;try{await d("WorkerRelayNetwork").createWorkerNetworkExecute(),x=await d("WorkerRelay").createWorkerQuery(W,{app_id:String(v!=null?v:"0"),restore_payload_string:JSON.stringify(u),restore_type:"RANGE_QUERY_RESTORE"}),q.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_END),d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"graphql_query_end",traceId:n})}catch(a){p=c("getErrorSafe")(a);q.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_EXCEPTION,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_EXCEPTION,errorStackTrace:p.stack}});return d("WAResultOrError").makeError("invalid-graphql-response")}if(x==null||((e=x)==null?void 0:(g=e.viewer)==null?void 0:(h=g.encrypted_backup)==null?void 0:h.mailbox)==null){q.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(n,!1,"gql_range_restore_exception");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("invalid-graphql-response")}e=(w=x)==null?void 0:(v=w.viewer)==null?void 0:(u=v.encrypted_backup)==null?void 0:(p=u.mailbox)==null?void 0:p.messages;if(e==null){V.ERROR(O());q.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(n,!1,"gql_range_restore_exception");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("invalid-graphql-response")}g=e;if((g==null?void 0:g.encrypted_messages)==null){q.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NULL_MESSAGES,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NULL_MESSAGES}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(n,!1,"null_messages");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("invalid-graphql-response")}h=g.backup_id;w=g.encrypted_messages;v=g.epoch_derivation_set;u=g.exception_string;p=g.message_range_info;e=g.should_delete_mailbox;g=g.thread_not_found;q.addAnnotations({bool:{should_delete_mailbox:e!=null?e:!1},int:{response_messages:w.length},string:{message_range_info:JSON.stringify(p)}});if(u!=null){V.ERROR(N(),u);if(g!=null&&g){q.addPoint("thread_not_found_on_server");d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"thread_not_found_on_server",traceId:n});q.endSuccess();d("MAWEBRestoreTrackingUtils").markEBRestoreSuccess(n,!1);return d("WAResultOrError").makeError("thread-not-found-on-server")}e===!0&&(q.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DELETE_MAILBOX),await r.runInTransaction(function(a){return c("LSDeleteAndReenrollDeviceStateStoredProcedure")(c("LSFactory")(a),{reenrollmentReason:(k||(k=d("LSIntEnum"))).ofNumber(c("LSMEBDeviceReenrollmentReason").RESTORE_FAILED_WITH_NO_DEVICE_FOUND),targetDeviceId:t})},"readwrite",void 0,void 0,f.id+":488"),d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"delete_mailbox",traceId:n}));q.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,exception:u}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(n,!1,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,{string:{exception:u}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("server-side-exception")}q.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_START);await d("handleRestoreMessagesGraphQLResponse").deriveAndStoreEpochs(v,r,t,n);if(c("gkx")("14309"))try{g=await r.runInTransaction(function(a){return d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a.secure_encrypted_backups_epochs))},"readonly",void 0,void 0,f.id+":542");if(g!=null){e=g.filter(function(a){return(j||(j=d("I64"))).equal(a.authorityLevel,(k||(k=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").AUTHORITATIVE))});var y=new Set(a);u=e.map(function(a){return{blob:d("Base64Utils").fromArrayBuffer(a.epochRootKeyBlob),epochId:a.epochId}}).filter(function(a){return!y.has((j||(j=d("I64"))).to_string(a.epochId))});g=await d("DeriveAndStoreEpochs").deriveAndStoreEpochs(r,v,t,!0);var z=new Set(g.filter(Boolean).map(function(a){return d("Base64Utils").fromArrayBuffer(a)}));a=u.filter(function(a){return z.has(a.blob)}).length;d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotations({annotations:{bool:{isMatch:a===u.length},int:{commonEpochs:a,derivedLSEpochsLength:u.length,derivedNativeEpochsLength:z.size}},pointName:"ls_and_non_ls_epoch_derivation_comparison",traceId:n});q.addAnnotations({bool:{ls_and_non_ls_epoch_derivation_comparison:a===u.length},int:{commonEpochs:a,derivedLSEpochsLength:u.length,derivedNativeEpochsLength:z.size}})}}catch(a){V.ERROR(M(),a)}q.addAnnotations({bool:{hasEpochs:v!=null&&v.epoch_edges.length>0}});q.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_END);h==null&&(V.WARN(L()),q.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.BACKUP_ID_NULL),d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"backup_id_null",traceId:n}));e=await X(r,b,w,h!=null?h:(j||(j=d("I64"))).to_string(o),p,n,q);if(e.success===!1)return e;aa(r,b,e.value,l,m,n);return d("WAResultOrError").makeResult()}catch(b){g=c("getErrorSafe")(b);V.ERROR(K(),g);q.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RUNTIME_ERROR,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RUNTIME_ERROR,errorStackTrace:(a=g.stack)!=null?a:""}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(n,!1,"gql_range_restore_exception");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").DEPRECATED_makeError("runtime-error",g)}}async function X(a,b,e,g,h,i,j){var k=d("WAJids").threadIdForChatJid(b);b=d("WAHashStringToNumber").hashStringToNumber(i);var l=c("qpl")._(521471755,"2586");e.length===0&&(V.LOG(J()),j.addAnnotations({bool:{hasMessagesToRestore:!1}}),d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"no_messages",traceId:i}));if(h==null){V.ERROR(I());j.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(i,!1,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO);d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("missing-message-range-info")}var m=h.has_more_after,n=h.has_more_before,o=h.next_message_timestamp_ms_after;h=h.next_message_timestamp_ms_before;if(n==null||m==null||o==null||h==null){V.ERROR(H());j.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(i,!1,"message_range_info_null");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("missing-message-range-info")}if(e.length===0){j.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_MESSAGES_TO_RESTORE);j.endSuccess();d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.success");return d("WAResultOrError").makeResult({echo:[],messageRangeInfo:{has_more_after:m,has_more_before:n,next_message_timestamp_ms_after:o,next_message_timestamp_ms_before:h},protobuf:[]})}g=d("handleRestoreMessagesGraphQLResponse").processMessageArray(e,g,l,b);var p=g.encryptedLSEchoMessages,q=g.encryptedMessagesWithProtobufs;l=g.encryptedNonLSEchoMessages;var r=g.encryptedNonLSProtobufs;j.addAnnotations({bool:{hasEchoMessages:p.length>0,hasProtobufMessages:q.length>0}});e.length!==p.length+q.length&&j.addAnnotations({bool:{hasEchoProtobufCountMismatch:!0}});V.LOG(G(),i,p.length,q.length,l.length,r.length);var s,t;if(p.length>0&&q.length>0){j.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RESTORING_MIXED_ECHO_PROTOBUF_PAYLOAD);j.addAnnotations({int:{echoMessagesPayloadSize:p.length,protobufMessagesPayloadSize:q.length,totalRestorePayloadSize:p.length+q.length}});j.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_AND_PROTOBUF_START);b=await a.runInTransaction(async function(b){var e=await c("LSDecryptMessagesStoredProcedure")(c("LSFactory")(b),{actThreadId:k,encryptedMessages:c("LSVec").ofArray(p)}),f=e[0];e=e[1];if(e!=null){var g=d("LSShape").toRecord(e);V.ERROR(F());V.WARN(E(),g.error_message);j.addAnnotations({string:{echo_decryption_error:g.error_message}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(i,!1,"ECHO_DECRYPTION_FAILURE",{string:{error_description:g.error_message}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error")}g=await c("LSDecryptMessageProtobufsStoredProcedure")(c("LSFactory")(b),{actThreadId:k,encryptedMessagesWithProtobufs:c("LSVec").ofArray(q)});b=g[0];g=g[1];if(g!=null){g=d("LSShape").toRecord(g);V.ERROR(D());V.WARN(C(),g.error_message);j.endFail("PROTOBUF_DECRYPTION_FAILURE",{string:{error_description:g.error_message}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(i,!1,"PROTOBUF_DECRYPTION_FAILURE",{string:{error_description:g.error_message}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("protobuf-decryption-failure")}if(b!=null&&c("gkx")("11925"))try{j.addPoint("native_restore_shadow_test_start"),await Y(b,r,k,a,i,j),j.addPoint("native_restore_shadow_test_end")}catch(a){j.addPoint("native_restore_shadow_test_end"),V.ERROR(B(),a)}g=b==null?0:c("LSVec").toArray(b).length;e!=null&&g>0&&j.addAnnotations({bool:{continuedAfterEchoDecryptFailure:!0}});return{decryptedEchoMsgs:f,decryptedProtobufMsgs:b}},"readwrite",void 0,void 0,f.id+":826");g=b.decryptedEchoMsgs;e=b.decryptedProtobufMsgs;j.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_AND_PROTOBUF_END);var K;g!=null&&(K=c("LSVec").toArray(g).map(function(a){return d("LSShape").toRecord(a).value}));if(c("gkx")("14310"))try{await Z((b=K)!=null?b:[],l,k,a,i,j)}catch(a){V.ERROR(A(),a)}s=K;t=e==null?[]:c("LSVec").toArray(e)}else if(q.length===0){j.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_START);g=await a.runInTransaction(function(a){return c("LSDecryptMessagesStoredProcedure")(c("LSFactory")(a),{actThreadId:k,encryptedMessages:c("LSVec").ofArray(p)})},"readwrite",void 0,void 0,f.id+":968");b=g[0];e=g[1];if(e!=null){g=d("LSShape").toRecord(e);V.ERROR(z());V.WARN(y(),g.error_message);j.endFail("ECHO_DECRYPTION_FAILURE",{string:{error_description:g.error_message}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(i,!1,"ECHO_DECRYPTION_FAILURE",{string:{error_description:g.error_message}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("echo-decryption-failure")}j.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_END);if(b!=null){e=c("LSVec").toArray(b).map(function(a){return d("LSShape").toRecord(a).value});if(c("gkx")("9385"))try{await Z(e!=null?e:[],l,k,a,i,j)}catch(a){V.ERROR(x(),a)}s=e}}else{j.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_PROTOBUF_START);g=await a.runInTransaction(function(a){return c("LSDecryptMessageProtobufsStoredProcedure")(c("LSFactory")(a),{actThreadId:k,encryptedMessagesWithProtobufs:c("LSVec").ofArray(q)})},"readwrite",void 0,void 0,f.id+":1033");b=g[0];l=g[1];if(l!=null){e=d("LSShape").toRecord(l);V.ERROR(w());V.WARN(v(),e.error_message);j.endFail("PROTOBUF_DECRYPTION_FAILURE",{string:{error_description:e.error_message}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(i,!1,"PROTOBUF_DECRYPTION_FAILURE",{string:{error_description:e.error_message}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("protobuf-decryption-failure")}if(b!=null&&c("gkx")("11925"))try{j.addPoint("native_restore_shadow_test_start"),await Y(b,r,k,a,i,j),j.addPoint("native_restore_shadow_test_end")}catch(a){j.addPoint("native_restore_shadow_test_end"),V.ERROR(u(),a)}j.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_PROTOBUF_END);t=b==null?[]:c("LSVec").toArray(b)}j.endSuccess();d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.success");return d("WAResultOrError").makeResult({echo:(g=s)!=null?g:[],messageRangeInfo:{has_more_after:m,has_more_before:n,next_message_timestamp_ms_after:o,next_message_timestamp_ms_before:h},protobuf:(l=t)!=null?l:[]})}function aa(a,b,e,g,h,i){var l=e.echo,m=e.messageRangeInfo,n=e.protobuf,o=d("WAJids").threadIdForChatJid(b);l.length>0&&n.length>0?c("promiseDone")(S.load().then(function(a){return a.echoProtobufConsolidatedRestoreHelper(o,c("LSVec").ofArray(n),m.has_more_before,(j||(j=d("I64"))).of_string(m.next_message_timestamp_ms_before),m.has_more_after,j.of_string(m.next_message_timestamp_ms_after),!1,i,g,void 0,c("LSVec").ofArray(l),(k||(k=d("LSIntEnum"))).ofNumber(h!=null?h:c("LSMEBTaskCreationSource").UNKNOWN),b)})):l.length>0?c("promiseDone")(T.load().then(function(e){return a.runInTransaction(function(a){return e(a,0,(j||(j=d("I64"))).zero,c("LSVec").ofArray(l),m.has_more_before,j.of_string(m.next_message_timestamp_ms_before),m.has_more_after,j.of_string(m.next_message_timestamp_ms_after),!1,o,i,g,(k||(k=d("LSIntEnum"))).ofNumber(h!=null?h:c("LSMEBTaskCreationSource").UNKNOWN),b)},"readwrite",void 0,void 0,f.id+":1143")})):c("promiseDone")(U.load().then(function(e){return a.runInTransaction(function(a){return e(a,0,o,c("LSVec").ofArray(n),m.has_more_before,(j||(j=d("I64"))).of_string(m.next_message_timestamp_ms_before),m.has_more_after,j.of_string(m.next_message_timestamp_ms_after),!1,i,g,void 0,c("LSVec").ofArray([]),(k||(k=d("LSIntEnum"))).ofNumber(h!=null?h:c("LSMEBTaskCreationSource").UNKNOWN),b)},"readwrite",void 0,void 0,f.id+":1166")}))}function ba(a){var b=new TextDecoder().decode(a.toplevelProtobuf.decryptedProtobuf),c=a.toplevelProtobuf.protobufTimestampMS.toString();b={decryptedProtobuf:b,decryptedSupplementalKey:void 0,protobufTimestampMs:c};var d=new Map();a.supplementalProtobufs.forEach(function(a,b){var c=new TextDecoder().decode(a.decryptedProtobuf);a=a.protobufTimestampMS.toString();c={decryptedProtobuf:c,decryptedSupplementalKey:b,protobufTimestampMs:a};d.set(b,c)});return{otid:a.otid,supplementalProtobufs:d,topLevelProtobuf:b}}async function Y(a,b,c,e,f,g){a=d("MAWEncryptedBackupUtils").convertLSTypesToJSTypesForRestoreJob(a);a=a.map(function(a){return ba(a)});e=await new(d("ProtobufMessageDecryptor").ProtobufMessageDecryptor)().decrypt(e,c,b);c=da(e,a,g);d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotations({annotations:{bool:{isMatch:c}},pointName:"ls_and_non_ls_protobuf_msg_decryption_response_comparison",traceId:f});g.addAnnotations({bool:{does_ls_and_non_ls_protobuf_msg_decryption_match:c}})}async function Z(a,b,c,e,f,g){e=await new(d("EchoMessageDecryptor").EchoMessageDecryptor)().decrypt(e,c,b);c=ca(e,a);d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotations({annotations:{bool:{isMatch:c}},pointName:"ls_and_non_ls_echo_msg_decryption_response_comparison",traceId:f});g.addAnnotations({bool:{does_ls_and_non_ls_echo_msg_decryption_match:c}})}function ca(a,b){if(a.length!==b.length)return!1;for(var c=0;c<a.length;c++)if(a[c].value!==b[c])return!1;return!0}function $(a,b){return a.decryptedProtobuf===b.decryptedProtobuf&&a.protobufTimestampMs===b.protobufTimestampMs}function da(a,b,c){var d=new Map();for(var e of a)e.otid!=null&&d.set(e.otid,e);if(a.length!==b.length){V.ERROR(t(),a.length,b.length);c.addPoint("protobuf_size_mismatch");return!1}for(e=0;e<b.length;e++){a=b[e];var f=a.otid;if(f==null){c.addPoint("protobuf_otid_null");V.ERROR(s());return!1}var g=d.get(f);if(g==null){c.addPoint("protobuf_otid_missing_in_non_ls_batch");V.ERROR(r(),f);return!1}if(!$(g.topLevelProtobuf,a.topLevelProtobuf)){if(g.topLevelProtobuf.decryptedProtobuf!==a.topLevelProtobuf.decryptedProtobuf){f=a.topLevelProtobuf.decryptedProtobuf.length;var h=g.topLevelProtobuf.decryptedProtobuf.length;c.addPoint("decrypted_protobuf_mismatch_ls_length_"+f+"_non_ls_length_"+h)}else c.addPoint("decrypted_protobuf_mismatch_protobuf_timestamp");c.addPoint("decrypted_protobuf_mismatch");V.ERROR(q(),g.otid,a.otid);return!1}if(g.supplementalProtobufs.size!==a.supplementalProtobufs.size){c.addPoint("supplemental_protobuf_message_sizes_different",{int:{decrypted_ls_protobuf_supplemental_size:a.supplementalProtobufs.size,decrypted_non_ls_protobuf_supplemental_size:g.supplementalProtobufs.size}});V.ERROR(p(),g.supplementalProtobufs.size,a.supplementalProtobufs.size,g.otid,a.otid);return!1}for(f of g.supplementalProtobufs){f[0];h=f[1];if(h.decryptedSupplementalKey==null){c.addPoint("supplemental_protobuf_key_null");V.ERROR(o());return!1}var i=h.decryptedSupplementalKey;if(!a.supplementalProtobufs.has(i)){c.addPoint("supplemental_protobuf_key_not_found_in_ls_output");V.ERROR(n());return!1}var j=a.supplementalProtobufs.get(i);if(j==null){c.addPoint("supplemental_protobuf_key_not_found_in_ls_output");V.ERROR(m());return!1}if(!$(h,j)){c.addPoint("supplemental_protobuf_mismatch",{string:{supplementalKey:i}});V.ERROR(l(),i,g.otid,a.otid);return!1}}}return!0}g.query=W;g.messageRangeQueryWithPersistence=a}),98);
__d("LsDataTraceFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("1743851");b=d("FalcoLoggerInternal").create("ls_data_trace",a);e=b;g["default"]=e}),98);
__d("LSDataTraceFlush",["ArmadilloDataTraceType","I64","LSDataTraceType","LSIntEnum","LsDataTraceFalcoEvent","ODS","ReQL","clearTimeout","gkx","promiseDone","setTimeout"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k=(h||(h=d("I64"))).of_string("120000"),l=h.of_string("600000"),m=new Set(["encrypted_backups_upload","encrypted_backups_media_backup"]);function n(a,b,c){var e=a.length;if(e===0)return[(h||(h=d("I64"))).neg_one,h.neg_one,void 0,void 0,void 0];e=a.find(function(a){return a.errorMessage!=null});e=e==null?void 0:e.errorMessage;a=a[a.length-1|0];var f=(h||(h=d("I64"))).of_float(Date.now()),g=a.timestampMs,i=h.compare(h.sub(f,c),k)>=0;return!b&&i?[(h||(h=d("I64"))).sub(f,c),a.checkPointId,g,e,"trace expired"]:[h.sub(g,c),a.checkPointId,g,e,e]}function o(a){return a.reduce(function(a,b,c){var e,f=(h||(h=d("I64"))).to_string(b.checkPointId),g=b.timestampMs;e=h.to_string((e=b.syncChannel)!=null?e:(h||(h=d("I64"))).neg_one);b=b.tags;b=b!=null?","+b:"";if(c===0)a.pointsList="".concat("(",f,",",e,b,")");else{c=String((h||(h=d("I64"))).to_int32(h.sub(g,a.lastCheckPointTimestamp)));a.pointsList=a.pointsList.concat("-",c,"-(",f,",",e,b,")")}a.lastCheckPointTimestamp=g;return a},{lastCheckPointTimestamp:(h||(h=d("I64"))).zero,pointsList:""}).pointsList}var p=h.of_string("2");function q(a){var b=a.traceType;b=(h||(h=d("I64"))).equal(b,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").TASK))?"send":(h||(h=d("I64"))).equal(b,d("ArmadilloDataTraceType").armadilloMessageSend)?"armadillo send":(h||(h=d("I64"))).equal(b,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").ENCRYPTED_BACKUPS_UPLOAD))?"encrypted_backups_upload":(h||(h=d("I64"))).equal(b,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").ENCRYPTED_BACKUPS_RESTORE))?"encrypted_backups_restore":(h||(h=d("I64"))).equal(b,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").ENCRYPTED_BACKUPS_MEDIA_BACKUP))?"encrypted_backups_media_backup":(h||(h=d("I64"))).equal(b,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").SAP_VESTA_LOGIN))?"sap_vesta_login":(h||(h=d("I64"))).equal(b,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").SAP_VESTA_REGISTRATION))?"sap_vesta_registration":(h||(h=d("I64"))).equal(b,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").ENCRYPTED_BACKUPS_MEDIA_RESTORE))?"encrypted_backups_media_restore":(h||(h=d("I64"))).equal(b,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").ENCRYPTED_BACKUPS_SHADOW_INIT))?"shadow_encrypted_backups_init":(h||(h=d("I64"))).equal(b,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").ENCRYPTED_BACKUPS_SHADOW_ADD_DEVICE))?"shadow_encrypted_backups_add_device":(h||(h=d("I64"))).equal(b,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").ENCRYPTED_BACKUPS_SHADOW_UPLOAD))?"shadow_encrypted_backups_upload":(h||(h=d("I64"))).equal(b,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").ENCRYPTED_BACKUPS_SHADOW_RESTORE))?"shadow_encrypted_backups_restore":(h||(h=d("I64"))).equal(b,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").ENCRYPTED_BACKUPS_SHADOW_DELETE_BACKUP))?"shadow_encrypted_backups_delete_backup":a.contextTwo;return b}function r(a,b){var e=b.traceId,f=b.shouldFlush,g=q(b),i=b.traceType,j=(h||(h=d("I64"))).equal(i,d("ArmadilloDataTraceType").armadilloMessageSend)?"tam_message_send":b.contextOne,k=(h||(h=d("I64"))).equal(b.traceType,p)?void 0:b.predefinedId,l=b.initTimestampMs;return d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a.data_trace_addon.index("traceIdAddonId")).getKeyRange(e)).then(function(a){var b=n(a,f,l),i=b[0],m=b[1],p=b[3],q=b[4],r=a.length,s=o(a);c("LsDataTraceFalcoEvent").log(function(){return{check_point_count:(h||(h=d("I64"))).to_string(h.of_int32(r)),check_point_list:s,client_event_ts:h.to_string(h.of_float(Date.now())),cold_start_time:void 0,data_trace_id:e,database_id:j,delivered_messages:void 0,error_message:q,first_error_message:p,has_backgrounded:!1,last_check_point:h.to_string(m),latency:h.to_string(i),media_type:void 0,num_of_attachments:void 0,persisted_metadata:void 0,predefined_id:k,sent_rich_media_messages:void 0,sent_text_messages:void 0,start_time:h.to_string(l),trace_flow:g!=null?g:""}})}).then(function(){return a.data_trace_meta.delete(e)})}function a(a,b){return d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.data_trace_meta).getKeyRange(b)).then(function(b){if(b!=null)return r(a,b);else return Promise.resolve()})}var s={contents:void 0};function t(a){return d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a.data_trace_meta.index("shouldFlushInitTimestampMsTraceId")).getKeyRange(!1).bounds({lt:d("ReQL").key((h||(h=d("I64"))).sub(h.of_float(Date.now()),k))})).then(function(a){if(c("gkx")("23914")){var b=(h||(h=d("I64"))).of_float(Date.now());return a.filter(function(a){var c=q(a);if(c!=null&&m.has(c)){c=(h||(h=d("I64"))).compare(h.sub(b,a.initTimestampMs),l)>=0;return c}return!0})}return a})}async function u(a){var b=await t(a.tables);if(b.length===0)return;return a.runInTransaction(function(a){return t(a).then(function(b){return Promise.all(b.map(function(b){return r(a,b)}))})},"readwrite",void 0,void 0,f.id+":312")}function v(){var a=s.contents;if(a!=null){c("clearTimeout")(a);return}}function w(a){c("promiseDone")(u(a),function(){v();var b=c("setTimeout")(function(){w(a)},6e4);s.contents=b},function(){v(),(j||(j=d("ODS"))).bumpEntityKey(3185,"mw_trace","error")});return v}b=a;e=w;a={flush:b,flushExpiredDataTraces:e};g.default=a}),98);
__d("MAWOneTimeCodeGating",["gkx","justknobx"],(function(a,b,c,d,e,f,g){"use strict";function a(){return c("gkx")("1910")&&c("justknobx")._("1601")}g.isOneTimeCodeEnabled=a}),98);
__d("X25519",["$InternalEnum","Promise","WACryptoCurve25519Dependencies","WASignalKeys","WASignalOther","WASignalSignatures"],(function(a,b,c,d,e,f,g){"use strict";var h,i=b("$InternalEnum").Mirrored(["Encryption","Signing"]),j=b("$InternalEnum")({PublicKey:0,PrivateKey:1,Signature:2});function k(a,b){if(b===i.Encryption)return[];b=1;switch(a){case j.PublicKey:b=1;break;case j.PrivateKey:b=2;break;case j.Signature:b=3;break}return[255,b]}function l(a,b,c){b=k(b,c);c=b.length;if(c<=0)return a;var d=new Uint8Array(c+a.byteLength);d.set(Array.from(b));d.set(a,c);return d}function m(a,b,c){b=k(b,c).length;return a.slice(b)}function n(a,b){return{privateKey:l(a.privateKey,j.PrivateKey,b),publicKey:l(a.publicKey,j.PublicKey,b)}}function a(a){a=n(d("WASignalKeys").makeKeyPair(),a);return{pk:a.publicKey,sk:a.privateKey}}function o(a,b){if(b===i.Encryption)return 32;switch(a){case j.PublicKey:case j.PrivateKey:return 32;case j.Signature:return 64}}function p(a,b,c){var d=k(b,c),e=d.length;b=o(b,c);c=b!=null?e+b:0;if(a.length!==c)return!1;var f=a.subarray(0,e);b=new Uint8Array(d);return b.length===f.length&&b.every(function(a,b){return a===f[b]})}function q(a,b){if(p(a,j.PublicKey,b))return a;return}function r(a,b){if(p(a,j.PrivateKey,b))return a;return}function c(a,b){var c=q(a.pkBytes,b);a=r(a.skBytes,b);if(c!=null&&a!=null)return{pk:c,sk:a}}function e(a,c){a=m(a,j.PrivateKey,i.Signing);return d("WASignalSignatures").signMsg(d("WASignalKeys").makeKeyPairFrom(d("WASignalOther").ensureSize(a,32)),c).then(function(a){a=l(a,j.Signature,i.Signing);return(h||(h=b("Promise"))).resolve(a)})}function f(a){if(p(a,j.Signature,i.Signing))return a}function s(a,b,c){b=m(b,j.PublicKey,i.Signing);return d("WASignalSignatures").verifyMsgSignalVariant(d("WASignalKeys").serializeIdentity(b),c,d("WASignalOther").ensureSize(m(a,j.Signature,i.Signing),64))}function t(a,c){c=c;a=a;return!p(a,j.PublicKey,i.Encryption)||!p(c,j.PrivateKey,i.Encryption)?(h||(h=b("Promise"))).resolve():d("WACryptoCurve25519Dependencies").calculateAgreement(a,c).then(function(a){return(h||(h=b("Promise"))).resolve(new Uint8Array(a))})}g.KeyPurpose=i;g.generateKeys=a;g.publicKeyFromBytes=q;g.secretKeyFromBytes=r;g.keysFromBytes=c;g.sign=e;g.signatureFromBytes=f;g.verify=s;g.exchangeKeys=t}),98);